2025-05-12 13:09:20,109 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 13:09:20,109 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 13:09:20,109 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 13:09:20,109 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 13:09:20,109 - monthly_report - INFO - Perplexity API key found
2025-05-12 13:09:20,109 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:19:19,372 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:19:30,741 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:19:32,411 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:22:57,994 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:22:59,760 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:32:17,901 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 13:32:17,902 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 13:32:17,902 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 13:32:17,902 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 13:32:17,902 - monthly_report - INFO - Perplexity API key found
2025-05-12 13:32:17,902 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:33:15,711 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:33:23,606 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:34:43,095 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:36:25,119 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:36:28,755 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:36:30,690 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:36:51,696 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:45:40,391 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 13:54:19,053 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:00:49,040 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:00:49,041 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:00:49,041 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:00:49,042 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:00:49,042 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:00:49,042 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:03:16,865 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:03:18,689 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:03:18,700 - monthly_report - INFO - Deleting monthly newsletter with ID 120
2025-05-12 14:03:18,707 - monthly_report - INFO - Deleted original newsletter file: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05.html
2025-05-12 14:03:18,707 - monthly_report - INFO - Deleted revised newsletter file: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:03:19,788 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:03:22,653 - monthly_report - INFO - Starting monthly newsletter process for district 0
2025-05-12 14:03:22,653 - monthly_report - INFO - Step 0: Initializing monthly_reporting table
2025-05-12 14:03:22,653 - monthly_report - INFO - Initializing tables for monthly reporting
2025-05-12 14:03:22,656 - monthly_report - INFO - Checking if reports table exists...
2025-05-12 14:03:22,659 - monthly_report - INFO - Reports table already exists
2025-05-12 14:03:22,670 - monthly_report - INFO - Table monthly_reporting exists with columns: ['id', 'report_id', 'object_id', 'item_title', 'explanation', 'report_text', 'created_at', 'updated_at', 'report_date', 'metric_name', 'group_value', 'group_field_name', 'period_type', 'comparison_mean', 'recent_mean', 'difference', 'std_dev', 'percent_change', 'priority', 'district', 'chart_data', 'metadata', 'metric_id']
2025-05-12 14:03:22,670 - monthly_report - INFO - Table monthly_reporting already has all required columns
2025-05-12 14:03:22,670 - monthly_report - INFO - Step 1: Selecting deltas to discuss
2025-05-12 14:03:22,670 - monthly_report - INFO - Selecting top 20 and bottom 20 deltas for monthly report
2025-05-12 14:03:22,670 - monthly_report - INFO - Requesting top changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=0&show_both=false
2025-05-12 14:03:22,692 - monthly_report - INFO - Top changes API response status code: 200
2025-05-12 14:03:22,692 - monthly_report - INFO - Received top changes data: {"status": "success", "count": 25, "period_type": "month", "object_id": null, "district": "0", "top_results": [{"group_value": null, "recent_value": 669.0, "previous_value": 119.0, "delta": 550.0, "ab...
2025-05-12 14:03:22,692 - monthly_report - INFO - Top data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:03:22,692 - monthly_report - INFO - Top results count: 5
2025-05-12 14:03:22,692 - monthly_report - INFO - Sample top result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:03:22,692 - monthly_report - INFO - Sample top result item: {"group_value": null, "recent_value": 669.0, "previous_value": 119.0, "delta": 550.0, "abs_delta": 550.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3401, "object_id": "13", "object_name": "\ud83c\udfe0 New Housing Units Completed - Citywide", "group_field": null, "district": "0", "percent_change": 462.1848739495798}
2025-05-12 14:03:22,693 - monthly_report - INFO - Requesting bottom changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=0&show_both=false&negative=true
2025-05-12 14:03:22,710 - monthly_report - INFO - Bottom changes API response status code: 200
2025-05-12 14:03:22,711 - monthly_report - INFO - Received bottom changes data: {"status": "success", "count": 25, "period_type": "month", "object_id": null, "district": "0", "top_results": [{"group_value": null, "recent_value": 669.0, "previous_value": 119.0, "delta": 550.0, "ab...
2025-05-12 14:03:22,711 - monthly_report - INFO - Bottom data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:03:22,711 - monthly_report - INFO - Bottom results count: 20
2025-05-12 14:03:22,711 - monthly_report - INFO - Sample bottom result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:03:22,711 - monthly_report - INFO - Sample bottom result item: {"group_value": null, "recent_value": 16.0, "previous_value": 29.0, "delta": -13.0, "abs_delta": 13.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3330, "object_id": "17", "object_name": "\ud83c\udfea Retail Closures - Citywide", "group_field": null, "district": "0", "percent_change": -44.827586206896555}
2025-05-12 14:03:22,711 - monthly_report - INFO - Found 5 top changes and 20 bottom changes
2025-05-12 14:03:22,711 - monthly_report - INFO - Step 2: Prioritizing deltas
2025-05-12 14:03:22,711 - monthly_report - INFO - Prioritizing deltas for discussion (max 4 items)
2025-05-12 14:03:22,714 - monthly_report - INFO - Loaded 15871 characters of combined notes for context
2025-05-12 14:03:22,714 - monthly_report - INFO - Loading prompts from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/prompts.json
2025-05-12 14:03:22,714 - monthly_report - INFO - Successfully loaded prompts with keys: ['monthly_report']
2025-05-12 14:03:29,436 - monthly_report - INFO - Received JSON response of length: 1864
2025-05-12 14:03:29,436 - monthly_report - INFO - Parsed JSON: {"items": [{"index": 1, "metric": "\ud83c\udfe0 New Housing Units Completed - Citywide for All", "metric_id": "13", "group": "Economy", "priority": 1, "explanation": "The completion of new housing uni...
2025-05-12 14:03:29,436 - monthly_report - INFO - Found items under key: items
2025-05-12 14:03:29,436 - monthly_report - INFO - Extracted 4 items from JSON
2025-05-12 14:03:29,436 - monthly_report - INFO -   Item 1: {"index": 1, "metric": "\ud83c\udfe0 New Housing Units Completed - Citywide for All", "metric_id": "...
2025-05-12 14:03:29,436 - monthly_report - INFO -   Item 2: {"index": 8, "metric": "\ud83d\udeab Business Closures - Citywide for All", "metric_id": "15", "grou...
2025-05-12 14:03:29,436 - monthly_report - INFO -   Item 3: {"index": 16, "metric": "\ud83d\udea8 Violent Crime Incidents - Citywide for All", "metric_id": "2",...
2025-05-12 14:03:29,436 - monthly_report - INFO - Found original data for item index 1: 🏠 New Housing Units Completed - Citywide
2025-05-12 14:03:29,436 - monthly_report - INFO - Found original data for item index 8: 🚫 Business Closures - Citywide
2025-05-12 14:03:29,436 - monthly_report - INFO - Found original data for item index 16: 🚨 Violent Crime Incidents - Citywide
2025-05-12 14:03:29,436 - monthly_report - INFO - Found original data for item index 10: 🚒 Fire Incidents YTD - Citywide
2025-05-12 14:03:29,436 - monthly_report - INFO - Prioritized item: 🏠 New Housing Units Completed - Citywide - All (Priority: 1)
2025-05-12 14:03:29,436 - monthly_report - INFO -   Explanation length: 323
2025-05-12 14:03:29,436 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:03:29,437 - monthly_report - INFO - Prioritized item: 🚫 Business Closures - Citywide - All (Priority: 2)
2025-05-12 14:03:29,437 - monthly_report - INFO -   Explanation length: 254
2025-05-12 14:03:29,437 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:03:29,437 - monthly_report - INFO - Prioritized item: 🚨 Violent Crime Incidents - Citywide - All (Priority: 3)
2025-05-12 14:03:29,437 - monthly_report - INFO -   Explanation length: 260
2025-05-12 14:03:29,437 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:03:29,437 - monthly_report - INFO - Prioritized item: 🚒 Fire Incidents YTD - Citywide - All (Priority: 4)
2025-05-12 14:03:29,437 - monthly_report - INFO -   Explanation length: 253
2025-05-12 14:03:29,437 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:03:29,437 - monthly_report - INFO - Prioritized 4 items for the report
2025-05-12 14:03:29,437 - monthly_report - INFO - Step 2.5: Storing prioritized items
2025-05-12 14:03:29,437 - monthly_report - INFO - Storing 4 prioritized items in the database
2025-05-12 14:03:29,441 - monthly_report - INFO - Created report record with ID: 123
2025-05-12 14:03:29,441 - monthly_report - INFO - Storing item: 🏠 New Housing Units Completed - Citywide - Priority: 1
2025-05-12 14:03:29,441 - monthly_report - INFO -   Explanation: 'The completion of new housing units has increased ...' (length: 323)
2025-05-12 14:03:29,441 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:03:29,443 - monthly_report - INFO - Stored item with ID 252, explanation length in DB: 323
2025-05-12 14:03:29,443 - monthly_report - INFO - Storing item: 🚫 Business Closures - Citywide - Priority: 2
2025-05-12 14:03:29,443 - monthly_report - INFO -   Explanation: 'Business closures have decreased by 32.9%, which i...' (length: 254)
2025-05-12 14:03:29,443 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:03:29,443 - monthly_report - INFO - Stored item with ID 253, explanation length in DB: 254
2025-05-12 14:03:29,443 - monthly_report - INFO - Storing item: 🚨 Violent Crime Incidents - Citywide - Priority: 3
2025-05-12 14:03:29,443 - monthly_report - INFO -   Explanation: 'Violent crime incidents have decreased by 12.3%, w...' (length: 260)
2025-05-12 14:03:29,443 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:03:29,443 - monthly_report - INFO - Stored item with ID 254, explanation length in DB: 260
2025-05-12 14:03:29,443 - monthly_report - INFO - Storing item: 🚒 Fire Incidents YTD - Citywide - Priority: 4
2025-05-12 14:03:29,443 - monthly_report - INFO -   Explanation: 'Fire incidents have decreased by 24.3%, which is a...' (length: 253)
2025-05-12 14:03:29,443 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:03:29,444 - monthly_report - INFO - Stored item with ID 255, explanation length in DB: 253
2025-05-12 14:03:29,445 - monthly_report - INFO - Successfully stored 4 items in the database
2025-05-12 14:03:29,445 - monthly_report - INFO - Step 3: Generating explanations
2025-05-12 14:03:29,445 - monthly_report - INFO - Generating explanations for 4 items
2025-05-12 14:03:29,450 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:03:29,450 - monthly_report - INFO - Generating explanation for report_id=252, metric=🏠 New Housing Units Completed - Citywide (ID: 13), group=All
2025-05-12 14:03:29,451 - monthly_report - INFO -   Values: recent=669.0, comparison=119.0, diff=550.0, percent_change=462.1848739495798
2025-05-12 14:03:29,451 - monthly_report - INFO -   Period: month, District: 0
2025-05-12 14:03:29,451 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🏠 New Housing Units Completed - Citywide' (ID: 13)  increased from 119.0 to 669.0 (462.18%) between March 2025 and April 2025 for district 0.

Use the available tools to...
2025-05-12 14:03:29,451 - monthly_report - INFO - Running explainer agent for metric: 13
2025-05-12 14:03:35,919 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:03:35,919 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:03:35,920 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:03:35,920 - monthly_report - INFO - Response has messages attribute with 4 messages
2025-05-12 14:03:35,920 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:03:35,920 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The significant increase in the "🏠 New Housing Units Completed - Citywide" metric from ...
2025-05-12 14:03:35,920 - monthly_report - INFO - Final explanation to be stored for 🏠 New Housing Units Completed - Citywide (length: 960): EXPLANATION: The significant increase in the "🏠 New Housing Units Completed - Citywide" metric from 119.0 to 669.0 units between March 2025 and April 2025 is predominantly attributed to a substantial ...
2025-05-12 14:03:35,921 - monthly_report - INFO - Updated explanation for report ID 252
2025-05-12 14:03:35,922 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:03:35,922 - monthly_report - INFO - Generating explanation for report_id=253, metric=🚫 Business Closures - Citywide (ID: 15), group=All
2025-05-12 14:03:35,922 - monthly_report - INFO -   Values: recent=186.0, comparison=277.0, diff=-91.0, percent_change=-32.851985559566785
2025-05-12 14:03:35,922 - monthly_report - INFO -   Period: month, District: 0
2025-05-12 14:03:35,922 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚫 Business Closures - Citywide' (ID: 15)  decreased from 277.0 to 186.0 (32.85%) between March 2025 and April 2025 for district 0.

Use the available tools to research t...
2025-05-12 14:03:35,922 - monthly_report - INFO - Running explainer agent for metric: 15
2025-05-12 14:03:55,531 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:03:55,532 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:03:55,532 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:03:55,532 - monthly_report - INFO - Response has messages attribute with 8 messages
2025-05-12 14:03:55,532 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:03:55,532 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The decrease in the '🚫 Business Closures - Citywide' metric from 277.0 to 186.0 in Apri...
2025-05-12 14:03:55,533 - monthly_report - INFO - Final explanation to be stored for 🚫 Business Closures - Citywide (length: 1331): EXPLANATION: The decrease in the '🚫 Business Closures - Citywide' metric from 277.0 to 186.0 in April 2025 can be attributed to several factors. Notably, there is a significant anomaly in the Union St...
2025-05-12 14:03:55,534 - monthly_report - INFO - Updated explanation for report ID 253
2025-05-12 14:03:55,534 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:03:55,534 - monthly_report - INFO - Generating explanation for report_id=254, metric=🚨 Violent Crime Incidents - Citywide (ID: 2), group=All
2025-05-12 14:03:55,534 - monthly_report - INFO -   Values: recent=924.0, comparison=1054.0, diff=-130.0, percent_change=-12.333965844402277
2025-05-12 14:03:55,534 - monthly_report - INFO -   Period: month, District: 0
2025-05-12 14:03:55,534 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚨 Violent Crime Incidents - Citywide' (ID: 2)  decreased from 1054.0 to 924.0 (12.33%) between March 2025 and April 2025 for district 0.

Use the available tools to rese...
2025-05-12 14:03:55,534 - monthly_report - INFO - Running explainer agent for metric: 2
2025-05-12 14:04:05,055 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:04:05,056 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:04:05,057 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:04:05,057 - monthly_report - INFO - Response has messages attribute with 4 messages
2025-05-12 14:04:05,057 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:04:05,057 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The 12.33% decrease in '🚨 Violent Crime Incidents - Citywide' from March 2025 to April ...
2025-05-12 14:04:05,057 - monthly_report - INFO - Final explanation to be stored for 🚨 Violent Crime Incidents - Citywide (length: 2069): EXPLANATION: The 12.33% decrease in '🚨 Violent Crime Incidents - Citywide' from March 2025 to April 2025 can be primarily attributed to significant declines across several supervisor districts and inc...
2025-05-12 14:04:05,058 - monthly_report - INFO - Updated explanation for report ID 254
2025-05-12 14:04:05,058 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:04:05,059 - monthly_report - INFO - Generating explanation for report_id=255, metric=🚒 Fire Incidents YTD - Citywide (ID: 8), group=All
2025-05-12 14:04:05,059 - monthly_report - INFO -   Values: recent=2116.0, comparison=2797.0, diff=-681.0, percent_change=-24.347515194851628
2025-05-12 14:04:05,059 - monthly_report - INFO -   Period: month, District: 0
2025-05-12 14:04:05,059 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚒 Fire Incidents YTD - Citywide' (ID: 8)  decreased from 2797.0 to 2116.0 (24.35%) between March 2025 and April 2025 for district 0.

Use the available tools to research...
2025-05-12 14:04:05,059 - monthly_report - INFO - Running explainer agent for metric: 8
2025-05-12 14:04:28,097 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:04:28,097 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:04:28,098 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:04:28,098 - monthly_report - INFO - Response has messages attribute with 6 messages
2025-05-12 14:04:28,098 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:04:28,098 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The decrease in '🚒 Fire Incidents YTD - Citywide' from March 2025 to April 2025 is larg...
2025-05-12 14:04:28,098 - monthly_report - INFO - Final explanation to be stored for 🚒 Fire Incidents YTD - Citywide (length: 1076): EXPLANATION: The decrease in '🚒 Fire Incidents YTD - Citywide' from March 2025 to April 2025 is largely attributed to significant reductions in fire incidents across multiple supervisor districts. In ...
2025-05-12 14:04:28,098 - monthly_report - INFO - Updated explanation for report ID 255
2025-05-12 14:04:28,099 - monthly_report - INFO - Successfully generated explanations for 4 items
2025-05-12 14:04:28,099 - monthly_report - INFO - Step 4: Getting report items for Perplexity context enrichment
2025-05-12 14:04:28,105 - monthly_report - INFO - Step 5: Getting additional context from Perplexity API for each report item
2025-05-12 14:04:28,105 - monthly_report - INFO - Getting additional context from Perplexity API for 4 report items
2025-05-12 14:04:28,105 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🏠 New Housing Units Completed - Citywide
Group: All
Recent Value: 669.0
Previous Value: 119.0
Percent Change: +462.18%
Explanation: The completion of new housing units has increased by 462.2%, which is a significant development in the housing sector. This continues a broader trend of increased housing completions, as indicated by the year-to-date increase of 256.5%. This is crucial for addressing housing shortages and is a positive economic indicator.
Detailed Analysis: EXPLANATION: The significant increase in the "🏠 New Housing Units Completed - Citywide" metric from 119.0 to 669.0 units between March 2025 and April 2025 is predominantly attributed to a substantial surge in the issuance of Initial Temporary Certificates of Occupancy (Initial TCO). In April 2025, the number of units completed with Initial TCO rose dramatically to 612, compared to an average of approximately 85 over the preceding 24 months. This signifies a 620% increase in this document type alone, accounting for most of the city's housing unit completions during this period. Other types, like Amended TCO and Certificates of Final Completion (CFC), showed minor increases or decreases but didn't significantly impact the overall increase. Therefore, the anomaly in April 2025's housing completions is primarily due to the completion of projects that reached their occupancy certification stage through Initial TCOs at that time. [CHART:anomaly:281823]


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:04:28,105 - monthly_report - INFO - Sending request to Perplexity API for 🏠 New Housing Units Completed - Citywide
2025-05-12 14:04:34,237 - monthly_report - INFO - Successfully received response from Perplexity API for 🏠 New Housing Units Completed - Citywide
2025-05-12 14:04:34,238 - monthly_report - INFO - Raw Perplexity response: {"id": "7117c3c4-d6f9-4204-853f-c6bc34c7d077", "model": "sonar", "created": 1747083874, "usage": {"prompt_tokens": 479, "completion_tokens": 201, "total_tokens": 680, "search_context_size": "low"}, "citations": ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housing-project-in-redwood-city.html", "https://ww2.kqed.org/news/2025/05/07/historic-san-francisco-theater-might-finally-redeveloped-housing/", "https://www.multihousingnews.com/affordable-housing-breaks-ground-in-san-francisco/", "https://www.axios.com/local/san-francisco/2025/04/08/sf-major-zoning-overhaul-housing-shortage-solution", "https://www.spur.org/news/2025-04-28/mayor-luries-family-zoning-plan-leap-forward-san-francisco-housing-policy"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nRecent developments in San Francisco's housing sector include a significant increase in new housing units complet...
2025-05-12 14:04:34,238 - monthly_report - INFO - Found top-level citations: ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housing-project-in-redwood-city.html", "https://ww2.kqed.org/news/2025/05/07/historic-san-francisco-theater-might-finally-redeveloped-housing/", "https://www.multihousingnews.com/affordable-housing-breaks-ground-in-san-francisco/", "https://www.axios.com/local/san-francisco/2025/04/08/sf-major-zoning-overhaul-housing-shortage-solution", "https://www.spur.org/news/2025-04-28/mayor-luries-family-zoning-plan-leap-forward-san-francisco-housing-policy"]
2025-05-12 14:04:34,238 - monthly_report - INFO - Added Perplexity response data to 🏠 New Housing Units Completed - Citywide: {"citations": ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housing-project-in-redwood-city.html", "https://ww2.kqed.org/news/2025/05/07/historic-san-francisco-theater-might-finally-redeveloped-housing/", "https://www.multihousingnews.com/affordable-housing-breaks-ground-in-san-francisco/", "https://www.axios.com/local/san-francisco/2025/04/08/sf-major-zoning-overhaul-housing-shortage-solution", "https://www.spur.org/news/2025-04-28/mayor-luries-family-zoning-plan-leap-forward-san-francisco-housing-policy"]}
2025-05-12 14:04:34,238 - monthly_report - INFO - Added Perplexity context to 🏠 New Housing Units Completed - Citywide (length: 1016)
2025-05-12 14:04:34,238 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚫 Business Closures - Citywide
Group: All
Recent Value: 186.0
Previous Value: 277.0
Percent Change: -32.85%
Explanation: Business closures have decreased by 32.9%, which is a significant positive change for the local economy. This continues the broader trend of reduced business closures, with a year-to-date decrease of 56.1%. This indicates economic recovery and stability.
Detailed Analysis: EXPLANATION: The decrease in the '🚫 Business Closures - Citywide' metric from 277.0 to 186.0 in April 2025 can be attributed to several factors. Notably, there is a significant anomaly in the Union Street business corridor that experienced an abnormally high number of closures compared to the average, as highlighted by recent anomaly detection data. Specifically, the Union Street corridor had a comparison mean of approximately 3.83 closures but experienced 11 closures, which is around 186.96% higher than expected [CHART:anomaly:282743]. This localized spike in closures might have contributed heavily to the citywide decrease as businesses in this specific area are managed differently which may reflect in closure timings and procedures.

Furthermore, a review of the recent city data shows an administrative change in the status of businesses leading to delayed closure reflections in quite a few instances. For example, businesses such as 'Azalina's', 'Park Soi Cafe', and 'Brawlers Brand' listed for closure had administrative actions in the previous months, leading to a statistical update happening later than usual.

In summary, the decline in closures can be partly explained by a spike in specific corridors during March, which then normalized, alongside administrative delays in closure records reflecting in April.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:04:34,238 - monthly_report - INFO - Sending request to Perplexity API for 🚫 Business Closures - Citywide
2025-05-12 14:04:37,861 - monthly_report - INFO - Successfully received response from Perplexity API for 🚫 Business Closures - Citywide
2025-05-12 14:04:37,861 - monthly_report - INFO - Raw Perplexity response: {"id": "dc171e44-32ea-45f8-85e6-71680ae6b3c7", "model": "sonar", "created": 1747083877, "usage": {"prompt_tokens": 520, "completion_tokens": 178, "total_tokens": 698, "search_context_size": "low"}, "citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_January_2025c_nUToFAQ.pdf", "https://www.reformcalifornia.org/news/heres-a-list-of-companies-fleeing-san-francisco-and-why"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\nRecently, San Francisco's economy has shown some recovery signs in the business sector. Business closures have decreased significantly, which suggests economic stability, although spe...
2025-05-12 14:04:37,862 - monthly_report - INFO - Found top-level citations: ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_January_2025c_nUToFAQ.pdf", "https://www.reformcalifornia.org/news/heres-a-list-of-companies-fleeing-san-francisco-and-why"]
2025-05-12 14:04:37,863 - monthly_report - INFO - Added Perplexity response data to 🚫 Business Closures - Citywide: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_January_2025c_nUToFAQ.pdf", "https://www.reformcalifornia.org/news/heres-a-list-of-companies-fleeing-san-francisco-and-why"]}
2025-05-12 14:04:37,863 - monthly_report - INFO - Added Perplexity context to 🚫 Business Closures - Citywide (length: 989)
2025-05-12 14:04:37,863 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚨 Violent Crime Incidents - Citywide
Group: All
Recent Value: 924.0
Previous Value: 1054.0
Percent Change: -12.33%
Explanation: Violent crime incidents have decreased by 12.3%, which is a significant improvement in public safety. This is part of a broader trend of decreasing violent crime, with a year-to-date decrease of 9.2%. This is crucial for community safety and public confidence.
Detailed Analysis: EXPLANATION: The 12.33% decrease in '🚨 Violent Crime Incidents - Citywide' from March 2025 to April 2025 can be primarily attributed to significant declines across several supervisor districts and incident categories. Notably, Supervisor Districts 5, 3, 6, and 11 experienced marked reductions in violent crime incidents, contributing substantially to the overall citywide decrease.

1. **Significant District-Level Anomalies:**
   - **District 5**: Violent crime incidents decreased by 28.06%, from a comparison mean of 211.3 to a recent mean of 152.0. This district alone accounted for a substantial part of the citywide decrease in April 2025. [CHART:anomaly:267978]
   - **District 3**: Violent crime incidents fell sharply by 37.81%, from 152.75 to 95.0. The dramatic drop in this district significantly influenced the citywide figures. [CHART:anomaly:267979]
   - **District 6**: Experienced a decrease of 22.02%, impacting the overall reduction in the violent crime rate. [CHART:anomaly:267980]
   - **District 11**: This district observed a decrease of 37.0%, from 65.1 to 41.0, adding to the decline. [CHART:anomaly:267982]

2. **Incident Category Anomalies:**
   - Major categories of violent crime showed declines:
     - **Robbery** incidents decreased by 40.6%, from a previous mean of 222.2 to a new mean of 132.0. It was one of the largest contributors to the reduction. [CHART:anomaly:267984]
     - **Weapons Offense** saw a decline of 39.4%, further contributing to the reduction citywide. [CHART:anomaly:267980]
     - **Assault** incidents declined by 20.9%, from a mean of 689.9 to 546.0, which substantially influenced the total citywide numbers. [CHART:anomaly:267982]

Overall, the combination of reductions across several districts and within key incident categories led to the 12.33% decrease observed in 'Violent Crime Incidents - Citywide' from March to April 2025. These districts and incident categories acted as the primary drivers for the change, showing clear localized trends that contributed to improving the city's safety statistics.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:04:37,863 - monthly_report - INFO - Sending request to Perplexity API for 🚨 Violent Crime Incidents - Citywide
2025-05-12 14:04:44,788 - monthly_report - INFO - Successfully received response from Perplexity API for 🚨 Violent Crime Incidents - Citywide
2025-05-12 14:04:44,788 - monthly_report - INFO - Raw Perplexity response: {"id": "7a592f93-374a-4068-ac7a-1070130adddf", "model": "sonar", "created": 1747083884, "usage": {"prompt_tokens": 788, "completion_tokens": 164, "total_tokens": 952, "search_context_size": "low"}, "citations": ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-crime-decline-comparison-data-20257604.php", "https://www.californiacountynews.org/news/2025/04/crime-plummeting-san-francisco-policy-changes-have-played-role-some-experts-say", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nSan Francisco has seen a significant decline in crime rates. Violent crime fell by 14% between January 2024 and January 2025, while property crime decreased by nearly 29% during the same period[1][2]. Recent data ...
2025-05-12 14:04:44,788 - monthly_report - INFO - Found top-level citations: ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-crime-decline-comparison-data-20257604.php", "https://www.californiacountynews.org/news/2025/04/crime-plummeting-san-francisco-policy-changes-have-played-role-some-experts-say", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"]
2025-05-12 14:04:44,788 - monthly_report - INFO - Added Perplexity response data to 🚨 Violent Crime Incidents - Citywide: {"citations": ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-crime-decline-comparison-data-20257604.php", "https://www.californiacountynews.org/news/2025/04/crime-plummeting-san-francisco-policy-changes-have-played-role-some-experts-say", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"]}
2025-05-12 14:04:44,788 - monthly_report - INFO - Added Perplexity context to 🚨 Violent Crime Incidents - Citywide (length: 825)
2025-05-12 14:04:44,788 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚒 Fire Incidents YTD - Citywide
Group: All
Recent Value: 2116.0
Previous Value: 2797.0
Percent Change: -24.35%
Explanation: Fire incidents have decreased by 24.3%, which is a significant improvement in public safety. This continues a broader trend of reduced fire incidents, with a year-to-date decrease of 11.9%. This is important for community safety and resource allocation.
Detailed Analysis: EXPLANATION: The decrease in '🚒 Fire Incidents YTD - Citywide' from March 2025 to April 2025 is largely attributed to significant reductions in fire incidents across multiple supervisor districts. In particular, District 6 experienced a 25.63% reduction, accounting for a large portion of the citywide decrease. District 3 also saw a substantial drop of 28.6%, as did District 10 with a decrease of 29.63%, and District 4 with a notable reduction of 42.38%. These declines across key districts combined to create an overall citywide decrease of 24.35%. Each of these districts showed anomalies in fire incidents significantly below the expected averages, contributing to the overall downward trend. Time-specific factors or safety improvements specific to these areas may have influenced these reductions. Notably, these changes were detected as anomalies because they deviated significantly from historical norms for these districts. You can view anomaly charts for more details: [CHART:anomaly:281079], [CHART:anomaly:281080], [CHART:anomaly:281083], [CHART:anomaly:281084].


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:04:44,788 - monthly_report - INFO - Sending request to Perplexity API for 🚒 Fire Incidents YTD - Citywide
2025-05-12 14:04:47,870 - monthly_report - INFO - Successfully received response from Perplexity API for 🚒 Fire Incidents YTD - Citywide
2025-05-12 14:04:47,871 - monthly_report - INFO - Raw Perplexity response: {"id": "5ba1c73f-5fda-45dd-8397-519be57a7af2", "model": "sonar", "created": 1747083887, "usage": {"prompt_tokens": 502, "completion_tokens": 165, "total_tokens": 667, "search_context_size": "low"}, "citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca.gov/incidents/2025", "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric/data", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://en.wikipedia.org/wiki/2025_California_wildfires"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nRecent data shows a significant decrease in fire incidents across San Francisco, with a 24.3% reduction year-to-date as of April 2025[1][3]. This trend reflects broader improvements in public safety and resource allocation. The decrease is attributed to reductions across multiple districts, including Districts 3, 4, 6, and 10, which experien...
2025-05-12 14:04:47,871 - monthly_report - INFO - Found top-level citations: ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca.gov/incidents/2025", "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric/data", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://en.wikipedia.org/wiki/2025_California_wildfires"]
2025-05-12 14:04:47,871 - monthly_report - INFO - Added Perplexity response data to 🚒 Fire Incidents YTD - Citywide: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca.gov/incidents/2025", "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric/data", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://en.wikipedia.org/wiki/2025_California_wildfires"]}
2025-05-12 14:04:47,871 - monthly_report - INFO - Added Perplexity context to 🚒 Fire Incidents YTD - Citywide (length: 868)
2025-05-12 14:04:47,871 - monthly_report - INFO - Successfully retrieved additional context from Perplexity API for all items
2025-05-12 14:04:47,871 - monthly_report - INFO - Step 5.5: Updating database with Perplexity context
2025-05-12 14:04:47,876 - monthly_report - INFO - Updating perplexity_context for 🏠 New Housing Units Completed - Citywide - All (length: 1016)
2025-05-12 14:04:47,878 - monthly_report - INFO - Updated 1 records for perplexity_context (🏠 New Housing Units Completed - Citywide - All)
2025-05-12 14:04:47,878 - monthly_report - INFO - Updating perplexity_response for 🏠 New Housing Units Completed - Citywide - All: {"citations": ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housin...
2025-05-12 14:04:47,878 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housin...
2025-05-12 14:04:47,880 - monthly_report - INFO - Updated 1 records for perplexity_response (🏠 New Housing Units Completed - Citywide - All)
2025-05-12 14:04:47,880 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🏠 New Housing Units Completed - Citywide: {"citations": ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housin...
2025-05-12 14:04:47,880 - monthly_report - INFO - Updating perplexity_context for 🚫 Business Closures - Citywide - All (length: 989)
2025-05-12 14:04:47,881 - monthly_report - INFO - Updated 1 records for perplexity_context (🚫 Business Closures - Citywide - All)
2025-05-12 14:04:47,881 - monthly_report - INFO - Updating perplexity_response for 🚫 Business Closures - Citywide - All: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:04:47,881 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:04:47,881 - monthly_report - INFO - Updated 1 records for perplexity_response (🚫 Business Closures - Citywide - All)
2025-05-12 14:04:47,881 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚫 Business Closures - Citywide: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:04:47,882 - monthly_report - INFO - Updating perplexity_context for 🚨 Violent Crime Incidents - Citywide - All (length: 825)
2025-05-12 14:04:47,882 - monthly_report - INFO - Updated 1 records for perplexity_context (🚨 Violent Crime Incidents - Citywide - All)
2025-05-12 14:04:47,882 - monthly_report - INFO - Updating perplexity_response for 🚨 Violent Crime Incidents - Citywide - All: {"citations": ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/cri...
2025-05-12 14:04:47,882 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/cri...
2025-05-12 14:04:47,882 - monthly_report - INFO - Updated 1 records for perplexity_response (🚨 Violent Crime Incidents - Citywide - All)
2025-05-12 14:04:47,882 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚨 Violent Crime Incidents - Citywide: {"citations": ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/cri...
2025-05-12 14:04:47,882 - monthly_report - INFO - Updating perplexity_context for 🚒 Fire Incidents YTD - Citywide - All (length: 868)
2025-05-12 14:04:47,883 - monthly_report - INFO - Updated 1 records for perplexity_context (🚒 Fire Incidents YTD - Citywide - All)
2025-05-12 14:04:47,883 - monthly_report - INFO - Updating perplexity_response for 🚒 Fire Incidents YTD - Citywide - All: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca...
2025-05-12 14:04:47,883 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca...
2025-05-12 14:04:47,883 - monthly_report - INFO - Updated 1 records for perplexity_response (🚒 Fire Incidents YTD - Citywide - All)
2025-05-12 14:04:47,883 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚒 Fire Incidents YTD - Citywide: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca...
2025-05-12 14:04:47,884 - monthly_report - INFO - Verification counts: 4 records with perplexity_context, 4 with perplexity_response
2025-05-12 14:04:47,885 - monthly_report - INFO - Updated 4 items with Perplexity context
2025-05-12 14:04:47,885 - monthly_report - INFO - Step 6: Generating monthly newsletter
2025-05-12 14:04:47,885 - monthly_report - INFO - Generating monthly report for district 0
2025-05-12 14:04:47,893 - monthly_report - INFO - Found 4 report items for date 2025-05-12 and district 0
2025-05-12 14:04:47,893 - monthly_report - INFO - Raw perplexity_citations for 🏠 New Housing Units Completed - Citywide: ["https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housing-project-in-redwood-city.html", "https://ww2.kqed.org/news/2025/05/07/historic-san-francisco-theater-might-finally-redeveloped-housing/", "https://www.multihousingnews.com/affordable-housing-breaks-ground-in-san-f...
2025-05-12 14:04:47,893 - monthly_report - INFO - Formatted 5 citations for 🏠 New Housing Units Completed - Citywide
2025-05-12 14:04:47,893 - monthly_report - INFO - Citation map: {"1": "https://sfyimby.com/2025/05/notice-of-exemption-filed-for-100-unit-affordable-housing-project-in-redwood-city.html", "2": "https://ww2.kqed.org/news/2025/05/07/historic-san-francisco-theater-might-finally-redeveloped-housing/", "3": "https://www.multihousingnews.com/affordable-housing-breaks-ground-in-san-francisco/", "4": "https://www.axios.com/local/san-francisco/2025/04/08/sf-major-zoning-overhaul-housing-shortage-solution", "5": "https://www.spur.org/news/2025-04-28/mayor-luries-family-zoning-plan-leap-forward-san-francisco-housing-policy"}
2025-05-12 14:04:47,893 - monthly_report - INFO - Found citation references in context: ['3', '4', '5']
2025-05-12 14:04:47,893 - monthly_report - INFO - Raw perplexity_citations for 🚫 Business Closures - Citywide: ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/docume...
2025-05-12 14:04:47,893 - monthly_report - INFO - Formatted 5 citations for 🚫 Business Closures - Citywide
2025-05-12 14:04:47,893 - monthly_report - INFO - Citation map: {"1": "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "2": "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "3": "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "4": "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_January_2025c_nUToFAQ.pdf", "5": "https://www.reformcalifornia.org/news/heres-a-list-of-companies-fleeing-san-francisco-and-why"}
2025-05-12 14:04:47,894 - monthly_report - INFO - Found citation references in context: ['4', '5']
2025-05-12 14:04:47,894 - monthly_report - INFO - Raw perplexity_citations for 🚨 Violent Crime Incidents - Citywide: ["https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-crime-decline-comparison-data-20257604.php", "https://www.californiacountynews.org/news/2025/04/crime-plummeting-san-francisco-policy-changes-have-played-role-some-experts-say", "https://www.sanfranci...
2025-05-12 14:04:47,894 - monthly_report - INFO - Formatted 5 citations for 🚨 Violent Crime Incidents - Citywide
2025-05-12 14:04:47,894 - monthly_report - INFO - Citation map: {"1": "https://growsf.org/news/2025-04-10-crime-is-down/", "2": "https://www.sfchronicle.com/crime/article/sf-crime-decline-comparison-data-20257604.php", "3": "https://www.californiacountynews.org/news/2025/04/crime-plummeting-san-francisco-policy-changes-have-played-role-some-experts-say", "4": "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "5": "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"}
2025-05-12 14:04:47,894 - monthly_report - INFO - Found citation references in context: ['1', '2', '5']
2025-05-12 14:04:47,894 - monthly_report - INFO - Raw perplexity_citations for 🚒 Fire Incidents YTD - Citywide: ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "https://www.fire.ca.gov/incidents/2025", "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric/data", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://en.wikipedia.org/wiki/2025_California_wildfires...
2025-05-12 14:04:47,894 - monthly_report - INFO - Formatted 5 citations for 🚒 Fire Incidents YTD - Citywide
2025-05-12 14:04:47,894 - monthly_report - INFO - Citation map: {"1": "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "2": "https://www.fire.ca.gov/incidents/2025", "3": "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric/data", "4": "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "5": "https://en.wikipedia.org/wiki/2025_California_wildfires"}
2025-05-12 14:04:47,894 - monthly_report - INFO - Found citation references in context: ['1', '3']
2025-05-12 14:04:47,894 - monthly_report - INFO - Making API call to generate report content
2025-05-12 14:05:07,006 - monthly_report - INFO - Received report content (length: 4596)
2025-05-12 14:05:07,007 - monthly_report - INFO - Monthly newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05.html
2025-05-12 14:05:07,007 - monthly_report - INFO - Step 7: Expanding chart references in the newsletter
2025-05-12 14:05:07,007 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05.html
2025-05-12 14:05:07,008 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05.html
2025-05-12 14:05:07,008 - monthly_report - INFO - Step 8: Proofreading and revising newsletter
2025-05-12 14:05:07,008 - monthly_report - INFO - Proofreading and revising newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05.html
2025-05-12 14:05:07,008 - monthly_report - INFO - Using AGENT_MODEL for proofreading
2025-05-12 14:05:49,614 - monthly_report - INFO - Expanding chart references in revised report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,614 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,615 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,627 - monthly_report - INFO - Updated report ID 123 with revised filename, proofread feedback, and headlines.
2025-05-12 14:05:49,627 - monthly_report - INFO - Revised newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,628 - monthly_report - INFO - Step 9: Generating email-compatible version of newsletter
2025-05-12 14:05:49,628 - monthly_report - INFO - Generating email-compatible version of report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,628 - monthly_report - INFO - Expanding chart references in report for email compatibility: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,628 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,629 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised.html
2025-05-12 14:05:49,631 - monthly_report - INFO - Found 15 potential iframe URLs to process.
2025-05-12 14:05:49,631 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=267982#chart-section'
2025-05-12 14:05:49,631 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=267982#chart-section'
2025-05-12 14:05:49,631 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=267982#chart-section'
2025-05-12 14:05:49,631 - monthly_report - INFO - Requesting anomaly image for id=267982
2025-05-12 14:05:49,631 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '267982'}
2025-05-12 14:05:49,656 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=267982#chart-section
2025-05-12 14:05:53,702 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:05:53,702 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:05:53,727 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:05:53,727 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:05:54,152 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_267982_1747083949.png
2025-05-12 14:05:54,152 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=267982#chart-section) with image: anomaly_267982_1747083949.png (1 occurrence(s))
2025-05-12 14:05:54,152 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281080#chart-section'
2025-05-12 14:05:54,152 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281080#chart-section'
2025-05-12 14:05:54,153 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281080#chart-section'
2025-05-12 14:05:54,153 - monthly_report - INFO - Requesting anomaly image for id=281080
2025-05-12 14:05:54,153 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281080'}
2025-05-12 14:05:54,153 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281080#chart-section
2025-05-12 14:05:56,683 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:05:56,683 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:05:56,715 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:05:56,715 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:05:56,734 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281080_1747083954.png
2025-05-12 14:05:56,734 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=281080#chart-section) with image: anomaly_281080_1747083954.png (1 occurrence(s))
2025-05-12 14:05:56,734 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=13&district=0&period_type=month#chart-section'
2025-05-12 14:05:56,734 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=13&district=0&period_type=month#chart-section'
2025-05-12 14:05:56,734 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=13&district=0&period_type=month#chart-section'
2025-05-12 14:05:56,734 - monthly_report - INFO - Requesting time-series image for metric=13, district=0, period=month
2025-05-12 14:05:56,734 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '13', 'district': '0', 'period_type': 'month'}
2025-05-12 14:05:56,734 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=13&district=0&period_type=month#chart-section
2025-05-12 14:05:59,187 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:05:59,187 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:05:59,209 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:05:59,209 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:05:59,226 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_13_0_month_1747083956.png
2025-05-12 14:05:59,229 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=13&district=0&period_type=month#chart-section
2025-05-12 14:05:59,229 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=2&district=0&period_type=month#chart-section'
2025-05-12 14:05:59,229 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=2&district=0&period_type=month#chart-section'
2025-05-12 14:05:59,229 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=2&district=0&period_type=month#chart-section'
2025-05-12 14:05:59,229 - monthly_report - INFO - Requesting time-series image for metric=2, district=0, period=month
2025-05-12 14:05:59,229 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '2', 'district': '0', 'period_type': 'month'}
2025-05-12 14:05:59,229 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=2&district=0&period_type=month#chart-section
2025-05-12 14:06:01,822 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:06:01,822 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:06:01,848 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:01,848 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:06:01,867 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_2_0_month_1747083959.png
2025-05-12 14:06:01,870 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=2&district=0&period_type=month#chart-section
2025-05-12 14:06:01,870 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281823#chart-section'
2025-05-12 14:06:01,870 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281823#chart-section'
2025-05-12 14:06:01,870 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281823#chart-section'
2025-05-12 14:06:01,870 - monthly_report - INFO - Requesting anomaly image for id=281823
2025-05-12 14:06:01,870 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281823'}
2025-05-12 14:06:01,870 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281823#chart-section
2025-05-12 14:06:04,462 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:04,462 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:04,496 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:04,496 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:04,513 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281823_1747083961.png
2025-05-12 14:06:04,514 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=281823#chart-section
2025-05-12 14:06:04,514 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=267984#chart-section'
2025-05-12 14:06:04,514 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=267984#chart-section'
2025-05-12 14:06:04,514 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=267984#chart-section'
2025-05-12 14:06:04,514 - monthly_report - INFO - Requesting anomaly image for id=267984
2025-05-12 14:06:04,514 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '267984'}
2025-05-12 14:06:04,514 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=267984#chart-section
2025-05-12 14:06:07,011 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:07,011 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:07,038 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:07,039 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:07,058 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_267984_1747083964.png
2025-05-12 14:06:07,059 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=267984#chart-section
2025-05-12 14:06:07,059 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281083#chart-section'
2025-05-12 14:06:07,059 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281083#chart-section'
2025-05-12 14:06:07,059 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281083#chart-section'
2025-05-12 14:06:07,059 - monthly_report - INFO - Requesting anomaly image for id=281083
2025-05-12 14:06:07,059 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281083'}
2025-05-12 14:06:07,059 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281083#chart-section
2025-05-12 14:06:09,553 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:09,553 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:09,585 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:09,585 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:09,603 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281083_1747083967.png
2025-05-12 14:06:09,603 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=281083#chart-section) with image: anomaly_281083_1747083967.png (1 occurrence(s))
2025-05-12 14:06:09,603 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=267978#chart-section'
2025-05-12 14:06:09,603 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=267978#chart-section'
2025-05-12 14:06:09,603 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=267978#chart-section'
2025-05-12 14:06:09,603 - monthly_report - INFO - Requesting anomaly image for id=267978
2025-05-12 14:06:09,603 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '267978'}
2025-05-12 14:06:09,603 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=267978#chart-section
2025-05-12 14:06:12,026 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:12,026 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:12,064 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:12,064 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:12,081 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_267978_1747083969.png
2025-05-12 14:06:12,081 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=267978#chart-section
2025-05-12 14:06:12,081 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=267980#chart-section'
2025-05-12 14:06:12,081 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=267980#chart-section'
2025-05-12 14:06:12,081 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=267980#chart-section'
2025-05-12 14:06:12,081 - monthly_report - INFO - Requesting anomaly image for id=267980
2025-05-12 14:06:12,081 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '267980'}
2025-05-12 14:06:12,081 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=267980#chart-section
2025-05-12 14:06:14,547 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:14,547 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:14,577 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:14,577 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:14,593 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_267980_1747083972.png
2025-05-12 14:06:14,593 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=267980#chart-section
2025-05-12 14:06:14,593 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281084#chart-section'
2025-05-12 14:06:14,593 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281084#chart-section'
2025-05-12 14:06:14,593 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281084#chart-section'
2025-05-12 14:06:14,593 - monthly_report - INFO - Requesting anomaly image for id=281084
2025-05-12 14:06:14,594 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281084'}
2025-05-12 14:06:14,594 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281084#chart-section
2025-05-12 14:06:17,037 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:17,037 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:17,065 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:17,065 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:17,083 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281084_1747083974.png
2025-05-12 14:06:17,083 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=281084#chart-section) with image: anomaly_281084_1747083974.png (1 occurrence(s))
2025-05-12 14:06:17,083 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=15&district=0&period_type=month#chart-section'
2025-05-12 14:06:17,083 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=15&district=0&period_type=month#chart-section'
2025-05-12 14:06:17,083 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=15&district=0&period_type=month#chart-section'
2025-05-12 14:06:17,083 - monthly_report - INFO - Requesting time-series image for metric=15, district=0, period=month
2025-05-12 14:06:17,084 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '15', 'district': '0', 'period_type': 'month'}
2025-05-12 14:06:17,084 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=15&district=0&period_type=month#chart-section
2025-05-12 14:06:19,607 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:06:19,608 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:06:19,630 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:19,630 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:06:19,645 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_15_0_month_1747083977.png
2025-05-12 14:06:19,647 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=15&district=0&period_type=month#chart-section
2025-05-12 14:06:19,647 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=8&district=0&period_type=month#chart-section'
2025-05-12 14:06:19,647 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=8&district=0&period_type=month#chart-section'
2025-05-12 14:06:19,647 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=8&district=0&period_type=month#chart-section'
2025-05-12 14:06:19,647 - monthly_report - INFO - Requesting time-series image for metric=8, district=0, period=month
2025-05-12 14:06:19,647 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '8', 'district': '0', 'period_type': 'month'}
2025-05-12 14:06:19,647 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=8&district=0&period_type=month#chart-section
2025-05-12 14:06:22,168 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:06:22,168 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:06:22,201 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:22,201 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:06:22,219 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_8_0_month_1747083979.png
2025-05-12 14:06:22,221 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=8&district=0&period_type=month#chart-section
2025-05-12 14:06:22,221 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=267979#chart-section'
2025-05-12 14:06:22,221 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=267979#chart-section'
2025-05-12 14:06:22,221 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=267979#chart-section'
2025-05-12 14:06:22,221 - monthly_report - INFO - Requesting anomaly image for id=267979
2025-05-12 14:06:22,221 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '267979'}
2025-05-12 14:06:22,221 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=267979#chart-section
2025-05-12 14:06:24,876 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:24,877 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:24,909 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:24,909 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:24,926 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_267979_1747083982.png
2025-05-12 14:06:24,926 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=267979#chart-section
2025-05-12 14:06:24,926 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=282743#chart-section'
2025-05-12 14:06:24,926 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=282743#chart-section'
2025-05-12 14:06:24,926 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=282743#chart-section'
2025-05-12 14:06:24,926 - monthly_report - INFO - Requesting anomaly image for id=282743
2025-05-12 14:06:24,926 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '282743'}
2025-05-12 14:06:24,926 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=282743#chart-section
2025-05-12 14:06:27,321 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:27,321 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:27,354 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:27,354 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:27,371 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_282743_1747083984.png
2025-05-12 14:06:27,372 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=282743#chart-section
2025-05-12 14:06:27,372 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281079#chart-section'
2025-05-12 14:06:27,372 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281079#chart-section'
2025-05-12 14:06:27,372 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281079#chart-section'
2025-05-12 14:06:27,372 - monthly_report - INFO - Requesting anomaly image for id=281079
2025-05-12 14:06:27,372 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281079'}
2025-05-12 14:06:27,373 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281079#chart-section
2025-05-12 14:06:29,885 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:06:29,885 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:06:29,916 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:06:29,916 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:06:29,933 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281079_1747083987.png
2025-05-12 14:06:29,933 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=281079#chart-section
2025-05-12 14:06:29,933 - monthly_report - INFO - Total iframe replacements made: 4
2025-05-12 14:06:29,934 - monthly_report - INFO - Generated email-compatible report at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised_email.html
2025-05-12 14:06:29,934 - monthly_report - INFO - Generated email-compatible newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_0_2025_05_revised_email.html
2025-05-12 14:06:29,935 - monthly_report - INFO - Updated top_level.json for district 0 with revised report filename
2025-05-12 14:06:29,935 - monthly_report - INFO - Monthly newsletter process completed successfully
2025-05-12 14:06:29,940 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:06:45,486 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:07:55,776 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:07:57,237 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:08:01,646 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:08:03,368 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:10:41,987 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:10:41,989 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:10:41,989 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:10:41,989 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:10:41,989 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:10:41,989 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:10:49,297 - monthly_report - INFO - Starting monthly newsletter process for district 3
2025-05-12 14:10:49,297 - monthly_report - INFO - Step 0: Initializing monthly_reporting table
2025-05-12 14:10:49,297 - monthly_report - INFO - Initializing tables for monthly reporting
2025-05-12 14:10:49,302 - monthly_report - INFO - Checking if reports table exists...
2025-05-12 14:10:49,305 - monthly_report - INFO - Reports table already exists
2025-05-12 14:10:49,314 - monthly_report - INFO - Table monthly_reporting exists with columns: ['id', 'report_id', 'object_id', 'item_title', 'explanation', 'report_text', 'created_at', 'updated_at', 'report_date', 'metric_name', 'group_value', 'group_field_name', 'period_type', 'comparison_mean', 'recent_mean', 'difference', 'std_dev', 'percent_change', 'priority', 'district', 'chart_data', 'metadata', 'metric_id']
2025-05-12 14:10:49,314 - monthly_report - INFO - Table monthly_reporting already has all required columns
2025-05-12 14:10:49,314 - monthly_report - INFO - Step 1: Selecting deltas to discuss
2025-05-12 14:10:49,314 - monthly_report - INFO - Selecting top 20 and bottom 20 deltas for monthly report
2025-05-12 14:10:49,315 - monthly_report - INFO - Requesting top changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=3&show_both=false
2025-05-12 14:10:49,345 - monthly_report - INFO - Top changes API response status code: 200
2025-05-12 14:10:49,345 - monthly_report - INFO - Received top changes data: {"status": "success", "count": 24, "period_type": "month", "object_id": null, "district": "3", "top_results": [{"group_value": null, "recent_value": 9.0, "previous_value": 5.0, "delta": 4.0, "abs_delt...
2025-05-12 14:10:49,345 - monthly_report - INFO - Top data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:10:49,345 - monthly_report - INFO - Top results count: 4
2025-05-12 14:10:49,345 - monthly_report - INFO - Sample top result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:10:49,345 - monthly_report - INFO - Sample top result item: {"group_value": null, "recent_value": 9.0, "previous_value": 5.0, "delta": 4.0, "abs_delta": 4.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3316, "object_id": "16", "object_name": "\ud83d\udecd\ufe0f New Retail Registrations - District 3", "group_field": null, "district": "3", "percent_change": 80.0}
2025-05-12 14:10:49,346 - monthly_report - INFO - Requesting bottom changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=3&show_both=false&negative=true
2025-05-12 14:10:49,366 - monthly_report - INFO - Bottom changes API response status code: 200
2025-05-12 14:10:49,366 - monthly_report - INFO - Received bottom changes data: {"status": "success", "count": 24, "period_type": "month", "object_id": null, "district": "3", "top_results": [{"group_value": null, "recent_value": 9.0, "previous_value": 5.0, "delta": 4.0, "abs_delt...
2025-05-12 14:10:49,366 - monthly_report - INFO - Bottom data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:10:49,367 - monthly_report - INFO - Bottom results count: 20
2025-05-12 14:10:49,367 - monthly_report - INFO - Sample bottom result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:10:49,367 - monthly_report - INFO - Sample bottom result item: {"group_value": null, "recent_value": 14.0, "previous_value": 24.0, "delta": -10.0, "abs_delta": 10.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3063, "object_id": "4", "object_name": "\ud83d\udc8a Drug Crime Incidents - District 3", "group_field": null, "district": "3", "percent_change": -41.66666666666667}
2025-05-12 14:10:49,367 - monthly_report - INFO - Found 4 top changes and 20 bottom changes
2025-05-12 14:10:49,367 - monthly_report - INFO - Step 2: Prioritizing deltas
2025-05-12 14:10:49,367 - monthly_report - INFO - Prioritizing deltas for discussion (max 3 items)
2025-05-12 14:10:49,370 - monthly_report - INFO - Loaded 15871 characters of combined notes for context
2025-05-12 14:10:49,370 - monthly_report - INFO - Loading prompts from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/prompts.json
2025-05-12 14:10:49,370 - monthly_report - INFO - Successfully loaded prompts with keys: ['monthly_report']
2025-05-12 14:10:54,864 - monthly_report - INFO - Received JSON response of length: 1283
2025-05-12 14:10:54,864 - monthly_report - INFO - Parsed JSON: {"items": [{"index": 5, "metric": "\ud83d\udc8a Drug Crime Incidents - District 3 for All", "metric_id": "4", "group": "District 3", "priority": 1, "explanation": "Drug crime incidents in District 3 h...
2025-05-12 14:10:54,864 - monthly_report - INFO - Found items under key: items
2025-05-12 14:10:54,864 - monthly_report - INFO - Extracted 3 items from JSON
2025-05-12 14:10:54,864 - monthly_report - INFO -   Item 1: {"index": 5, "metric": "\ud83d\udc8a Drug Crime Incidents - District 3 for All", "metric_id": "4", "...
2025-05-12 14:10:54,864 - monthly_report - INFO -   Item 2: {"index": 10, "metric": "\ud83d\udea8 Violent Crime Incidents - District 3 for All", "metric_id": "2...
2025-05-12 14:10:54,864 - monthly_report - INFO -   Item 3: {"index": 8, "metric": "\ud83d\udeab Business Closures for All", "metric_id": "15", "group": "Distri...
2025-05-12 14:10:54,864 - monthly_report - INFO - Found original data for item index 5: 💊 Drug Crime Incidents - District 3
2025-05-12 14:10:54,864 - monthly_report - INFO - Found original data for item index 10: 🚨 Violent Crime Incidents - District 3
2025-05-12 14:10:54,864 - monthly_report - INFO - Found original data for item index 8: 🚫 Business Closures
2025-05-12 14:10:54,864 - monthly_report - INFO - Prioritized item: 💊 Drug Crime Incidents - District 3 - All (Priority: 1)
2025-05-12 14:10:54,864 - monthly_report - INFO -   Explanation length: 260
2025-05-12 14:10:54,864 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:10:54,864 - monthly_report - INFO - Prioritized item: 🚨 Violent Crime Incidents - District 3 - All (Priority: 2)
2025-05-12 14:10:54,864 - monthly_report - INFO -   Explanation length: 231
2025-05-12 14:10:54,864 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:10:54,864 - monthly_report - INFO - Prioritized item: 🚫 Business Closures - All (Priority: 3)
2025-05-12 14:10:54,864 - monthly_report - INFO -   Explanation length: 207
2025-05-12 14:10:54,864 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:10:54,865 - monthly_report - INFO - Prioritized 3 items for the report
2025-05-12 14:10:54,865 - monthly_report - INFO - Step 2.5: Storing prioritized items
2025-05-12 14:10:54,865 - monthly_report - INFO - Storing 3 prioritized items in the database
2025-05-12 14:10:54,870 - monthly_report - INFO - Created report record with ID: 124
2025-05-12 14:10:54,871 - monthly_report - INFO - Storing item: 💊 Drug Crime Incidents - District 3 - Priority: 1
2025-05-12 14:10:54,871 - monthly_report - INFO -   Explanation: 'Drug crime incidents in District 3 have decreased ...' (length: 260)
2025-05-12 14:10:54,871 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:10:54,872 - monthly_report - INFO - Stored item with ID 256, explanation length in DB: 260
2025-05-12 14:10:54,872 - monthly_report - INFO - Storing item: 🚨 Violent Crime Incidents - District 3 - Priority: 2
2025-05-12 14:10:54,872 - monthly_report - INFO -   Explanation: 'Violent crime incidents in District 3 have decreas...' (length: 231)
2025-05-12 14:10:54,872 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:10:54,872 - monthly_report - INFO - Stored item with ID 257, explanation length in DB: 231
2025-05-12 14:10:54,872 - monthly_report - INFO - Storing item: 🚫 Business Closures - Priority: 3
2025-05-12 14:10:54,873 - monthly_report - INFO -   Explanation: 'Business closures have decreased by 34.6%, which i...' (length: 207)
2025-05-12 14:10:54,873 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:10:54,873 - monthly_report - INFO - Stored item with ID 258, explanation length in DB: 207
2025-05-12 14:10:54,874 - monthly_report - INFO - Successfully stored 3 items in the database
2025-05-12 14:10:54,874 - monthly_report - INFO - Step 3: Generating explanations
2025-05-12 14:10:54,874 - monthly_report - INFO - Generating explanations for 3 items
2025-05-12 14:10:54,880 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:10:54,880 - monthly_report - INFO - Generating explanation for report_id=256, metric=💊 Drug Crime Incidents - District 3 (ID: 4), group=All
2025-05-12 14:10:54,880 - monthly_report - INFO -   Values: recent=14.0, comparison=24.0, diff=-10.0, percent_change=-41.66666666666667
2025-05-12 14:10:54,880 - monthly_report - INFO -   Period: month, District: 3
2025-05-12 14:10:54,880 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '💊 Drug Crime Incidents - District 3' (ID: 4)  decreased from 24.0 to 14.0 (41.67%) between March 2025 and April 2025 for district 3.

Use the available tools to research...
2025-05-12 14:10:54,880 - monthly_report - INFO - Running explainer agent for metric: 4
2025-05-12 14:11:02,319 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:11:02,319 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:11:02,320 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:11:02,320 - monthly_report - INFO - Response has messages attribute with 4 messages
2025-05-12 14:11:02,320 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:11:02,320 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The decrease in drug crime incidents in District 3 from March to April 2025 can be attr...
2025-05-12 14:11:02,320 - monthly_report - INFO - Final explanation to be stored for 💊 Drug Crime Incidents - District 3 (length: 1170): EXPLANATION: The decrease in drug crime incidents in District 3 from March to April 2025 can be attributed to several factors. In March, there were 24 drug crime incidents reported, while in April, th...
2025-05-12 14:11:02,321 - monthly_report - INFO - Updated explanation for report ID 256
2025-05-12 14:11:02,321 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:11:02,321 - monthly_report - INFO - Generating explanation for report_id=257, metric=🚨 Violent Crime Incidents - District 3 (ID: 2), group=All
2025-05-12 14:11:02,321 - monthly_report - INFO -   Values: recent=94.0, comparison=122.0, diff=-28.0, percent_change=-22.950819672131146
2025-05-12 14:11:02,321 - monthly_report - INFO -   Period: month, District: 3
2025-05-12 14:11:02,321 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚨 Violent Crime Incidents - District 3' (ID: 2)  decreased from 122.0 to 94.0 (22.95%) between March 2025 and April 2025 for district 3.

Use the available tools to rese...
2025-05-12 14:11:02,321 - monthly_report - INFO - Running explainer agent for metric: 2
2025-05-12 14:11:11,376 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:11:11,376 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:11:11,377 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:11:11,377 - monthly_report - INFO - Response has messages attribute with 4 messages
2025-05-12 14:11:11,377 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:11:11,377 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The decrease in violent crime incidents in District 3 from March 2025 to April 2025 can...
2025-05-12 14:11:11,377 - monthly_report - INFO - Final explanation to be stored for 🚨 Violent Crime Incidents - District 3 (length: 927): EXPLANATION: The decrease in violent crime incidents in District 3 from March 2025 to April 2025 can predominantly be attributed to declines in robberies and assaults. Specifically, two significant an...
2025-05-12 14:11:11,378 - monthly_report - INFO - Updated explanation for report ID 257
2025-05-12 14:11:11,379 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:11:11,379 - monthly_report - INFO - Generating explanation for report_id=258, metric=🚫 Business Closures (ID: 15), group=All
2025-05-12 14:11:11,379 - monthly_report - INFO -   Values: recent=34.0, comparison=52.0, diff=-18.0, percent_change=-34.61538461538461
2025-05-12 14:11:11,379 - monthly_report - INFO -   Period: month, District: 3
2025-05-12 14:11:11,379 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚫 Business Closures' (ID: 15)  decreased from 52.0 to 34.0 (34.62%) between March 2025 and April 2025 for district 3.

Use the available tools to research this change an...
2025-05-12 14:11:11,380 - monthly_report - INFO - Running explainer agent for metric: 15
2025-05-12 14:11:28,959 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:11:28,960 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:11:28,960 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:11:28,960 - monthly_report - INFO - Response has messages attribute with 8 messages
2025-05-12 14:11:28,960 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:11:28,960 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The decrease in business closures in District 3 from 52 to 34 between March 2025 and Ap...
2025-05-12 14:11:28,960 - monthly_report - INFO - Final explanation to be stored for 🚫 Business Closures (length: 1456): EXPLANATION: The decrease in business closures in District 3 from 52 to 34 between March 2025 and April 2025 appears to be broadly due to a reduction in the number of formal business closures across v...
2025-05-12 14:11:28,961 - monthly_report - INFO - Updated explanation for report ID 258
2025-05-12 14:11:28,962 - monthly_report - INFO - Successfully generated explanations for 3 items
2025-05-12 14:11:28,962 - monthly_report - INFO - Step 4: Getting report items for Perplexity context enrichment
2025-05-12 14:11:28,967 - monthly_report - INFO - Step 5: Getting additional context from Perplexity API for each report item
2025-05-12 14:11:28,967 - monthly_report - INFO - Getting additional context from Perplexity API for 3 report items
2025-05-12 14:11:28,967 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 💊 Drug Crime Incidents - District 3
Group: All
Recent Value: 14.0
Previous Value: 24.0
Percent Change: -41.67%
Explanation: Drug crime incidents in District 3 have decreased significantly by 41.7%, which is notable given the year-to-date increase of 37.2% in the district. This represents a counter-trend and could indicate the effectiveness of recent interventions or policy changes.
Detailed Analysis: EXPLANATION: The decrease in drug crime incidents in District 3 from March to April 2025 can be attributed to several factors. In March, there were 24 drug crime incidents reported, while in April, this number dropped to 14, which is a 41.67% decrease. However, this change does not align with any detected anomalies for the period reviewed. 

The supervisory district data indicates that the decline was part of overall fluctuations in drug-related incidents, which occasionally experience such variations based on policing efforts, community engagement strategies, or other local factors. Notably, April 2025 saw no significant anomalies in the type or category of drug crimes, suggesting that the drop might be related to successful intervention programs or law enforcement operations during this time.

Additionally, the historical context reveals that the monthly average over 24 months is 20 incidents, so the figures for April 2025 were below this average, further confirming this was not out of the ordinary pattern. Overall, while the number decreased, it appears as part of typical monthly variabilities without specific anomalies underpinning this occurrence.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:11:28,967 - monthly_report - INFO - Sending request to Perplexity API for 💊 Drug Crime Incidents - District 3
2025-05-12 14:11:33,055 - monthly_report - INFO - Successfully received response from Perplexity API for 💊 Drug Crime Incidents - District 3
2025-05-12 14:11:33,056 - monthly_report - INFO - Raw Perplexity response: {"id": "89719ffe-0b58-480c-a377-89fc6eed2c07", "model": "sonar", "created": 1747084292, "usage": {"prompt_tokens": 484, "completion_tokens": 209, "total_tokens": 693, "search_context_size": "low"}, "citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nIn San Francisco, drug crime trends have been subject to significant fluctuations, with various interventions impacting the statistics. The Mission District has seen low crime rates overall, but an increase in public drug use[1]. Th...
2025-05-12 14:11:33,056 - monthly_report - INFO - Found top-level citations: ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php"]
2025-05-12 14:11:33,056 - monthly_report - INFO - Added Perplexity response data to 💊 Drug Crime Incidents - District 3: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php"]}
2025-05-12 14:11:33,056 - monthly_report - INFO - Added Perplexity context to 💊 Drug Crime Incidents - District 3 (length: 1098)
2025-05-12 14:11:33,056 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚨 Violent Crime Incidents - District 3
Group: All
Recent Value: 94.0
Previous Value: 122.0
Percent Change: -22.95%
Explanation: Violent crime incidents in District 3 have decreased by 23.0%, continuing a broader trend of declining violent crime in the district, which is down 23.9% year-to-date. This is significant for public safety and community well-being.
Detailed Analysis: EXPLANATION: The decrease in violent crime incidents in District 3 from March 2025 to April 2025 can predominantly be attributed to declines in robberies and assaults. Specifically, two significant anomalies were detected: robberies plummeted by 53.4%, from an average of 32.2 incidents in the prior months to just 15 in April 2025, and assaults decreased by 37.0%, from a previous average of 90.5 incidents to 57 in April 2025. These reductions collectively accounted for much of the 22.95% decrease in overall violent crime incidents during this period. Despite these declines, other categories such as 'Offences Against The Family And Children' saw a slight increase by 4%, although they had a negligible impact on the total reduction. The anomalies in robbery and assault incidents played a pivotal role in the overall substantial decrease in violent crimes for April 2025. [CHART:anomaly:7688e12d] [CHART:anomaly:d5b8eb36]


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:11:33,056 - monthly_report - INFO - Sending request to Perplexity API for 🚨 Violent Crime Incidents - District 3
2025-05-12 14:11:36,947 - monthly_report - INFO - Successfully received response from Perplexity API for 🚨 Violent Crime Incidents - District 3
2025-05-12 14:11:36,947 - monthly_report - INFO - Raw Perplexity response: {"id": "552f6cab-b815-465c-a186-b0e0056ea5b7", "model": "sonar", "created": 1747084296, "usage": {"prompt_tokens": 476, "completion_tokens": 175, "total_tokens": 651, "search_context_size": "low"}, "citations": ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://media.api.sf.gov/documents/PoliceCommission5725-_Commission_Crime_Trends_Notes_05.07.25.pdf", "https://www.sanfranciscopolice.org/sites/default/files/2025-04/SFPD_CrimeReport_March2025_20250416_1.pdf", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nViolent crime in San Francisco has seen a significant decline, with a citywide decrease of almost 15% so far this year[5]. The trend is consistent with the decrease observed in District 3, where violent crime incidents have dr...
2025-05-12 14:11:36,947 - monthly_report - INFO - Found top-level citations: ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://media.api.sf.gov/documents/PoliceCommission5725-_Commission_Crime_Trends_Notes_05.07.25.pdf", "https://www.sanfranciscopolice.org/sites/default/files/2025-04/SFPD_CrimeReport_March2025_20250416_1.pdf", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"]
2025-05-12 14:11:36,947 - monthly_report - INFO - Added Perplexity response data to 🚨 Violent Crime Incidents - District 3: {"citations": ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://media.api.sf.gov/documents/PoliceCommission5725-_Commission_Crime_Trends_Notes_05.07.25.pdf", "https://www.sanfranciscopolice.org/sites/default/files/2025-04/SFPD_CrimeReport_March2025_20250416_1.pdf", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"]}
2025-05-12 14:11:36,947 - monthly_report - INFO - Added Perplexity context to 🚨 Violent Crime Incidents - District 3 (length: 901)
2025-05-12 14:11:36,947 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚫 Business Closures
Group: All
Recent Value: 34.0
Previous Value: 52.0
Percent Change: -34.62%
Explanation: Business closures have decreased by 34.6%, which is a continuation of the year-to-date trend showing a 56.1% decrease. This is important for the local economy and suggests a stabilizing business environment.
Detailed Analysis: EXPLANATION: The decrease in business closures in District 3 from 52 to 34 between March 2025 and April 2025 appears to be broadly due to a reduction in the number of formal business closures across various sectors, rather than any specific anomaly. The data does not show any significant anomalies that directly explain the drop during this period. Instead, the decrease aligns with a broader trend of lower business closures compared to previous months. 

Notably, some of the businesses that closed in District 3 during this period include:
- Chubby Noodle at 510 Union St, categorized under Food Services
- Don Pisto's at 510 Union St, also under Food Services
- Everyday at 10 Geary St, categorized under Retail Trade
- U.S. Marketing Services at 101 Lombard St 704w, under Professional, Scientific, and Technical Services

This change reflects a general decrease in closures across several business corridors. Specifically, closures in Chinatown, North Beach, and Middle Polk were recorded below their 24-month averages. North Beach showed a minor increase in closures, but again, these remain low overall.

Overall, District 3 saw a substantial 66% decrease relative to its 24-month average, which includes various sectors primarily decreasing in closures, including the Professional, Scientific, and Technical Services and Retail Trade sectors. This suggests perhaps improved business conditions or stability in these areas during this time period.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:11:36,947 - monthly_report - INFO - Sending request to Perplexity API for 🚫 Business Closures
2025-05-12 14:11:41,545 - monthly_report - INFO - Successfully received response from Perplexity API for 🚫 Business Closures
2025-05-12 14:11:41,546 - monthly_report - INFO - Raw Perplexity response: {"id": "2395d412-c002-4bf4-86cd-6e6f7a61f73e", "model": "sonar", "created": 1747084301, "usage": {"prompt_tokens": 540, "completion_tokens": 161, "total_tokens": 701, "search_context_size": "low"}, "citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://sfist.com/2025/04/02/downtown-mall-death-spiral-continues-with-departures-of/", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\nRecent news highlights a mixed economic environment in San Francisco. Despite a decrease in business closures, which indicates some stability, there have been significant closures in retail spaces...
2025-05-12 14:11:41,546 - monthly_report - INFO - Found top-level citations: ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://sfist.com/2025/04/02/downtown-mall-death-spiral-continues-with-departures-of/", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"]
2025-05-12 14:11:41,547 - monthly_report - INFO - Added Perplexity response data to 🚫 Business Closures: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://sfist.com/2025/04/02/downtown-mall-death-spiral-continues-with-departures-of/", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"]}
2025-05-12 14:11:41,547 - monthly_report - INFO - Added Perplexity context to 🚫 Business Closures (length: 923)
2025-05-12 14:11:41,547 - monthly_report - INFO - Successfully retrieved additional context from Perplexity API for all items
2025-05-12 14:11:41,547 - monthly_report - INFO - Step 5.5: Updating database with Perplexity context
2025-05-12 14:11:41,553 - monthly_report - INFO - Updating perplexity_context for 💊 Drug Crime Incidents - District 3 - All (length: 1098)
2025-05-12 14:11:41,556 - monthly_report - INFO - Updated 1 records for perplexity_context (💊 Drug Crime Incidents - District 3 - All)
2025-05-12 14:11:41,556 - monthly_report - INFO - Updating perplexity_response for 💊 Drug Crime Incidents - District 3 - All: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:11:41,556 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:11:41,559 - monthly_report - INFO - Updated 1 records for perplexity_response (💊 Drug Crime Incidents - District 3 - All)
2025-05-12 14:11:41,560 - monthly_report - INFO - Verification successful! perplexity_response was stored for 💊 Drug Crime Incidents - District 3: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:11:41,560 - monthly_report - INFO - Updating perplexity_context for 🚨 Violent Crime Incidents - District 3 - All (length: 901)
2025-05-12 14:11:41,561 - monthly_report - INFO - Updated 1 records for perplexity_context (🚨 Violent Crime Incidents - District 3 - All)
2025-05-12 14:11:41,561 - monthly_report - INFO - Updating perplexity_response for 🚨 Violent Crime Incidents - District 3 - All: {"citations": ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://m...
2025-05-12 14:11:41,561 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://m...
2025-05-12 14:11:41,561 - monthly_report - INFO - Updated 1 records for perplexity_response (🚨 Violent Crime Incidents - District 3 - All)
2025-05-12 14:11:41,562 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚨 Violent Crime Incidents - District 3: {"citations": ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://m...
2025-05-12 14:11:41,562 - monthly_report - INFO - Updating perplexity_context for 🚫 Business Closures - All (length: 923)
2025-05-12 14:11:41,562 - monthly_report - INFO - Updated 1 records for perplexity_context (🚫 Business Closures - All)
2025-05-12 14:11:41,563 - monthly_report - INFO - Updating perplexity_response for 🚫 Business Closures - All: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:11:41,563 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:11:41,563 - monthly_report - INFO - Updated 1 records for perplexity_response (🚫 Business Closures - All)
2025-05-12 14:11:41,563 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚫 Business Closures: {"citations": ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pd...
2025-05-12 14:11:41,564 - monthly_report - INFO - Verification counts: 3 records with perplexity_context, 3 with perplexity_response
2025-05-12 14:11:41,565 - monthly_report - INFO - Updated 3 items with Perplexity context
2025-05-12 14:11:41,566 - monthly_report - INFO - Step 6: Generating monthly newsletter
2025-05-12 14:11:41,566 - monthly_report - INFO - Generating monthly report for district 3
2025-05-12 14:11:41,574 - monthly_report - INFO - Found 3 report items for date 2025-05-12 and district 3
2025-05-12 14:11:41,575 - monthly_report - INFO - Raw perplexity_citations for 💊 Drug Crime Incidents - District 3: ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests...
2025-05-12 14:11:41,575 - monthly_report - INFO - Formatted 5 citations for 💊 Drug Crime Incidents - District 3
2025-05-12 14:11:41,575 - monthly_report - INFO - Citation map: {"1": "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "2": "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "3": "https://growsf.org/news/2025-04-10-crime-is-down/", "4": "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/", "5": "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php"}
2025-05-12 14:11:41,575 - monthly_report - INFO - Found citation references in context: ['1', '3', '4', '5']
2025-05-12 14:11:41,575 - monthly_report - INFO - Raw perplexity_citations for 🚨 Violent Crime Incidents - District 3: ["https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://media.api.sf.gov/documents/PoliceCommission5725-_Commission_Crime_Trends_Notes_05.07.25.pdf", "https://www.sanfranciscopolice.org/sites/default/files/2025-04/SFPD_CrimeReport_March2025_20250416_1.pdf", "https://grow...
2025-05-12 14:11:41,575 - monthly_report - INFO - Formatted 5 citations for 🚨 Violent Crime Incidents - District 3
2025-05-12 14:11:41,575 - monthly_report - INFO - Citation map: {"1": "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "2": "https://media.api.sf.gov/documents/PoliceCommission5725-_Commission_Crime_Trends_Notes_05.07.25.pdf", "3": "https://www.sanfranciscopolice.org/sites/default/files/2025-04/SFPD_CrimeReport_March2025_20250416_1.pdf", "4": "https://growsf.org/news/2025-04-10-crime-is-down/", "5": "https://www.sfchronicle.com/crime/article/sf-neighborhoods-data-20315912.php"}
2025-05-12 14:11:41,575 - monthly_report - INFO - Found citation references in context: ['5']
2025-05-12 14:11:41,576 - monthly_report - INFO - Raw perplexity_citations for 🚫 Business Closures: ["https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://sfist.com/20...
2025-05-12 14:11:41,576 - monthly_report - INFO - Formatted 5 citations for 🚫 Business Closures
2025-05-12 14:11:41,576 - monthly_report - INFO - Citation map: {"1": "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "2": "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "3": "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "4": "https://sfist.com/2025/04/02/downtown-mall-death-spiral-continues-with-departures-of/", "5": "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"}
2025-05-12 14:11:41,576 - monthly_report - INFO - Found citation references in context: ['3', '4', '5']
2025-05-12 14:11:41,576 - monthly_report - INFO - Making API call to generate report content
2025-05-12 14:11:56,034 - monthly_report - INFO - Received report content (length: 3706)
2025-05-12 14:11:56,036 - monthly_report - INFO - Monthly newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05.html
2025-05-12 14:11:56,037 - monthly_report - INFO - Step 7: Expanding chart references in the newsletter
2025-05-12 14:11:56,037 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05.html
2025-05-12 14:11:56,038 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05.html
2025-05-12 14:11:56,039 - monthly_report - INFO - Step 8: Proofreading and revising newsletter
2025-05-12 14:11:56,039 - monthly_report - INFO - Proofreading and revising newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05.html
2025-05-12 14:11:56,039 - monthly_report - INFO - Using AGENT_MODEL for proofreading
2025-05-12 14:12:33,406 - monthly_report - INFO - Expanding chart references in revised report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,406 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,406 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,416 - monthly_report - INFO - Updated report ID 124 with revised filename, proofread feedback, and headlines.
2025-05-12 14:12:33,416 - monthly_report - INFO - Revised newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,416 - monthly_report - INFO - Step 9: Generating email-compatible version of newsletter
2025-05-12 14:12:33,416 - monthly_report - INFO - Generating email-compatible version of report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,416 - monthly_report - INFO - Expanding chart references in report for email compatibility: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,417 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,417 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:12:33,417 - monthly_report - INFO - Found 4 potential iframe URLs to process.
2025-05-12 14:12:33,417 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=7688e12d#chart-section'
2025-05-12 14:12:33,418 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=7688e12d#chart-section'
2025-05-12 14:12:33,418 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=7688e12d#chart-section'
2025-05-12 14:12:33,418 - monthly_report - INFO - Requesting anomaly image for id=7688e12d
2025-05-12 14:12:33,418 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '7688e12d'}
2025-05-12 14:12:33,441 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=7688e12d#chart-section
2025-05-12 14:12:50,109 - monthly_report - WARNING - Specific selectors failed, trying general approach: Page.wait_for_function: Timeout 15000ms exceeded.
2025-05-12 14:13:05,144 - monthly_report - ERROR - Error capturing chart image: Page.wait_for_selector: Timeout 15000ms exceeded.
Call log:
  - waiting for locator(".js-plotly-plot") to be visible
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3344, in request_chart_image
    page.wait_for_selector('.js-plotly-plot', state='visible', timeout=15000)
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/sync_api/_generated.py", line 8187, in wait_for_selector
    self._sync(
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_sync_base.py", line 115, in _sync
    return task.result()
           ^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_page.py", line 425, in wait_for_selector
    return await self._main_frame.wait_for_selector(**locals_to_params(locals()))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_frame.py", line 323, in wait_for_selector
    await self._channel.send("waitForSelector", locals_to_params(locals()))
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_connection.py", line 61, in send
    return await self._connection.wrap_api_call(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_connection.py", line 528, in wrap_api_call
    raise rewrite_error(error, f"{parsed_st['apiName']}: {error}") from None
playwright._impl._errors.TimeoutError: Page.wait_for_selector: Timeout 15000ms exceeded.
Call log:
  - waiting for locator(".js-plotly-plot") to be visible

2025-05-12 14:13:05,145 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:13:05,592 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_7688e12d_1747084353.png
2025-05-12 14:13:05,592 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=7688e12d#chart-section) with image: anomaly_7688e12d_1747084353.png (1 occurrence(s))
2025-05-12 14:13:05,592 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=4&district=3&period_type=month#chart-section'
2025-05-12 14:13:05,592 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=4&district=3&period_type=month#chart-section'
2025-05-12 14:13:05,592 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=4&district=3&period_type=month#chart-section'
2025-05-12 14:13:05,592 - monthly_report - INFO - Requesting time-series image for metric=4, district=3, period=month
2025-05-12 14:13:05,592 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '4', 'district': '3', 'period_type': 'month'}
2025-05-12 14:13:05,592 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=4&district=3&period_type=month#chart-section
2025-05-12 14:13:08,083 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:13:08,084 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:13:08,114 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:13:08,114 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:13:08,132 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_4_3_month_1747084385.png
2025-05-12 14:13:08,134 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=4&district=3&period_type=month#chart-section
2025-05-12 14:13:08,134 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=d5b8eb36#chart-section'
2025-05-12 14:13:08,134 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=d5b8eb36#chart-section'
2025-05-12 14:13:08,134 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=d5b8eb36#chart-section'
2025-05-12 14:13:08,134 - monthly_report - INFO - Requesting anomaly image for id=d5b8eb36
2025-05-12 14:13:08,134 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': 'd5b8eb36'}
2025-05-12 14:13:08,134 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=d5b8eb36#chart-section
2025-05-12 14:13:24,510 - monthly_report - WARNING - Specific selectors failed, trying general approach: Page.wait_for_function: Timeout 15000ms exceeded.
2025-05-12 14:13:39,555 - monthly_report - ERROR - Error capturing chart image: Page.wait_for_selector: Timeout 15000ms exceeded.
Call log:
  - waiting for locator(".js-plotly-plot") to be visible
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3344, in request_chart_image
    page.wait_for_selector('.js-plotly-plot', state='visible', timeout=15000)
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/sync_api/_generated.py", line 8187, in wait_for_selector
    self._sync(
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_sync_base.py", line 115, in _sync
    return task.result()
           ^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_page.py", line 425, in wait_for_selector
    return await self._main_frame.wait_for_selector(**locals_to_params(locals()))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_frame.py", line 323, in wait_for_selector
    await self._channel.send("waitForSelector", locals_to_params(locals()))
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_connection.py", line 61, in send
    return await self._connection.wrap_api_call(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/.venv/lib/python3.11/site-packages/playwright/_impl/_connection.py", line 528, in wrap_api_call
    raise rewrite_error(error, f"{parsed_st['apiName']}: {error}") from None
playwright._impl._errors.TimeoutError: Page.wait_for_selector: Timeout 15000ms exceeded.
Call log:
  - waiting for locator(".js-plotly-plot") to be visible

2025-05-12 14:13:39,555 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:13:39,577 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_d5b8eb36_1747084388.png
2025-05-12 14:13:39,578 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=d5b8eb36#chart-section) with image: anomaly_d5b8eb36_1747084388.png (1 occurrence(s))
2025-05-12 14:13:39,578 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=15&district=3&period_type=month#chart-section'
2025-05-12 14:13:39,578 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=15&district=3&period_type=month#chart-section'
2025-05-12 14:13:39,578 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=15&district=3&period_type=month#chart-section'
2025-05-12 14:13:39,578 - monthly_report - INFO - Requesting time-series image for metric=15, district=3, period=month
2025-05-12 14:13:39,578 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '15', 'district': '3', 'period_type': 'month'}
2025-05-12 14:13:39,578 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=15&district=3&period_type=month#chart-section
2025-05-12 14:13:42,404 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:13:42,404 - monthly_report - INFO - Adjusted clip area: {'x': 0, 'y': 0, 'width': 640, 'height': 640}
2025-05-12 14:13:42,431 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3394, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:13:42,432 - monthly_report - WARNING - Falling back to basic chart image for time_series.
2025-05-12 14:13:42,449 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_15_3_month_1747084419.png
2025-05-12 14:13:42,449 - monthly_report - INFO - Replaced entire chart container with iframe (src: /backend/time-series-chart?metric_id=15&district=3&period_type=month#chart-section) with image container: time_series_15_3_month_1747084419.png (1 occurrence(s))
2025-05-12 14:13:42,449 - monthly_report - INFO - Total iframe replacements made: 3
2025-05-12 14:13:42,449 - monthly_report - INFO - Generated email-compatible report at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised_email.html
2025-05-12 14:13:42,449 - monthly_report - INFO - Generated email-compatible newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised_email.html
2025-05-12 14:13:42,450 - monthly_report - INFO - Updated top_level.json for district 3 with revised report filename
2025-05-12 14:13:42,450 - monthly_report - INFO - Monthly newsletter process completed successfully
2025-05-12 14:13:42,454 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:14:04,053 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:14:04,053 - root - INFO - Root logger configured for monthly_report.py with level: INFO
2025-05-12 14:14:04,054 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:14:04,054 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:14:04,054 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:14:04,054 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:14:04,054 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:14:04,070 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:14:04,075 - backend - INFO - Requesting monthly report by ID: 124
2025-05-12 14:14:06,537 - backend - INFO - Requesting monthly report file: monthly_report_3_2025_05_revised.html
2025-05-12 14:14:06,537 - backend - INFO - get_monthly_report_file - script_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai
2025-05-12 14:14:06,537 - backend - INFO - get_monthly_report_file - reports_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports
2025-05-12 14:14:06,537 - backend - INFO - get_monthly_report_file - constructed file_path: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:14:06,537 - backend - INFO - Serving file: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_3_2025_05_revised.html
2025-05-12 14:14:06,662 - backend - INFO - Looking for chart with object_id=4, district=3, period_type=month, group_field=None, groups=None
2025-05-12 14:14:06,669 - backend - INFO - Available metrics in database: ['1', '9', '4', '8', '12', '10', '7', '17', '13', '15', '5', '14', '6', '3', '11', '2', '16']
2025-05-12 14:14:06,670 - backend - INFO - Available period types in database: ['year', 'month']
2025-05-12 14:14:06,670 - backend - INFO - Found 366 entries with object_id=4
2025-05-12 14:14:06,671 - backend - INFO - Found 25 data points for chart_id 4373
2025-05-12 14:14:06,671 - backend - INFO - Retrieved chart data for object_id: 4, district: 3, period_type: month, group_field: None
2025-05-12 14:14:06,673 - backend - INFO - Looking for chart with object_id=15, district=3, period_type=month, group_field=None, groups=None
2025-05-12 14:14:06,678 - backend - INFO - Available metrics in database: ['1', '9', '4', '8', '12', '10', '7', '17', '13', '15', '5', '14', '6', '3', '11', '2', '16']
2025-05-12 14:14:06,679 - backend - INFO - Available period types in database: ['year', 'month']
2025-05-12 14:14:06,679 - backend - INFO - Found 246 entries with object_id=15
2025-05-12 14:14:06,681 - backend - INFO - Found 25 data points for chart_id 4677
2025-05-12 14:14:06,681 - backend - INFO - Retrieved chart data for object_id: 15, district: 3, period_type: month, group_field: None
2025-05-12 14:14:28,073 - main - ERROR - Monthly file not found for district 0, metric all
2025-05-12 14:14:30,572 - backend - INFO - Found selected columns for endpoint wg3w-h783 and metric_id 2: ['report_type_description', 'incident_category', 'incident_subcategory', 'incident_description', 'supervisor_district']
2025-05-12 14:14:37,318 - backend - INFO - Using dashboard_queries_enhanced.json at path: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/dashboard/dashboard_queries_enhanced.json
2025-05-12 14:14:37,318 - backend - INFO - Successfully loaded enhanced queries file with 3 categories
2025-05-12 14:14:37,319 - backend - INFO - Looking for endpoint: wg3w-h783, metric_id: 2
2025-05-12 14:14:37,319 - backend - INFO - Successfully updated category_fields for metric: 🚨 Violent Crime Incidents
2025-05-12 14:14:37,320 - backend - INFO - Successfully saved updated enhanced queries to: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/dashboard/dashboard_queries_enhanced.json
2025-05-12 14:14:37,343 - backend - INFO - Found selected columns for endpoint wg3w-h783 and metric_id 2: ['report_type_description', 'incident_category', 'incident_subcategory', 'incident_description', 'police_district', 'supervisor_district']
2025-05-12 14:14:37,352 - main - ERROR - Monthly file not found for district 0, metric all
2025-05-12 14:14:38,188 - backend - INFO - Run specific metric called for metric_id: 2, district_id: 0, period_type: month
2025-05-12 14:16:11,231 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:16:11,232 - root - INFO - Root logger configured for monthly_report.py with level: INFO
2025-05-12 14:16:11,232 - backend - ERROR - Error getting monthly reports: "Agent" object has no field "logger"
2025-05-12 14:16:16,403 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:16:16,403 - root - INFO - Root logger configured for monthly_report.py with level: INFO
2025-05-12 14:16:16,403 - backend - ERROR - Error getting monthly reports: "Agent" object has no field "logger"
2025-05-12 14:16:17,091 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:16:17,091 - root - INFO - Root logger configured for monthly_report.py with level: INFO
2025-05-12 14:16:17,091 - backend - ERROR - Error getting monthly reports: "Agent" object has no field "logger"
2025-05-12 14:16:43,305 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:16:43,306 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:16:43,306 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:16:43,306 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:16:43,307 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:16:43,307 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:16:43,422 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:16:44,161 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:16:46,426 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:16:54,737 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:20:14,317 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:22:52,981 - ai.monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:23:09,027 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:23:09,029 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:23:09,029 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:23:09,029 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:23:09,029 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:23:09,029 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:23:09,055 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:12,509 - backend - INFO - Generating monthly report with district=4, period_type=month, max_items=1
2025-05-12 14:23:12,510 - monthly_report - INFO - Starting monthly newsletter process for district 4
2025-05-12 14:23:12,510 - monthly_report - INFO - Step 0: Initializing monthly_reporting table
2025-05-12 14:23:12,510 - monthly_report - INFO - Initializing tables for monthly reporting
2025-05-12 14:23:12,515 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:12,515 - monthly_report - INFO - Checking if reports table exists...
2025-05-12 14:23:12,519 - monthly_report - INFO - Reports table already exists
2025-05-12 14:23:12,528 - monthly_report - INFO - Table monthly_reporting exists with columns: ['id', 'report_id', 'object_id', 'item_title', 'explanation', 'report_text', 'created_at', 'updated_at', 'report_date', 'metric_name', 'group_value', 'group_field_name', 'period_type', 'comparison_mean', 'recent_mean', 'difference', 'std_dev', 'percent_change', 'priority', 'district', 'chart_data', 'metadata', 'metric_id']
2025-05-12 14:23:12,528 - monthly_report - INFO - Table monthly_reporting already has all required columns
2025-05-12 14:23:12,528 - monthly_report - INFO - Step 1: Selecting deltas to discuss
2025-05-12 14:23:12,528 - monthly_report - INFO - Selecting top 20 and bottom 20 deltas for monthly report
2025-05-12 14:23:12,528 - monthly_report - INFO - Requesting top changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=4&show_both=false
2025-05-12 14:23:12,531 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=4
2025-05-12 14:23:12,533 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '4']
2025-05-12 14:23:12,535 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:23:12,536 - anomalyAnalyzer - INFO - Processing chart_id 2892 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,536 - anomalyAnalyzer - INFO - Executing data query for chart 2892 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,537 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2892
2025-05-12 14:23:12,537 - anomalyAnalyzer - INFO - Result for chart 2892: 👮 Total Police Incidents - District 4 - Previous: 237.0 (2025-03-31), Recent: 228.0 (2025-04-30), Delta: -9.0
2025-05-12 14:23:12,537 - anomalyAnalyzer - INFO - Processing chart_id 2951 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,537 - anomalyAnalyzer - INFO - Executing data query for chart 2951 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,538 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2951
2025-05-12 14:23:12,538 - anomalyAnalyzer - INFO - Result for chart 2951: 🚨 Violent Crime Incidents - District 4 - Previous: 34.0 (2025-03-31), Recent: 31.0 (2025-04-30), Delta: -3.0
2025-05-12 14:23:12,538 - anomalyAnalyzer - INFO - Processing chart_id 3007 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,538 - anomalyAnalyzer - INFO - Executing data query for chart 3007 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3007
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Result for chart 3007: 🏠 Property Crime Incidents - District 4 - Previous: 106.0 (2025-03-31), Recent: 105.0 (2025-04-30), Delta: -1.0
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Processing chart_id 3098 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Executing data query for chart 3098 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3098
2025-05-12 14:23:12,539 - anomalyAnalyzer - INFO - Result for chart 3098: 💊 Drug Crime Incidents - District 4 - Previous: 0.0 (2025-03-31), Recent: 2.0 (2025-04-30), Delta: 2.0
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Processing chart_id 3129 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Executing data query for chart 3129 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3129
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Result for chart 3129: 🚒 Fire Incidents YTD - District 4 - Previous: 121.0 (2025-03-31), Recent: 62.0 (2025-04-30), Delta: -59.0
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Processing chart_id 3164 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Executing data query for chart 3164 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,540 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3164
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Result for chart 3164: 💔 Fire Fatalities YTD - District 4 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Processing chart_id 3201 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Executing data query for chart 3201 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3201
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Result for chart 3201: 🚑 911 Response (minutes) - Danger to life - District 4 - Previous: 10.972854555108222 (2025-03-31), Recent: 10.767844611528822 (2025-04-30), Delta: -0.20500994357939994
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Processing chart_id 3210 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,541 - anomalyAnalyzer - INFO - Executing data query for chart 3210 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3210
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Result for chart 3210: 🚑 911 Response (minutes) - Danger to property  - District 4 - Previous: 38.47317073170732 (2025-03-31), Recent: 33.68484848484849 (2025-04-30), Delta: -4.788322246858833
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Processing chart_id 3223 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Executing data query for chart 3223 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3223
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Result for chart 3223: 🚑 911 Response (minutes) - No danger to life or property - District 4 - Previous: 97.64423076923077 (2025-03-31), Recent: 80.19241192411924 (2025-04-30), Delta: -17.451818845111532
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Processing chart_id 3244 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,542 - anomalyAnalyzer - INFO - Executing data query for chart 3244 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,543 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3244
2025-05-12 14:23:12,543 - anomalyAnalyzer - INFO - Result for chart 3244: 🏢 New Business Registrations - District 4 - Previous: 30.0 (2025-03-31), Recent: 36.0 (2025-04-30), Delta: 6.0
2025-05-12 14:23:12,543 - anomalyAnalyzer - INFO - Processing chart_id 3285 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,543 - anomalyAnalyzer - INFO - Executing data query for chart 3285 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3285
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Result for chart 3285: 🚫 Business Closures - District 4 - Previous: 8.0 (2025-03-31), Recent: 7.0 (2025-04-30), Delta: -1.0
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Processing chart_id 3318 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Executing data query for chart 3318 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3318
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Result for chart 3318: 🛍️ New Retail Registrations - District 4 - Previous: 5.0 (2025-03-31), Recent: 3.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Processing chart_id 4202 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,544 - anomalyAnalyzer - INFO - Executing data query for chart 4202 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4202
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Result for chart 4202: 👮 Total Police Incidents - Previous: 238.0 (2025-03-31), Recent: 228.0 (2025-04-30), Delta: -10.0
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Processing chart_id 4317 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Executing data query for chart 4317 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4317
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Result for chart 4317: 🏠 Property Crime Incidents - Previous: 107.0 (2025-03-31), Recent: 105.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Processing chart_id 4408 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,545 - anomalyAnalyzer - INFO - Executing data query for chart 4408 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4408
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Result for chart 4408: 💊 Drug Crime Incidents - Previous: 0.0 (2025-03-31), Recent: 2.0 (2025-04-30), Delta: 2.0
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Processing chart_id 4439 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Executing data query for chart 4439 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4439
2025-05-12 14:23:12,546 - anomalyAnalyzer - INFO - Result for chart 4439: 🚒 Fire Incidents YTD - Previous: 125.0 (2025-03-31), Recent: 72.0 (2025-04-30), Delta: -53.0
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Processing chart_id 4474 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Executing data query for chart 4474 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4474
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Result for chart 4474: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Processing chart_id 4511 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,547 - anomalyAnalyzer - INFO - Executing data query for chart 4511 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4511
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Result for chart 4511: 🚑 911 Response (minutes) - Danger to life - Previous: 10.972854555108222 (2025-03-31), Recent: 10.767844611528822 (2025-04-30), Delta: -0.20500994357939994
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Processing chart_id 4520 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Executing data query for chart 4520 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4520
2025-05-12 14:23:12,548 - anomalyAnalyzer - INFO - Result for chart 4520: 🚑 911 Response (minutes) - Danger to property  - Previous: 38.47317073170732 (2025-03-31), Recent: 33.68484848484849 (2025-04-30), Delta: -4.788322246858833
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Processing chart_id 4533 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Executing data query for chart 4533 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4533
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Result for chart 4533: 🚑 911 Response (minutes) - No danger to life or property - Previous: 97.64423076923077 (2025-03-31), Recent: 80.19241192411924 (2025-04-30), Delta: -17.451818845111532
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Processing chart_id 4616 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Executing data query for chart 4616 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4616
2025-05-12 14:23:12,549 - anomalyAnalyzer - INFO - Result for chart 4616: 🛍️ New Retail Registrations - Previous: 5.0 (2025-03-31), Recent: 3.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Processing chart_id 4649 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Executing data query for chart 4649 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4649
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Result for chart 4649: 🏢 New Business Registrations - Previous: 30.0 (2025-03-31), Recent: 38.0 (2025-04-30), Delta: 8.0
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Processing chart_id 4680 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Executing data query for chart 4680 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4680
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Result for chart 4680: 🚫 Business Closures - Previous: 8.0 (2025-03-31), Recent: 8.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Processing chart_id 4759 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,550 - anomalyAnalyzer - INFO - Executing data query for chart 4759 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4759
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Result for chart 4759: 🚨 Violent Crime Incidents - Previous: 34.0 (2025-03-31), Recent: 31.0 (2025-04-30), Delta: -3.0
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 4 - Delta: -9.0, Percent Change: -3.79746835443038
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 4 - Delta: -3.0, Percent Change: -8.823529411764707
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 4 - Delta: -1.0, Percent Change: -0.9433962264150944
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Split results: 2 positive, 17 negative, 5 zero/null
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Top 0: 🏢 New Business Registrations - Percent Change: 26.666666666666668%
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Top 1: 🏢 New Business Registrations - District 4 - Percent Change: 20.0%
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Bottom 0: 🚒 Fire Incidents YTD - District 4 - Percent Change: -48.760330578512395%
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Bottom 1: 🚒 Fire Incidents YTD - Percent Change: -42.4%
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Bottom 2: 🛍️ New Retail Registrations - District 4 - Percent Change: -40.0%
2025-05-12 14:23:12,551 - anomalyAnalyzer - INFO - Found 2 top results and 20 bottom results
2025-05-12 14:23:12,552 - monthly_report - INFO - Top changes API response status code: 200
2025-05-12 14:23:12,552 - monthly_report - INFO - Received top changes data: {"status": "success", "count": 22, "period_type": "month", "object_id": null, "district": "4", "top_results": [{"group_value": null, "recent_value": 38.0, "previous_value": 30.0, "delta": 8.0, "abs_de...
2025-05-12 14:23:12,552 - monthly_report - INFO - Top data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:23:12,552 - monthly_report - INFO - Top results count: 2
2025-05-12 14:23:12,552 - monthly_report - INFO - Sample top result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:23:12,552 - monthly_report - INFO - Sample top result item: {"group_value": null, "recent_value": 38.0, "previous_value": 30.0, "delta": 8.0, "abs_delta": 8.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 4649, "object_id": "14", "object_name": "\ud83c\udfe2 New Business Registrations", "group_field": null, "district": "4", "percent_change": 26.666666666666668}
2025-05-12 14:23:12,552 - monthly_report - INFO - Requesting bottom changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=4&show_both=false&negative=true
2025-05-12 14:23:12,554 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=4
2025-05-12 14:23:12,556 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '4']
2025-05-12 14:23:12,557 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:23:12,558 - anomalyAnalyzer - INFO - Processing chart_id 2892 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,558 - anomalyAnalyzer - INFO - Executing data query for chart 2892 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2892
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Result for chart 2892: 👮 Total Police Incidents - District 4 - Previous: 237.0 (2025-03-31), Recent: 228.0 (2025-04-30), Delta: -9.0
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Processing chart_id 2951 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Executing data query for chart 2951 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2951
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Result for chart 2951: 🚨 Violent Crime Incidents - District 4 - Previous: 34.0 (2025-03-31), Recent: 31.0 (2025-04-30), Delta: -3.0
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Processing chart_id 3007 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Executing data query for chart 3007 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3007
2025-05-12 14:23:12,559 - anomalyAnalyzer - INFO - Result for chart 3007: 🏠 Property Crime Incidents - District 4 - Previous: 106.0 (2025-03-31), Recent: 105.0 (2025-04-30), Delta: -1.0
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Processing chart_id 3098 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Executing data query for chart 3098 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3098
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Result for chart 3098: 💊 Drug Crime Incidents - District 4 - Previous: 0.0 (2025-03-31), Recent: 2.0 (2025-04-30), Delta: 2.0
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Processing chart_id 3129 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,560 - anomalyAnalyzer - INFO - Executing data query for chart 3129 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,561 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3129
2025-05-12 14:23:12,561 - anomalyAnalyzer - INFO - Result for chart 3129: 🚒 Fire Incidents YTD - District 4 - Previous: 121.0 (2025-03-31), Recent: 62.0 (2025-04-30), Delta: -59.0
2025-05-12 14:23:12,561 - anomalyAnalyzer - INFO - Processing chart_id 3164 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,561 - anomalyAnalyzer - INFO - Executing data query for chart 3164 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,562 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3164
2025-05-12 14:23:12,562 - anomalyAnalyzer - INFO - Result for chart 3164: 💔 Fire Fatalities YTD - District 4 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,563 - anomalyAnalyzer - INFO - Processing chart_id 3201 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,563 - anomalyAnalyzer - INFO - Executing data query for chart 3201 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,563 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3201
2025-05-12 14:23:12,563 - anomalyAnalyzer - INFO - Result for chart 3201: 🚑 911 Response (minutes) - Danger to life - District 4 - Previous: 10.972854555108222 (2025-03-31), Recent: 10.767844611528822 (2025-04-30), Delta: -0.20500994357939994
2025-05-12 14:23:12,564 - anomalyAnalyzer - INFO - Processing chart_id 3210 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,564 - anomalyAnalyzer - INFO - Executing data query for chart 3210 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,564 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3210
2025-05-12 14:23:12,564 - anomalyAnalyzer - INFO - Result for chart 3210: 🚑 911 Response (minutes) - Danger to property  - District 4 - Previous: 38.47317073170732 (2025-03-31), Recent: 33.68484848484849 (2025-04-30), Delta: -4.788322246858833
2025-05-12 14:23:12,564 - anomalyAnalyzer - INFO - Processing chart_id 3223 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,565 - anomalyAnalyzer - INFO - Executing data query for chart 3223 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,565 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3223
2025-05-12 14:23:12,565 - anomalyAnalyzer - INFO - Result for chart 3223: 🚑 911 Response (minutes) - No danger to life or property - District 4 - Previous: 97.64423076923077 (2025-03-31), Recent: 80.19241192411924 (2025-04-30), Delta: -17.451818845111532
2025-05-12 14:23:12,565 - anomalyAnalyzer - INFO - Processing chart_id 3244 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,565 - anomalyAnalyzer - INFO - Executing data query for chart 3244 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3244
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Result for chart 3244: 🏢 New Business Registrations - District 4 - Previous: 30.0 (2025-03-31), Recent: 36.0 (2025-04-30), Delta: 6.0
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Processing chart_id 3285 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Executing data query for chart 3285 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3285
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Result for chart 3285: 🚫 Business Closures - District 4 - Previous: 8.0 (2025-03-31), Recent: 7.0 (2025-04-30), Delta: -1.0
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Processing chart_id 3318 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,566 - anomalyAnalyzer - INFO - Executing data query for chart 3318 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3318
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Result for chart 3318: 🛍️ New Retail Registrations - District 4 - Previous: 5.0 (2025-03-31), Recent: 3.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Processing chart_id 4202 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Executing data query for chart 4202 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4202
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Result for chart 4202: 👮 Total Police Incidents - Previous: 238.0 (2025-03-31), Recent: 228.0 (2025-04-30), Delta: -10.0
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Processing chart_id 4317 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,567 - anomalyAnalyzer - INFO - Executing data query for chart 4317 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4317
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Result for chart 4317: 🏠 Property Crime Incidents - Previous: 107.0 (2025-03-31), Recent: 105.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Processing chart_id 4408 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Executing data query for chart 4408 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4408
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Result for chart 4408: 💊 Drug Crime Incidents - Previous: 0.0 (2025-03-31), Recent: 2.0 (2025-04-30), Delta: 2.0
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Processing chart_id 4439 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,568 - anomalyAnalyzer - INFO - Executing data query for chart 4439 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4439
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Result for chart 4439: 🚒 Fire Incidents YTD - Previous: 125.0 (2025-03-31), Recent: 72.0 (2025-04-30), Delta: -53.0
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Processing chart_id 4474 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Executing data query for chart 4474 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4474
2025-05-12 14:23:12,569 - anomalyAnalyzer - INFO - Result for chart 4474: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Processing chart_id 4511 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Executing data query for chart 4511 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4511
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Result for chart 4511: 🚑 911 Response (minutes) - Danger to life - Previous: 10.972854555108222 (2025-03-31), Recent: 10.767844611528822 (2025-04-30), Delta: -0.20500994357939994
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Processing chart_id 4520 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,570 - anomalyAnalyzer - INFO - Executing data query for chart 4520 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4520
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Result for chart 4520: 🚑 911 Response (minutes) - Danger to property  - Previous: 38.47317073170732 (2025-03-31), Recent: 33.68484848484849 (2025-04-30), Delta: -4.788322246858833
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Processing chart_id 4533 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Executing data query for chart 4533 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4533
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Result for chart 4533: 🚑 911 Response (minutes) - No danger to life or property - Previous: 97.64423076923077 (2025-03-31), Recent: 80.19241192411924 (2025-04-30), Delta: -17.451818845111532
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Processing chart_id 4616 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,571 - anomalyAnalyzer - INFO - Executing data query for chart 4616 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4616
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Result for chart 4616: 🛍️ New Retail Registrations - Previous: 5.0 (2025-03-31), Recent: 3.0 (2025-04-30), Delta: -2.0
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Processing chart_id 4649 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Executing data query for chart 4649 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4649
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Result for chart 4649: 🏢 New Business Registrations - Previous: 30.0 (2025-03-31), Recent: 38.0 (2025-04-30), Delta: 8.0
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Processing chart_id 4680 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Executing data query for chart 4680 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,572 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4680
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Result for chart 4680: 🚫 Business Closures - Previous: 8.0 (2025-03-31), Recent: 8.0 (2025-04-30), Delta: 0.0
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Processing chart_id 4759 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Executing data query for chart 4759 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4759
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Result for chart 4759: 🚨 Violent Crime Incidents - Previous: 34.0 (2025-03-31), Recent: 31.0 (2025-04-30), Delta: -3.0
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 4 - Delta: -9.0, Percent Change: -3.79746835443038
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 4 - Delta: -3.0, Percent Change: -8.823529411764707
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 4 - Delta: -1.0, Percent Change: -0.9433962264150944
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Split results: 2 positive, 17 negative, 5 zero/null
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Top 0: 🏢 New Business Registrations - Percent Change: 26.666666666666668%
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Top 1: 🏢 New Business Registrations - District 4 - Percent Change: 20.0%
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Bottom 0: 🚒 Fire Incidents YTD - District 4 - Percent Change: -48.760330578512395%
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Bottom 1: 🚒 Fire Incidents YTD - Percent Change: -42.4%
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Bottom 2: 🛍️ New Retail Registrations - District 4 - Percent Change: -40.0%
2025-05-12 14:23:12,573 - anomalyAnalyzer - INFO - Found 2 top results and 20 bottom results
2025-05-12 14:23:12,574 - monthly_report - INFO - Bottom changes API response status code: 200
2025-05-12 14:23:12,574 - monthly_report - INFO - Received bottom changes data: {"status": "success", "count": 22, "period_type": "month", "object_id": null, "district": "4", "top_results": [{"group_value": null, "recent_value": 38.0, "previous_value": 30.0, "delta": 8.0, "abs_de...
2025-05-12 14:23:12,574 - monthly_report - INFO - Bottom data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:23:12,574 - monthly_report - INFO - Bottom results count: 20
2025-05-12 14:23:12,574 - monthly_report - INFO - Sample bottom result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:23:12,574 - monthly_report - INFO - Sample bottom result item: {"group_value": null, "recent_value": 62.0, "previous_value": 121.0, "delta": -59.0, "abs_delta": 59.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3129, "object_id": "8", "object_name": "\ud83d\ude92 Fire Incidents YTD - District 4", "group_field": null, "district": "4", "percent_change": -48.760330578512395}
2025-05-12 14:23:12,574 - monthly_report - INFO - Found 2 top changes and 20 bottom changes
2025-05-12 14:23:12,574 - monthly_report - INFO - Step 2: Prioritizing deltas
2025-05-12 14:23:12,574 - monthly_report - INFO - Prioritizing deltas for discussion (max 1 items)
2025-05-12 14:23:12,576 - webChat - INFO - 
Notes loading complete:
Districts processed: 12
Total combined length: 15871 characters
First 100 characters: 
================================================================================
Citywide Metrics S

2025-05-12 14:23:12,576 - webChat - INFO - Successfully saved notes to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/notes/combined_notes.txt
2025-05-12 14:23:12,576 - monthly_report - INFO - Loaded 15871 characters of combined notes for context
2025-05-12 14:23:12,576 - monthly_report - INFO - Loading prompts from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/prompts.json
2025-05-12 14:23:12,576 - monthly_report - INFO - Successfully loaded prompts with keys: ['monthly_report']
2025-05-12 14:23:16,342 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:23:16,344 - monthly_report - INFO - Received JSON response of length: 603
2025-05-12 14:23:16,345 - monthly_report - INFO - Parsed JSON: {"items": [{"index": 3, "metric": "\ud83d\ude92 Fire Incidents YTD - District 4 for All", "metric_id": "8", "group": "District 4", "priority": 1, "explanation": "The significant decrease in fire incid...
2025-05-12 14:23:16,345 - monthly_report - INFO - Found items under key: items
2025-05-12 14:23:16,345 - monthly_report - INFO - Extracted 1 items from JSON
2025-05-12 14:23:16,345 - monthly_report - INFO -   Item 1: {"index": 3, "metric": "\ud83d\ude92 Fire Incidents YTD - District 4 for All", "metric_id": "8", "gr...
2025-05-12 14:23:16,345 - monthly_report - INFO - Found original data for item index 3: 🚒 Fire Incidents YTD - District 4
2025-05-12 14:23:16,345 - monthly_report - INFO - Prioritized item: 🚒 Fire Incidents YTD - District 4 - All (Priority: 1)
2025-05-12 14:23:16,345 - monthly_report - INFO -   Explanation length: 459
2025-05-12 14:23:16,345 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:23:16,345 - monthly_report - INFO - Prioritized 1 items for the report
2025-05-12 14:23:16,345 - monthly_report - INFO - Step 2.5: Storing prioritized items
2025-05-12 14:23:16,345 - monthly_report - INFO - Storing 1 prioritized items in the database
2025-05-12 14:23:16,350 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:16,352 - monthly_report - INFO - Created report record with ID: 125
2025-05-12 14:23:16,352 - monthly_report - INFO - Storing item: 🚒 Fire Incidents YTD - District 4 - Priority: 1
2025-05-12 14:23:16,352 - monthly_report - INFO -   Explanation: 'The significant decrease in fire incidents in Dist...' (length: 459)
2025-05-12 14:23:16,352 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:23:16,354 - monthly_report - INFO - Stored item with ID 259, explanation length in DB: 459
2025-05-12 14:23:16,354 - monthly_report - INFO - Successfully stored 1 items in the database
2025-05-12 14:23:16,354 - monthly_report - INFO - Step 3: Generating explanations
2025-05-12 14:23:16,355 - monthly_report - INFO - Generating explanations for 1 items
2025-05-12 14:23:16,359 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:16,361 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:23:16,361 - monthly_report - INFO - Generating explanation for report_id=259, metric=🚒 Fire Incidents YTD - District 4 (ID: 8), group=All
2025-05-12 14:23:16,361 - monthly_report - INFO -   Values: recent=62.0, comparison=121.0, diff=-59.0, percent_change=-48.760330578512395
2025-05-12 14:23:16,361 - monthly_report - INFO -   Period: month, District: 4
2025-05-12 14:23:16,361 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚒 Fire Incidents YTD - District 4' (ID: 8)  decreased from 121.0 to 62.0 (48.76%) between March 2025 and April 2025 for district 4.

Use the available tools to research ...
2025-05-12 14:23:16,361 - monthly_report - INFO - Running explainer agent for metric: 8
2025-05-12 14:23:17,367 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:23:17,372 - webChat - INFO - 
=== get_notes called ===
Total length: 15869 characters
Approximate tokens: 2639
First 100 chars: ================================================================================
Citywide Metrics Su
Number of lines: 291

2025-05-12 14:23:19,312 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:23:19,313 - webChat - INFO - 
=== query_anomalies_db called ===
Parameters:
- query_type: by_metric_id
- limit: 30
- group_filter: None
- date_start: None
- date_end: None
- only_anomalies: True
- metric_name: None
- district_filter: 4
- metric_id: 8
- period_type: month

2025-05-12 14:23:19,313 - webChat - INFO - Using database connection: localhost:5432/transparentsf (user: postgres)
2025-05-12 14:23:19,313 - webChat - INFO - Using query_type 'by_metric_id' with metric_id=8
2025-05-12 14:23:19,313 - webChat - INFO - Calling get_anomalies with query_type=by_metric_id, limit=30
2025-05-12 14:23:19,313 - webChat - INFO - Additional filters: group_filter=None, date_start=None, date_end=None, only_anomalies=True, metric_name=None, district_filter=4, metric_id=8, period_type=month
2025-05-12 14:23:19,317 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:19,320 - webChat - INFO - get_anomalies query completed in 0.01 seconds
2025-05-12 14:23:19,320 - webChat - INFO - get_anomalies returned 1 results
2025-05-12 14:23:19,321 - webChat - INFO - Processed 1 results in 0.00 seconds
2025-05-12 14:23:19,321 - webChat - INFO - Returning 1 results for query_type=by_metric_id
2025-05-12 14:23:19,321 - webChat - INFO - Looking for dashboard data in: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard
2025-05-12 14:23:19,321 - webChat - INFO - Fetching specific metric '8.json' for district 4 from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/4/8.json
2025-05-12 14:23:19,322 - webChat - INFO - Using metric_id as a number: 8
2025-05-12 14:23:19,322 - webChat - INFO - Looking for monthly analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/monthly/4/8.md
2025-05-12 14:23:19,322 - webChat - INFO - Looking for annual analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/annual/4/8.md
2025-05-12 14:23:19,322 - webChat - INFO - Found monthly analysis file (14871 chars)
2025-05-12 14:23:19,323 - webChat - INFO - Found annual analysis file (11110 chars)
2025-05-12 14:23:19,323 - webChat - INFO - Added analysis content with keys: ['monthly_analysis', 'annual_analysis']
2025-05-12 14:23:19,323 - webChat - INFO - Successfully retrieved dashboard metric data from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/4/8.json
2025-05-12 14:23:28,462 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:23:28,462 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:23:28,462 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:23:28,463 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:23:28,463 - monthly_report - INFO - Response has messages attribute with 6 messages
2025-05-12 14:23:28,463 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:23:28,463 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: Between March 2025 and April 2025, 'Fire Incidents YTD - District 4' decreased by 48.76...
2025-05-12 14:23:28,463 - monthly_report - INFO - Final explanation to be stored for 🚒 Fire Incidents YTD - District 4 (length: 1180): EXPLANATION: Between March 2025 and April 2025, 'Fire Incidents YTD - District 4' decreased by 48.76%, dropping from 121 to 62 incidents. This significant drop can be attributed largely to a reduction...
2025-05-12 14:23:28,464 - monthly_report - INFO - Updated explanation for report ID 259
2025-05-12 14:23:28,466 - monthly_report - INFO - Successfully generated explanations for 1 items
2025-05-12 14:23:28,466 - monthly_report - INFO - Step 4: Getting report items for Perplexity context enrichment
2025-05-12 14:23:28,469 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:28,474 - monthly_report - INFO - Step 5: Getting additional context from Perplexity API for each report item
2025-05-12 14:23:28,474 - monthly_report - INFO - Getting additional context from Perplexity API for 1 report items
2025-05-12 14:23:28,474 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚒 Fire Incidents YTD - District 4
Group: All
Recent Value: 62.0
Previous Value: 121.0
Percent Change: -48.76%
Explanation: The significant decrease in fire incidents in District 4, with a reduction of 48.8%, is noteworthy as it represents a substantial improvement in public safety. This change is counter to the broader trend of a smaller decrease in fire incidents citywide (-11.9% vs last year). The magnitude of the decrease in District 4 is particularly significant, indicating effective fire prevention measures or other contributing factors that have led to this improvement.
Detailed Analysis: EXPLANATION: Between March 2025 and April 2025, 'Fire Incidents YTD - District 4' decreased by 48.76%, dropping from 121 to 62 incidents. This significant drop can be attributed largely to a reduction in incidents categorized under 'NaN' ignition causes, which saw a 43.2% decrease, dropping from a mean of 121.6 to 69 incidents. [CHART:anomaly:281253]

Additionally, it appears that this decrease might relate to fewer incidents categorized with specific ignition causes, as most individual causes saw negligible or zero incidents. For example, fires with an 'unintentional' ignition cause actually saw a minor rise in April 2025, but this was not enough to offset the overall decrease from the 'NaN' category.

This substantial reduction might also indirectly correlate with the general trend of declining fire incidents in District 4 over recent years, signifying possible improvements in fire prevention measures or community initiatives to enhance safety, although these are speculative and would require further validation through detailed local insights. Overall, the anomaly observed aligns with a broader decrease in fire incidents noted in recent periods for District 4.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:23:28,475 - monthly_report - INFO - Sending request to Perplexity API for 🚒 Fire Incidents YTD - District 4
2025-05-12 14:23:33,853 - monthly_report - INFO - Successfully received response from Perplexity API for 🚒 Fire Incidents YTD - District 4
2025-05-12 14:23:33,853 - monthly_report - INFO - Raw Perplexity response: {"id": "f688b64d-2a29-4cc7-a899-5c4b51408e82", "model": "sonar", "created": 1747085013, "usage": {"prompt_tokens": 538, "completion_tokens": 178, "total_tokens": 716, "search_context_size": "low"}, "citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://www.fire.ca.gov/incidents/2025", "https://www.instagram.com/reel/DIM3W3VBlWq/", "https://www.nbcbayarea.com/news/local/4-alarm-fire-san-francisco/3837107/"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News Related to Fire Incidents\nThere have been significant fire incidents in San Francisco, such as the 4-alarm residential fire in Lower Nob Hill on April 5, 2025, which injured three people. This incident highlighted the challenges of fighting fires in densely populated areas due to \"zero lot lines,\" where buildings are closely adjacent[5]. However,...
2025-05-12 14:23:33,853 - monthly_report - INFO - Found top-level citations: ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://www.fire.ca.gov/incidents/2025", "https://www.instagram.com/reel/DIM3W3VBlWq/", "https://www.nbcbayarea.com/news/local/4-alarm-fire-san-francisco/3837107/"]
2025-05-12 14:23:33,853 - monthly_report - INFO - Added Perplexity response data to 🚒 Fire Incidents YTD - District 4: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://www.fire.ca.gov/incidents/2025", "https://www.instagram.com/reel/DIM3W3VBlWq/", "https://www.nbcbayarea.com/news/local/4-alarm-fire-san-francisco/3837107/"]}
2025-05-12 14:23:33,853 - monthly_report - INFO - Added Perplexity context to 🚒 Fire Incidents YTD - District 4 (length: 922)
2025-05-12 14:23:33,853 - monthly_report - INFO - Successfully retrieved additional context from Perplexity API for all items
2025-05-12 14:23:33,853 - monthly_report - INFO - Step 5.5: Updating database with Perplexity context
2025-05-12 14:23:33,859 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:33,859 - monthly_report - INFO - Updating perplexity_context for 🚒 Fire Incidents YTD - District 4 - All (length: 922)
2025-05-12 14:23:33,861 - monthly_report - INFO - Updated 1 records for perplexity_context (🚒 Fire Incidents YTD - District 4 - All)
2025-05-12 14:23:33,861 - monthly_report - INFO - Updating perplexity_response for 🚒 Fire Incidents YTD - District 4 - All: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/...
2025-05-12 14:23:33,861 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/...
2025-05-12 14:23:33,861 - monthly_report - INFO - Updated 1 records for perplexity_response (🚒 Fire Incidents YTD - District 4 - All)
2025-05-12 14:23:33,862 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚒 Fire Incidents YTD - District 4: {"citations": ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/...
2025-05-12 14:23:33,862 - monthly_report - INFO - Verification counts: 1 records with perplexity_context, 1 with perplexity_response
2025-05-12 14:23:33,863 - monthly_report - INFO - Updated 1 items with Perplexity context
2025-05-12 14:23:33,863 - monthly_report - INFO - Step 6: Generating monthly newsletter
2025-05-12 14:23:33,863 - monthly_report - INFO - Generating monthly report for district 4
2025-05-12 14:23:33,867 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:23:33,870 - monthly_report - INFO - Found 1 report items for date 2025-05-12 and district 4
2025-05-12 14:23:33,870 - monthly_report - INFO - Raw perplexity_citations for 🚒 Fire Incidents YTD - District 4: ["https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "https://www.fire.ca.gov/incidents/2025", "https://www.instagram.com/reel/DIM3W3VBlWq/", "https://www.nbcbayarea.com/news/local/4-alarm-fire-san-francisco/3837107/"]...
2025-05-12 14:23:33,870 - monthly_report - INFO - Formatted 5 citations for 🚒 Fire Incidents YTD - District 4
2025-05-12 14:23:33,870 - monthly_report - INFO - Citation map: {"1": "https://data.sfgov.org/Public-Safety/Fire-Incidents/wr8u-xric", "2": "http://sf-fire.org/budget-data-reports/fire-incident-dashboard", "3": "https://www.fire.ca.gov/incidents/2025", "4": "https://www.instagram.com/reel/DIM3W3VBlWq/", "5": "https://www.nbcbayarea.com/news/local/4-alarm-fire-san-francisco/3837107/"}
2025-05-12 14:23:33,871 - monthly_report - INFO - Found citation references in context: ['5']
2025-05-12 14:23:33,871 - monthly_report - INFO - Making API call to generate report content
2025-05-12 14:23:45,337 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:23:45,341 - monthly_report - INFO - Received report content (length: 3058)
2025-05-12 14:23:45,343 - monthly_report - INFO - Monthly newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05.html
2025-05-12 14:23:45,344 - monthly_report - INFO - Step 7: Expanding chart references in the newsletter
2025-05-12 14:23:45,344 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05.html
2025-05-12 14:23:45,345 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05.html
2025-05-12 14:23:45,345 - monthly_report - INFO - Step 8: Proofreading and revising newsletter
2025-05-12 14:23:45,345 - monthly_report - INFO - Proofreading and revising newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05.html
2025-05-12 14:23:45,345 - monthly_report - INFO - Using AGENT_MODEL for proofreading
2025-05-12 14:24:10,511 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:24:10,512 - monthly_report - INFO - Expanding chart references in revised report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,512 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,513 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,517 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:24:10,524 - monthly_report - INFO - Updated report ID 125 with revised filename, proofread feedback, and headlines.
2025-05-12 14:24:10,524 - monthly_report - INFO - Revised newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,524 - monthly_report - INFO - Step 9: Generating email-compatible version of newsletter
2025-05-12 14:24:10,524 - monthly_report - INFO - Generating email-compatible version of report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,524 - monthly_report - INFO - Expanding chart references in report for email compatibility: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,524 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,524 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised.html
2025-05-12 14:24:10,525 - monthly_report - INFO - Found 1 potential iframe URLs to process.
2025-05-12 14:24:10,525 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281253#chart-section'
2025-05-12 14:24:10,525 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281253#chart-section'
2025-05-12 14:24:10,525 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281253#chart-section'
2025-05-12 14:24:10,525 - monthly_report - INFO - Requesting anomaly image for id=281253
2025-05-12 14:24:10,525 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281253'}
2025-05-12 14:24:10,547 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281253#chart-section
2025-05-12 14:24:13,668 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 281253
2025-05-12 14:24:13,671 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:24:15,347 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:24:15,347 - monthly_report - INFO - Adjusted clip area: {'x': 41, 'y': 41, 'width': 598, 'height': 82}
2025-05-12 14:24:15,374 - monthly_report - ERROR - Error capturing chart image: Locator.screenshot() got an unexpected keyword argument 'clip'
Traceback (most recent call last):
  File "/Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/monthly_report.py", line 3412, in request_chart_image
    element.screenshot(**screenshot_options)
TypeError: Locator.screenshot() got an unexpected keyword argument 'clip'
2025-05-12 14:24:15,374 - monthly_report - WARNING - Falling back to basic chart image for anomaly.
2025-05-12 14:24:15,980 - monthly_report - INFO - Created fallback chart image at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281253_1747085050.png
2025-05-12 14:24:15,980 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=281253#chart-section) with image: anomaly_281253_1747085050.png (1 occurrence(s))
2025-05-12 14:24:15,980 - monthly_report - INFO - Total iframe replacements made: 1
2025-05-12 14:24:15,980 - monthly_report - INFO - Generated email-compatible report at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised_email.html
2025-05-12 14:24:15,980 - monthly_report - INFO - Generated email-compatible newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_4_2025_05_revised_email.html
2025-05-12 14:24:15,981 - monthly_report - INFO - Updated top_level.json for district 4 with revised report filename
2025-05-12 14:24:15,981 - monthly_report - INFO - Monthly newsletter process completed successfully
2025-05-12 14:24:15,981 - backend - INFO - Monthly report generated successfully: monthly_report_4_2025_05.html
2025-05-12 14:24:15,986 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:24:15,988 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:03,992 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:27:03,994 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:27:03,994 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:27:03,994 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:27:03,994 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:27:03,994 - monthly_report - INFO - Starting monthly newsletter process for district 5
2025-05-12 14:27:03,994 - monthly_report - INFO - Step 0: Initializing monthly_reporting table
2025-05-12 14:27:03,994 - monthly_report - INFO - Initializing tables for monthly reporting
2025-05-12 14:27:04,013 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:04,013 - monthly_report - INFO - Checking if reports table exists...
2025-05-12 14:27:04,017 - monthly_report - INFO - Reports table already exists
2025-05-12 14:27:04,028 - monthly_report - INFO - Table monthly_reporting exists with columns: ['id', 'report_id', 'object_id', 'item_title', 'explanation', 'report_text', 'created_at', 'updated_at', 'report_date', 'metric_name', 'group_value', 'group_field_name', 'period_type', 'comparison_mean', 'recent_mean', 'difference', 'std_dev', 'percent_change', 'priority', 'district', 'chart_data', 'metadata', 'metric_id']
2025-05-12 14:27:04,028 - monthly_report - INFO - Table monthly_reporting already has all required columns
2025-05-12 14:27:04,028 - monthly_report - INFO - Step 1: Selecting deltas to discuss
2025-05-12 14:27:04,028 - monthly_report - INFO - Selecting top 20 and bottom 20 deltas for monthly report
2025-05-12 14:27:04,028 - monthly_report - INFO - Requesting top changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=5&show_both=false
2025-05-12 14:27:04,030 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=5
2025-05-12 14:27:04,032 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '5']
2025-05-12 14:27:04,034 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:27:04,035 - anomalyAnalyzer - INFO - Processing chart_id 2896 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,035 - anomalyAnalyzer - INFO - Executing data query for chart 2896 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,036 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2896
2025-05-12 14:27:04,036 - anomalyAnalyzer - INFO - Result for chart 2896: 👮 Total Police Incidents - District 5 - Previous: 1286.0 (2025-03-31), Recent: 1337.0 (2025-04-30), Delta: 51.0
2025-05-12 14:27:04,036 - anomalyAnalyzer - INFO - Processing chart_id 2941 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,036 - anomalyAnalyzer - INFO - Executing data query for chart 2941 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,037 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2941
2025-05-12 14:27:04,037 - anomalyAnalyzer - INFO - Result for chart 2941: 🚨 Violent Crime Incidents - District 5 - Previous: 174.0 (2025-03-31), Recent: 152.0 (2025-04-30), Delta: -22.0
2025-05-12 14:27:04,037 - anomalyAnalyzer - INFO - Processing chart_id 3012 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,037 - anomalyAnalyzer - INFO - Executing data query for chart 3012 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,038 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3012
2025-05-12 14:27:04,038 - anomalyAnalyzer - INFO - Result for chart 3012: 🏠 Property Crime Incidents - District 5 - Previous: 321.0 (2025-03-31), Recent: 319.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,038 - anomalyAnalyzer - INFO - Processing chart_id 3053 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,038 - anomalyAnalyzer - INFO - Executing data query for chart 3053 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,039 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3053
2025-05-12 14:27:04,039 - anomalyAnalyzer - INFO - Result for chart 3053: 💊 Drug Crime Incidents - District 5 - Previous: 130.0 (2025-03-31), Recent: 191.0 (2025-04-30), Delta: 61.0
2025-05-12 14:27:04,039 - anomalyAnalyzer - INFO - Processing chart_id 3144 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,039 - anomalyAnalyzer - INFO - Executing data query for chart 3144 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3144
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Result for chart 3144: 🚒 Fire Incidents YTD - District 5 - Previous: 490.0 (2025-03-31), Recent: 397.0 (2025-04-30), Delta: -93.0
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Processing chart_id 3166 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Executing data query for chart 3166 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3166
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Result for chart 3166: 💔 Fire Fatalities YTD - District 5 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Processing chart_id 3181 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Executing data query for chart 3181 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3181
2025-05-12 14:27:04,040 - anomalyAnalyzer - INFO - Result for chart 3181: 🚑 911 Response (minutes) - Danger to life - District 5 - Previous: 10.263732317648456 (2025-03-31), Recent: 8.908110776233043 (2025-04-30), Delta: -1.3556215414154131
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Processing chart_id 3211 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Executing data query for chart 3211 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3211
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Result for chart 3211: 🚑 911 Response (minutes) - Danger to property  - District 5 - Previous: 55.70828848223897 (2025-03-31), Recent: 54.939745075318655 (2025-04-30), Delta: -0.7685434069203154
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Processing chart_id 3224 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Executing data query for chart 3224 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3224
2025-05-12 14:27:04,041 - anomalyAnalyzer - INFO - Result for chart 3224: 🚑 911 Response (minutes) - No danger to life or property - District 5 - Previous: 97.41586280814576 (2025-03-31), Recent: 99.55648975302154 (2025-04-30), Delta: 2.140626944875777
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Processing chart_id 3246 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Executing data query for chart 3246 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3246
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Result for chart 3246: 🏢 New Business Registrations - District 5 - Previous: 34.0 (2025-03-31), Recent: 32.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Processing chart_id 3261 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,042 - anomalyAnalyzer - INFO - Executing data query for chart 3261 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,043 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3261
2025-05-12 14:27:04,043 - anomalyAnalyzer - INFO - Result for chart 3261: 🚫 Business Closures - District 5 - Previous: 16.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: -10.0
2025-05-12 14:27:04,043 - anomalyAnalyzer - INFO - Processing chart_id 3320 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,043 - anomalyAnalyzer - INFO - Executing data query for chart 3320 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,043 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3320
2025-05-12 14:27:04,044 - anomalyAnalyzer - INFO - Result for chart 3320: 🛍️ New Retail Registrations - District 5 - Previous: 2.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: 4.0
2025-05-12 14:27:04,044 - anomalyAnalyzer - INFO - Processing chart_id 4206 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,044 - anomalyAnalyzer - INFO - Executing data query for chart 4206 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,044 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4206
2025-05-12 14:27:04,044 - anomalyAnalyzer - INFO - Result for chart 4206: 👮 Total Police Incidents - Previous: 1286.0 (2025-03-31), Recent: 1338.0 (2025-04-30), Delta: 52.0
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Processing chart_id 4322 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Executing data query for chart 4322 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4322
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Result for chart 4322: 🏠 Property Crime Incidents - Previous: 321.0 (2025-03-31), Recent: 319.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Processing chart_id 4363 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Executing data query for chart 4363 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4363
2025-05-12 14:27:04,045 - anomalyAnalyzer - INFO - Result for chart 4363: 💊 Drug Crime Incidents - Previous: 130.0 (2025-03-31), Recent: 191.0 (2025-04-30), Delta: 61.0
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Processing chart_id 4491 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Executing data query for chart 4491 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4491
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Result for chart 4491: 🚑 911 Response (minutes) - Danger to life - Previous: 10.263732317648456 (2025-03-31), Recent: 8.908110776233043 (2025-04-30), Delta: -1.3556215414154131
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Processing chart_id 4454 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Executing data query for chart 4454 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4454
2025-05-12 14:27:04,046 - anomalyAnalyzer - INFO - Result for chart 4454: 🚒 Fire Incidents YTD - Previous: 498.0 (2025-03-31), Recent: 413.0 (2025-04-30), Delta: -85.0
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Processing chart_id 4476 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Executing data query for chart 4476 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4476
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Result for chart 4476: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Processing chart_id 4521 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Executing data query for chart 4521 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4521
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Result for chart 4521: 🚑 911 Response (minutes) - Danger to property  - Previous: 55.70828848223897 (2025-03-31), Recent: 54.939745075318655 (2025-04-30), Delta: -0.7685434069203154
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Processing chart_id 4534 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,047 - anomalyAnalyzer - INFO - Executing data query for chart 4534 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4534
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Result for chart 4534: 🚑 911 Response (minutes) - No danger to life or property - Previous: 97.41586280814576 (2025-03-31), Recent: 99.55648975302154 (2025-04-30), Delta: 2.140626944875777
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Processing chart_id 4618 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Executing data query for chart 4618 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4618
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Result for chart 4618: 🛍️ New Retail Registrations - Previous: 2.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: 4.0
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Processing chart_id 4651 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,048 - anomalyAnalyzer - INFO - Executing data query for chart 4651 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4651
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Result for chart 4651: 🏢 New Business Registrations - Previous: 34.0 (2025-03-31), Recent: 33.0 (2025-04-30), Delta: -1.0
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Processing chart_id 4729 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Executing data query for chart 4729 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4729
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Result for chart 4729: 🚨 Violent Crime Incidents - Previous: 174.0 (2025-03-31), Recent: 152.0 (2025-04-30), Delta: -22.0
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Processing chart_id 4683 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Executing data query for chart 4683 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4683
2025-05-12 14:27:04,049 - anomalyAnalyzer - INFO - Result for chart 4683: 🚫 Business Closures - Previous: 16.0 (2025-03-31), Recent: 8.0 (2025-04-30), Delta: -8.0
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 5 - Delta: 51.0, Percent Change: 3.9657853810264383
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 5 - Delta: -22.0, Percent Change: -12.643678160919542
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 5 - Delta: -2.0, Percent Change: -0.6230529595015576
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Split results: 8 positive, 14 negative, 2 zero/null
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Top 0: 🛍️ New Retail Registrations - District 5 - Percent Change: 200.0%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Top 1: 🛍️ New Retail Registrations - Percent Change: 200.0%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Top 2: 💊 Drug Crime Incidents - District 5 - Percent Change: 46.92307692307692%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Bottom 0: 🚫 Business Closures - District 5 - Percent Change: -62.5%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Bottom 1: 🚫 Business Closures - Percent Change: -50.0%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Bottom 2: 🚒 Fire Incidents YTD - District 5 - Percent Change: -18.979591836734695%
2025-05-12 14:27:04,050 - anomalyAnalyzer - INFO - Found 8 top results and 16 bottom results
2025-05-12 14:27:04,050 - monthly_report - INFO - Top changes API response status code: 200
2025-05-12 14:27:04,050 - monthly_report - INFO - Received top changes data: {"status": "success", "count": 24, "period_type": "month", "object_id": null, "district": "5", "top_results": [{"group_value": null, "recent_value": 6.0, "previous_value": 2.0, "delta": 4.0, "abs_delt...
2025-05-12 14:27:04,050 - monthly_report - INFO - Top data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:27:04,050 - monthly_report - INFO - Top results count: 8
2025-05-12 14:27:04,050 - monthly_report - INFO - Sample top result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:27:04,051 - monthly_report - INFO - Sample top result item: {"group_value": null, "recent_value": 6.0, "previous_value": 2.0, "delta": 4.0, "abs_delta": 4.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3320, "object_id": "16", "object_name": "\ud83d\udecd\ufe0f New Retail Registrations - District 5", "group_field": null, "district": "5", "percent_change": 200.0}
2025-05-12 14:27:04,051 - monthly_report - INFO - Requesting bottom changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=5&show_both=false&negative=true
2025-05-12 14:27:04,052 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=5
2025-05-12 14:27:04,055 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '5']
2025-05-12 14:27:04,057 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:27:04,058 - anomalyAnalyzer - INFO - Processing chart_id 2896 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,058 - anomalyAnalyzer - INFO - Executing data query for chart 2896 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2896
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Result for chart 2896: 👮 Total Police Incidents - District 5 - Previous: 1286.0 (2025-03-31), Recent: 1337.0 (2025-04-30), Delta: 51.0
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Processing chart_id 2941 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Executing data query for chart 2941 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2941
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Result for chart 2941: 🚨 Violent Crime Incidents - District 5 - Previous: 174.0 (2025-03-31), Recent: 152.0 (2025-04-30), Delta: -22.0
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Processing chart_id 3012 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,059 - anomalyAnalyzer - INFO - Executing data query for chart 3012 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,060 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3012
2025-05-12 14:27:04,060 - anomalyAnalyzer - INFO - Result for chart 3012: 🏠 Property Crime Incidents - District 5 - Previous: 321.0 (2025-03-31), Recent: 319.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,060 - anomalyAnalyzer - INFO - Processing chart_id 3053 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,060 - anomalyAnalyzer - INFO - Executing data query for chart 3053 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,060 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3053
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Result for chart 3053: 💊 Drug Crime Incidents - District 5 - Previous: 130.0 (2025-03-31), Recent: 191.0 (2025-04-30), Delta: 61.0
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Processing chart_id 3144 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Executing data query for chart 3144 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3144
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Result for chart 3144: 🚒 Fire Incidents YTD - District 5 - Previous: 490.0 (2025-03-31), Recent: 397.0 (2025-04-30), Delta: -93.0
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Processing chart_id 3166 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,061 - anomalyAnalyzer - INFO - Executing data query for chart 3166 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3166
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Result for chart 3166: 💔 Fire Fatalities YTD - District 5 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Processing chart_id 3181 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Executing data query for chart 3181 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3181
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Result for chart 3181: 🚑 911 Response (minutes) - Danger to life - District 5 - Previous: 10.263732317648456 (2025-03-31), Recent: 8.908110776233043 (2025-04-30), Delta: -1.3556215414154131
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Processing chart_id 3211 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,062 - anomalyAnalyzer - INFO - Executing data query for chart 3211 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3211
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Result for chart 3211: 🚑 911 Response (minutes) - Danger to property  - District 5 - Previous: 55.70828848223897 (2025-03-31), Recent: 54.939745075318655 (2025-04-30), Delta: -0.7685434069203154
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Processing chart_id 3224 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Executing data query for chart 3224 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3224
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Result for chart 3224: 🚑 911 Response (minutes) - No danger to life or property - District 5 - Previous: 97.41586280814576 (2025-03-31), Recent: 99.55648975302154 (2025-04-30), Delta: 2.140626944875777
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Processing chart_id 3246 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Executing data query for chart 3246 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3246
2025-05-12 14:27:04,063 - anomalyAnalyzer - INFO - Result for chart 3246: 🏢 New Business Registrations - District 5 - Previous: 34.0 (2025-03-31), Recent: 32.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Processing chart_id 3261 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Executing data query for chart 3261 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3261
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Result for chart 3261: 🚫 Business Closures - District 5 - Previous: 16.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: -10.0
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Processing chart_id 3320 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Executing data query for chart 3320 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3320
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Result for chart 3320: 🛍️ New Retail Registrations - District 5 - Previous: 2.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: 4.0
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Processing chart_id 4206 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,064 - anomalyAnalyzer - INFO - Executing data query for chart 4206 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4206
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Result for chart 4206: 👮 Total Police Incidents - Previous: 1286.0 (2025-03-31), Recent: 1338.0 (2025-04-30), Delta: 52.0
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Processing chart_id 4322 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Executing data query for chart 4322 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4322
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Result for chart 4322: 🏠 Property Crime Incidents - Previous: 321.0 (2025-03-31), Recent: 319.0 (2025-04-30), Delta: -2.0
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Processing chart_id 4363 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Executing data query for chart 4363 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4363
2025-05-12 14:27:04,065 - anomalyAnalyzer - INFO - Result for chart 4363: 💊 Drug Crime Incidents - Previous: 130.0 (2025-03-31), Recent: 191.0 (2025-04-30), Delta: 61.0
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Processing chart_id 4491 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Executing data query for chart 4491 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4491
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Result for chart 4491: 🚑 911 Response (minutes) - Danger to life - Previous: 10.263732317648456 (2025-03-31), Recent: 8.908110776233043 (2025-04-30), Delta: -1.3556215414154131
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Processing chart_id 4454 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Executing data query for chart 4454 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4454
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Result for chart 4454: 🚒 Fire Incidents YTD - Previous: 498.0 (2025-03-31), Recent: 413.0 (2025-04-30), Delta: -85.0
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Processing chart_id 4476 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,066 - anomalyAnalyzer - INFO - Executing data query for chart 4476 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4476
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Result for chart 4476: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Processing chart_id 4521 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Executing data query for chart 4521 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4521
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Result for chart 4521: 🚑 911 Response (minutes) - Danger to property  - Previous: 55.70828848223897 (2025-03-31), Recent: 54.939745075318655 (2025-04-30), Delta: -0.7685434069203154
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Processing chart_id 4534 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Executing data query for chart 4534 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4534
2025-05-12 14:27:04,067 - anomalyAnalyzer - INFO - Result for chart 4534: 🚑 911 Response (minutes) - No danger to life or property - Previous: 97.41586280814576 (2025-03-31), Recent: 99.55648975302154 (2025-04-30), Delta: 2.140626944875777
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Processing chart_id 4618 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Executing data query for chart 4618 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4618
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Result for chart 4618: 🛍️ New Retail Registrations - Previous: 2.0 (2025-03-31), Recent: 6.0 (2025-04-30), Delta: 4.0
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Processing chart_id 4651 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Executing data query for chart 4651 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4651
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Result for chart 4651: 🏢 New Business Registrations - Previous: 34.0 (2025-03-31), Recent: 33.0 (2025-04-30), Delta: -1.0
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Processing chart_id 4729 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,068 - anomalyAnalyzer - INFO - Executing data query for chart 4729 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4729
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Result for chart 4729: 🚨 Violent Crime Incidents - Previous: 174.0 (2025-03-31), Recent: 152.0 (2025-04-30), Delta: -22.0
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Processing chart_id 4683 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Executing data query for chart 4683 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4683
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Result for chart 4683: 🚫 Business Closures - Previous: 16.0 (2025-03-31), Recent: 8.0 (2025-04-30), Delta: -8.0
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 5 - Delta: 51.0, Percent Change: 3.9657853810264383
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 5 - Delta: -22.0, Percent Change: -12.643678160919542
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 5 - Delta: -2.0, Percent Change: -0.6230529595015576
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Split results: 8 positive, 14 negative, 2 zero/null
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Top 0: 🛍️ New Retail Registrations - District 5 - Percent Change: 200.0%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Top 1: 🛍️ New Retail Registrations - Percent Change: 200.0%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Top 2: 💊 Drug Crime Incidents - District 5 - Percent Change: 46.92307692307692%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Bottom 0: 🚫 Business Closures - District 5 - Percent Change: -62.5%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Bottom 1: 🚫 Business Closures - Percent Change: -50.0%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Bottom 2: 🚒 Fire Incidents YTD - District 5 - Percent Change: -18.979591836734695%
2025-05-12 14:27:04,069 - anomalyAnalyzer - INFO - Found 8 top results and 16 bottom results
2025-05-12 14:27:04,070 - monthly_report - INFO - Bottom changes API response status code: 200
2025-05-12 14:27:04,070 - monthly_report - INFO - Received bottom changes data: {"status": "success", "count": 24, "period_type": "month", "object_id": null, "district": "5", "top_results": [{"group_value": null, "recent_value": 6.0, "previous_value": 2.0, "delta": 4.0, "abs_delt...
2025-05-12 14:27:04,070 - monthly_report - INFO - Bottom data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:27:04,070 - monthly_report - INFO - Bottom results count: 16
2025-05-12 14:27:04,070 - monthly_report - INFO - Sample bottom result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:27:04,070 - monthly_report - INFO - Sample bottom result item: {"group_value": null, "recent_value": 6.0, "previous_value": 16.0, "delta": -10.0, "abs_delta": 10.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3261, "object_id": "15", "object_name": "\ud83d\udeab Business Closures - District 5", "group_field": null, "district": "5", "percent_change": -62.5}
2025-05-12 14:27:04,070 - monthly_report - INFO - Found 8 top changes and 16 bottom changes
2025-05-12 14:27:04,070 - monthly_report - INFO - Step 2: Prioritizing deltas
2025-05-12 14:27:04,070 - monthly_report - INFO - Prioritizing deltas for discussion (max 1 items)
2025-05-12 14:27:04,072 - webChat - INFO - 
Notes loading complete:
Districts processed: 12
Total combined length: 15871 characters
First 100 characters: 
================================================================================
Citywide Metrics S

2025-05-12 14:27:04,073 - webChat - INFO - Successfully saved notes to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/notes/combined_notes.txt
2025-05-12 14:27:04,073 - monthly_report - INFO - Loaded 15871 characters of combined notes for context
2025-05-12 14:27:04,073 - monthly_report - INFO - Loading prompts from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/prompts.json
2025-05-12 14:27:04,073 - monthly_report - INFO - Successfully loaded prompts with keys: ['monthly_report']
2025-05-12 14:27:07,263 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:27:07,268 - monthly_report - INFO - Received JSON response of length: 559
2025-05-12 14:27:07,268 - monthly_report - INFO - Parsed JSON: {"items": [{"index": 3, "metric": "\ud83d\udc8a Drug Crime Incidents - District 5 for All: 191.0 vs 130.0 (+46.9%), District: 5", "metric_id": "4", "group": "District 5", "priority": 1, "explanation":...
2025-05-12 14:27:07,268 - monthly_report - INFO - Found items under key: items
2025-05-12 14:27:07,268 - monthly_report - INFO - Extracted 1 items from JSON
2025-05-12 14:27:07,268 - monthly_report - INFO -   Item 1: {"index": 3, "metric": "\ud83d\udc8a Drug Crime Incidents - District 5 for All: 191.0 vs 130.0 (+46....
2025-05-12 14:27:07,268 - monthly_report - INFO - Found original data for item index 3: 💊 Drug Crime Incidents - District 5
2025-05-12 14:27:07,268 - monthly_report - INFO - Prioritized item: 💊 Drug Crime Incidents - District 5 - All (Priority: 1)
2025-05-12 14:27:07,268 - monthly_report - INFO -   Explanation length: 375
2025-05-12 14:27:07,268 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:27:07,268 - monthly_report - INFO - Prioritized 1 items for the report
2025-05-12 14:27:07,268 - monthly_report - INFO - Step 2.5: Storing prioritized items
2025-05-12 14:27:07,268 - monthly_report - INFO - Storing 1 prioritized items in the database
2025-05-12 14:27:07,273 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:07,275 - monthly_report - INFO - Created report record with ID: 126
2025-05-12 14:27:07,275 - monthly_report - INFO - Storing item: 💊 Drug Crime Incidents - District 5 - Priority: 1
2025-05-12 14:27:07,275 - monthly_report - INFO -   Explanation: 'The significant increase in drug crime incidents i...' (length: 375)
2025-05-12 14:27:07,275 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:27:07,277 - monthly_report - INFO - Stored item with ID 260, explanation length in DB: 375
2025-05-12 14:27:07,278 - monthly_report - INFO - Successfully stored 1 items in the database
2025-05-12 14:27:07,278 - monthly_report - INFO - Step 3: Generating explanations
2025-05-12 14:27:07,278 - monthly_report - INFO - Generating explanations for 1 items
2025-05-12 14:27:07,282 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:07,285 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:27:07,285 - monthly_report - INFO - Generating explanation for report_id=260, metric=💊 Drug Crime Incidents - District 5 (ID: 4), group=All
2025-05-12 14:27:07,285 - monthly_report - INFO -   Values: recent=191.0, comparison=130.0, diff=61.0, percent_change=46.92307692307692
2025-05-12 14:27:07,285 - monthly_report - INFO -   Period: month, District: 5
2025-05-12 14:27:07,285 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '💊 Drug Crime Incidents - District 5' (ID: 4)  increased from 130.0 to 191.0 (46.92%) between March 2025 and April 2025 for district 5.

Use the available tools to resear...
2025-05-12 14:27:07,285 - monthly_report - INFO - Running explainer agent for metric: 4
2025-05-12 14:27:08,791 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:27:08,793 - webChat - INFO - 
=== query_anomalies_db called ===
Parameters:
- query_type: by_metric_id
- limit: 30
- group_filter: None
- date_start: None
- date_end: None
- only_anomalies: True
- metric_name: None
- district_filter: 5
- metric_id: 4
- period_type: month

2025-05-12 14:27:08,793 - webChat - INFO - Using database connection: localhost:5432/transparentsf (user: postgres)
2025-05-12 14:27:08,793 - webChat - INFO - Using query_type 'by_metric_id' with metric_id=4
2025-05-12 14:27:08,793 - webChat - INFO - Calling get_anomalies with query_type=by_metric_id, limit=30
2025-05-12 14:27:08,793 - webChat - INFO - Additional filters: group_filter=None, date_start=None, date_end=None, only_anomalies=True, metric_name=None, district_filter=5, metric_id=4, period_type=month
2025-05-12 14:27:08,798 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:08,801 - webChat - INFO - get_anomalies query completed in 0.01 seconds
2025-05-12 14:27:08,801 - webChat - INFO - get_anomalies returned 3 results
2025-05-12 14:27:08,801 - webChat - INFO - Processed 3 results in 0.00 seconds
2025-05-12 14:27:08,801 - webChat - INFO - Returning 3 results for query_type=by_metric_id
2025-05-12 14:27:08,801 - webChat - INFO - Looking for dashboard data in: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard
2025-05-12 14:27:08,801 - webChat - INFO - Fetching specific metric '4.json' for district 5 from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/5/4.json
2025-05-12 14:27:08,802 - webChat - INFO - Using metric_id as a number: 4
2025-05-12 14:27:08,802 - webChat - INFO - Looking for monthly analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/monthly/5/4.md
2025-05-12 14:27:08,802 - webChat - INFO - Looking for annual analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/annual/5/4.md
2025-05-12 14:27:08,803 - webChat - INFO - Found monthly analysis file (19858 chars)
2025-05-12 14:27:08,803 - webChat - INFO - Found annual analysis file (13094 chars)
2025-05-12 14:27:08,803 - webChat - INFO - Added analysis content with keys: ['monthly_analysis', 'annual_analysis']
2025-05-12 14:27:08,803 - webChat - INFO - Successfully retrieved dashboard metric data from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/5/4.json
2025-05-12 14:27:28,653 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:27:28,662 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:27:28,662 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:27:28,663 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:27:28,663 - monthly_report - INFO - Response has messages attribute with 4 messages
2025-05-12 14:27:28,663 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:27:28,663 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The increase in 'Drug Crime Incidents - District 5' from 130 in March 2025 to 191 in Ap...
2025-05-12 14:27:28,663 - monthly_report - INFO - Final explanation to be stored for 💊 Drug Crime Incidents - District 5 (length: 987): EXPLANATION: The increase in 'Drug Crime Incidents - District 5' from 130 in March 2025 to 191 in April 2025, a 46.92% increase, can largely be attributed to specific anomalies observed in certain dru...
2025-05-12 14:27:28,664 - monthly_report - INFO - Updated explanation for report ID 260
2025-05-12 14:27:28,665 - monthly_report - INFO - Successfully generated explanations for 1 items
2025-05-12 14:27:28,665 - monthly_report - INFO - Step 4: Getting report items for Perplexity context enrichment
2025-05-12 14:27:28,668 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:28,671 - monthly_report - INFO - Step 5: Getting additional context from Perplexity API for each report item
2025-05-12 14:27:28,672 - monthly_report - INFO - Getting additional context from Perplexity API for 1 report items
2025-05-12 14:27:28,672 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 💊 Drug Crime Incidents - District 5
Group: All
Recent Value: 191.0
Previous Value: 130.0
Percent Change: +46.92%
Explanation: The significant increase in drug crime incidents in District 5, with a 46.9% rise, is noteworthy as it represents a continuation of a broader trend of rising drug crimes citywide, which have increased by 44.7% year-to-date. This increase is significant in magnitude and public importance, as it highlights ongoing challenges in addressing drug-related issues in the district.
Detailed Analysis: EXPLANATION: The increase in 'Drug Crime Incidents - District 5' from 130 in March 2025 to 191 in April 2025, a 46.92% increase, can largely be attributed to specific anomalies observed in certain drug crime categories. Notably, the number of incidents related to 'Narcotics Paraphernalia, Possession of' spiked significantly, with an increase of 191.5% (from an average of 26.4 to 77 incidents) in April. Additionally, 'Controlled Substance Offense' incidents surged by 355.2% (from an average of 2.4 to 11 incidents). Conversely, 'Cocaine, Base/rock, Possession For Sale' saw a notable decrease of 73.9% (from an average of 19.1 to 5 incidents) during the same period. These anomalies significantly impacted the overall drug crime statistics in District 5 for April 2025. It's essential to consider these specific areas of increased activity to understand the dynamics affecting this surge in drug-related incidents. [CHART:anomaly:271837] [CHART:anomaly:271841] [CHART:anomaly:271838]


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:27:28,672 - monthly_report - INFO - Sending request to Perplexity API for 💊 Drug Crime Incidents - District 5
2025-05-12 14:27:34,840 - monthly_report - INFO - Successfully received response from Perplexity API for 💊 Drug Crime Incidents - District 5
2025-05-12 14:27:34,840 - monthly_report - INFO - Raw Perplexity response: {"id": "a2bf3097-6714-474d-93f6-e7f58ffc0987", "model": "sonar", "created": 1747085254, "usage": {"prompt_tokens": 539, "completion_tokens": 216, "total_tokens": 755, "search_context_size": "low"}, "citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://www.civichub.us/ca/san-francisco/gov/police-department/crime-data", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nRecent news highlights a significant spike in drug crime incidents across San Francisco, including District 5. The city has seen a 44.7% increase in drug crime incidents year-to-date, with a notable rise in n...
2025-05-12 14:27:34,840 - monthly_report - INFO - Found top-level citations: ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://www.civichub.us/ca/san-francisco/gov/police-department/crime-data", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"]
2025-05-12 14:27:34,840 - monthly_report - INFO - Added Perplexity response data to 💊 Drug Crime Incidents - District 5: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://www.civichub.us/ca/san-francisco/gov/police-department/crime-data", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"]}
2025-05-12 14:27:34,840 - monthly_report - INFO - Added Perplexity context to 💊 Drug Crime Incidents - District 5 (length: 1114)
2025-05-12 14:27:34,840 - monthly_report - INFO - Successfully retrieved additional context from Perplexity API for all items
2025-05-12 14:27:34,840 - monthly_report - INFO - Step 5.5: Updating database with Perplexity context
2025-05-12 14:27:34,844 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:34,844 - monthly_report - INFO - Updating perplexity_context for 💊 Drug Crime Incidents - District 5 - All (length: 1114)
2025-05-12 14:27:34,847 - monthly_report - INFO - Updated 1 records for perplexity_context (💊 Drug Crime Incidents - District 5 - All)
2025-05-12 14:27:34,847 - monthly_report - INFO - Updating perplexity_response for 💊 Drug Crime Incidents - District 5 - All: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:27:34,847 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:27:34,848 - monthly_report - INFO - Updated 1 records for perplexity_response (💊 Drug Crime Incidents - District 5 - All)
2025-05-12 14:27:34,848 - monthly_report - INFO - Verification successful! perplexity_response was stored for 💊 Drug Crime Incidents - District 5: {"citations": ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use...
2025-05-12 14:27:34,849 - monthly_report - INFO - Verification counts: 1 records with perplexity_context, 1 with perplexity_response
2025-05-12 14:27:34,849 - monthly_report - INFO - Updated 1 items with Perplexity context
2025-05-12 14:27:34,849 - monthly_report - INFO - Step 6: Generating monthly newsletter
2025-05-12 14:27:34,849 - monthly_report - INFO - Generating monthly report for district 5
2025-05-12 14:27:34,854 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:27:34,857 - monthly_report - INFO - Found 1 report items for date 2025-05-12 and district 5
2025-05-12 14:27:34,857 - monthly_report - INFO - Raw perplexity_citations for 💊 Drug Crime Incidents - District 5: ["https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://www.civichub.us/ca/s...
2025-05-12 14:27:34,857 - monthly_report - INFO - Formatted 5 citations for 💊 Drug Crime Incidents - District 5
2025-05-12 14:27:34,857 - monthly_report - INFO - Citation map: {"1": "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "2": "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "3": "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "4": "https://www.civichub.us/ca/san-francisco/gov/police-department/crime-data", "5": "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"}
2025-05-12 14:27:34,857 - monthly_report - INFO - Found citation references in context: ['1', '3', '5']
2025-05-12 14:27:34,857 - monthly_report - INFO - Making API call to generate report content
2025-05-12 14:27:47,012 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:27:47,024 - monthly_report - INFO - Received report content (length: 3465)
2025-05-12 14:27:47,027 - monthly_report - INFO - Monthly newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05.html
2025-05-12 14:27:47,028 - monthly_report - INFO - Step 7: Expanding chart references in the newsletter
2025-05-12 14:27:47,028 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05.html
2025-05-12 14:27:47,030 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05.html
2025-05-12 14:27:47,030 - monthly_report - INFO - Step 8: Proofreading and revising newsletter
2025-05-12 14:27:47,030 - monthly_report - INFO - Proofreading and revising newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05.html
2025-05-12 14:27:47,031 - monthly_report - INFO - Using AGENT_MODEL for proofreading
2025-05-12 14:28:33,940 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:28:33,947 - monthly_report - INFO - Expanding chart references in revised report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,947 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,948 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,952 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:33,960 - monthly_report - INFO - Updated report ID 126 with revised filename, proofread feedback, and headlines.
2025-05-12 14:28:33,960 - monthly_report - INFO - Revised newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,960 - monthly_report - INFO - Step 9: Generating email-compatible version of newsletter
2025-05-12 14:28:33,960 - monthly_report - INFO - Generating email-compatible version of report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,960 - monthly_report - INFO - Expanding chart references in report for email compatibility: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,960 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,960 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:33,961 - monthly_report - INFO - Found 4 potential iframe URLs to process.
2025-05-12 14:28:33,961 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271841#chart-section'
2025-05-12 14:28:33,961 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271841#chart-section'
2025-05-12 14:28:33,961 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271841#chart-section'
2025-05-12 14:28:33,961 - monthly_report - INFO - Requesting anomaly image for id=271841
2025-05-12 14:28:33,961 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271841'}
2025-05-12 14:28:33,983 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271841#chart-section
2025-05-12 14:28:35,269 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271841
2025-05-12 14:28:35,273 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:37,042 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:28:37,144 - monthly_report - INFO - Successfully captured chart image to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271841_1747085313.png using page.screenshot with clip
2025-05-12 14:28:37,166 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=271841#chart-section) with image: anomaly_271841_1747085313.png (1 occurrence(s))
2025-05-12 14:28:37,166 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=4&district=5&period_type=month#chart-section'
2025-05-12 14:28:37,166 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=4&district=5&period_type=month#chart-section'
2025-05-12 14:28:37,166 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=4&district=5&period_type=month#chart-section'
2025-05-12 14:28:37,166 - monthly_report - INFO - Requesting time-series image for metric=4, district=5, period=month
2025-05-12 14:28:37,166 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '4', 'district': '5', 'period_type': 'month'}
2025-05-12 14:28:37,166 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=4&district=5&period_type=month#chart-section
2025-05-12 14:28:38,217 - backend - INFO - Looking for chart with object_id=4, district=5, period_type=month, group_field=None, groups=None
2025-05-12 14:28:38,224 - backend - INFO - Available metrics in database: ['1', '9', '4', '8', '12', '10', '7', '17', '13', '15', '5', '14', '6', '3', '11', '2', '16']
2025-05-12 14:28:38,225 - backend - INFO - Available period types in database: ['year', 'month']
2025-05-12 14:28:38,226 - backend - INFO - Found 366 entries with object_id=4
2025-05-12 14:28:38,228 - backend - INFO - Found 25 data points for chart_id 4363
2025-05-12 14:28:38,228 - backend - INFO - Retrieved chart data for object_id: 4, district: 5, period_type: month, group_field: None
2025-05-12 14:28:39,910 - monthly_report - INFO - Original bounding box: {'x': 20, 'y': 20, 'width': 600, 'height': 600}
2025-05-12 14:28:40,012 - monthly_report - INFO - Successfully captured chart image to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_4_5_month_1747085317.png using page.screenshot with clip
2025-05-12 14:28:40,035 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=4&district=5&period_type=month#chart-section
2025-05-12 14:28:40,035 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271838#chart-section'
2025-05-12 14:28:40,035 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271838#chart-section'
2025-05-12 14:28:40,035 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271838#chart-section'
2025-05-12 14:28:40,035 - monthly_report - INFO - Requesting anomaly image for id=271838
2025-05-12 14:28:40,035 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271838'}
2025-05-12 14:28:40,036 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271838#chart-section
2025-05-12 14:28:40,943 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271838
2025-05-12 14:28:40,948 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:42,623 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:28:42,655 - monthly_report - INFO - Successfully captured chart image to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271838_1747085320.png using page.screenshot with clip
2025-05-12 14:28:42,677 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=271838#chart-section) with image: anomaly_271838_1747085320.png (1 occurrence(s))
2025-05-12 14:28:42,678 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271837#chart-section'
2025-05-12 14:28:42,678 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271837#chart-section'
2025-05-12 14:28:42,678 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271837#chart-section'
2025-05-12 14:28:42,678 - monthly_report - INFO - Requesting anomaly image for id=271837
2025-05-12 14:28:42,678 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271837'}
2025-05-12 14:28:42,678 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271837#chart-section
2025-05-12 14:28:43,712 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271837
2025-05-12 14:28:43,716 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:45,466 - monthly_report - INFO - Original bounding box: {'x': 61, 'y': 61, 'width': 558, 'height': 42}
2025-05-12 14:28:45,504 - monthly_report - INFO - Successfully captured chart image to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271837_1747085322.png using page.screenshot with clip
2025-05-12 14:28:45,532 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=271837#chart-section
2025-05-12 14:28:45,532 - monthly_report - INFO - Total iframe replacements made: 2
2025-05-12 14:28:45,532 - monthly_report - INFO - Generated email-compatible report at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised_email.html
2025-05-12 14:28:45,532 - monthly_report - INFO - Generated email-compatible newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised_email.html
2025-05-12 14:28:45,533 - monthly_report - INFO - Updated top_level.json for district 5 with revised report filename
2025-05-12 14:28:45,533 - monthly_report - INFO - Monthly newsletter process completed successfully
2025-05-12 14:28:45,533 - backend - INFO - Monthly report generated successfully: monthly_report_5_2025_05.html
2025-05-12 14:28:45,537 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:28:45,540 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:49,876 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:28:49,883 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:49,889 - backend - INFO - Requesting monthly report by ID: 126
2025-05-12 14:28:51,713 - backend - INFO - Requesting monthly report file: monthly_report_5_2025_05_revised_email.html
2025-05-12 14:28:51,713 - backend - INFO - get_monthly_report_file - script_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai
2025-05-12 14:28:51,713 - backend - INFO - get_monthly_report_file - reports_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports
2025-05-12 14:28:51,713 - backend - INFO - get_monthly_report_file - constructed file_path: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised_email.html
2025-05-12 14:28:51,713 - backend - INFO - Serving file: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised_email.html
2025-05-12 14:28:58,516 - backend - INFO - Requesting monthly report file: monthly_report_5_2025_05_revised.html
2025-05-12 14:28:58,516 - backend - INFO - get_monthly_report_file - script_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai
2025-05-12 14:28:58,516 - backend - INFO - get_monthly_report_file - reports_dir: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports
2025-05-12 14:28:58,516 - backend - INFO - get_monthly_report_file - constructed file_path: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:58,516 - backend - INFO - Serving file: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_5_2025_05_revised.html
2025-05-12 14:28:58,631 - backend - INFO - Looking for chart with object_id=4, district=5, period_type=month, group_field=None, groups=None
2025-05-12 14:28:58,638 - backend - INFO - Available metrics in database: ['1', '9', '4', '8', '12', '10', '7', '17', '13', '15', '5', '14', '6', '3', '11', '2', '16']
2025-05-12 14:28:58,639 - backend - INFO - Available period types in database: ['year', 'month']
2025-05-12 14:28:58,639 - backend - INFO - Found 366 entries with object_id=4
2025-05-12 14:28:58,640 - backend - INFO - Found 25 data points for chart_id 4363
2025-05-12 14:28:58,640 - backend - INFO - Retrieved chart data for object_id: 4, district: 5, period_type: month, group_field: None
2025-05-12 14:28:58,641 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271837
2025-05-12 14:28:58,644 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:58,647 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271841
2025-05-12 14:28:58,650 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:28:58,652 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271838
2025-05-12 14:28:58,654 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:29:32,256 - backend - INFO - Newsletter published successfully. URL: https://newsletter.transparentsf.com/p/c4bd9a0b-2078-4cc6-99ef-8c4cc632ab72/
2025-05-12 14:29:32,267 - backend - INFO - Updated report ID 126 with published URL: https://newsletter.transparentsf.com/p/c4bd9a0b-2078-4cc6-99ef-8c4cc632ab72/
2025-05-12 14:29:32,292 - backend - INFO - Requesting monthly report by ID: 126
2025-05-12 14:32:27,258 - monthly_report - INFO - Monthly report logging initialized with level: INFO
2025-05-12 14:32:27,258 - monthly_report - INFO - Environment variables (excluding sensitive data): {'POSTGRES_PORT': '5432', 'POSTGRES_DB': 'transparentsf', 'POSTGRES_USER': 'postgres', 'POSTGRES_HOST': 'localhost'}
2025-05-12 14:32:27,258 - monthly_report - INFO - Using database connection parameters: HOST=localhost, PORT=5432, USER=postgres, DB=transparentsf
2025-05-12 14:32:27,258 - monthly_report - INFO - Using API_BASE_URL: http://localhost:8000
2025-05-12 14:32:27,259 - monthly_report - INFO - Perplexity API key found
2025-05-12 14:32:27,259 - monthly_report - INFO - Starting monthly newsletter process for district 6
2025-05-12 14:32:27,259 - monthly_report - INFO - Step 0: Initializing monthly_reporting table
2025-05-12 14:32:27,259 - monthly_report - INFO - Initializing tables for monthly reporting
2025-05-12 14:32:27,276 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:32:27,276 - monthly_report - INFO - Checking if reports table exists...
2025-05-12 14:32:27,280 - monthly_report - INFO - Reports table already exists
2025-05-12 14:32:27,290 - monthly_report - INFO - Table monthly_reporting exists with columns: ['id', 'report_id', 'object_id', 'item_title', 'explanation', 'report_text', 'created_at', 'updated_at', 'report_date', 'metric_name', 'group_value', 'group_field_name', 'period_type', 'comparison_mean', 'recent_mean', 'difference', 'std_dev', 'percent_change', 'priority', 'district', 'chart_data', 'metadata', 'metric_id']
2025-05-12 14:32:27,290 - monthly_report - INFO - Table monthly_reporting already has all required columns
2025-05-12 14:32:27,291 - monthly_report - INFO - Step 1: Selecting deltas to discuss
2025-05-12 14:32:27,291 - monthly_report - INFO - Selecting top 20 and bottom 20 deltas for monthly report
2025-05-12 14:32:27,291 - monthly_report - INFO - Requesting top changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=6&show_both=false
2025-05-12 14:32:27,293 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=6
2025-05-12 14:32:27,297 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '6']
2025-05-12 14:32:27,298 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:32:27,300 - anomalyAnalyzer - INFO - Processing chart_id 2900 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,300 - anomalyAnalyzer - INFO - Executing data query for chart 2900 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,301 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2900
2025-05-12 14:32:27,301 - anomalyAnalyzer - INFO - Result for chart 2900: 👮 Total Police Incidents - District 6 - Previous: 1539.0 (2025-03-31), Recent: 1420.0 (2025-04-30), Delta: -119.0
2025-05-12 14:32:27,302 - anomalyAnalyzer - INFO - Processing chart_id 2956 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,302 - anomalyAnalyzer - INFO - Executing data query for chart 2956 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,302 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2956
2025-05-12 14:32:27,302 - anomalyAnalyzer - INFO - Result for chart 2956: 🚨 Violent Crime Incidents - District 6 - Previous: 182.0 (2025-03-31), Recent: 174.0 (2025-04-30), Delta: -8.0
2025-05-12 14:32:27,303 - anomalyAnalyzer - INFO - Processing chart_id 3017 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,303 - anomalyAnalyzer - INFO - Executing data query for chart 3017 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,303 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3017
2025-05-12 14:32:27,303 - anomalyAnalyzer - INFO - Result for chart 3017: 🏠 Property Crime Incidents - District 6 - Previous: 440.0 (2025-03-31), Recent: 419.0 (2025-04-30), Delta: -21.0
2025-05-12 14:32:27,304 - anomalyAnalyzer - INFO - Processing chart_id 3048 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,304 - anomalyAnalyzer - INFO - Executing data query for chart 3048 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,304 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3048
2025-05-12 14:32:27,304 - anomalyAnalyzer - INFO - Result for chart 3048: 💊 Drug Crime Incidents - District 6 - Previous: 197.0 (2025-03-31), Recent: 183.0 (2025-04-30), Delta: -14.0
2025-05-12 14:32:27,305 - anomalyAnalyzer - INFO - Processing chart_id 3138 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,305 - anomalyAnalyzer - INFO - Executing data query for chart 3138 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3138
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Result for chart 3138: 🚒 Fire Incidents YTD - District 6 - Previous: 456.0 (2025-03-31), Recent: 361.0 (2025-04-30), Delta: -95.0
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Processing chart_id 3168 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Executing data query for chart 3168 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3168
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Result for chart 3168: 💔 Fire Fatalities YTD - District 6 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Processing chart_id 3183 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,306 - anomalyAnalyzer - INFO - Executing data query for chart 3183 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,307 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3183
2025-05-12 14:32:27,307 - anomalyAnalyzer - INFO - Result for chart 3183: 🚑 911 Response (minutes) - Danger to life - District 6 - Previous: 11.476195578121924 (2025-03-31), Recent: 14.937836745756679 (2025-04-30), Delta: 3.4616411676347543
2025-05-12 14:32:27,307 - anomalyAnalyzer - INFO - Processing chart_id 3212 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,307 - anomalyAnalyzer - INFO - Executing data query for chart 3212 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3212
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Result for chart 3212: 🚑 911 Response (minutes) - Danger to property  - District 6 - Previous: 59.9508489722967 (2025-03-31), Recent: 58.494644595910415 (2025-04-30), Delta: -1.4562043763862818
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Processing chart_id 3225 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Executing data query for chart 3225 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3225
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Result for chart 3225: 🚑 911 Response (minutes) - No danger to life or property - District 6 - Previous: 124.15307486631016 (2025-03-31), Recent: 115.87835186396336 (2025-04-30), Delta: -8.274723002346803
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Processing chart_id 3248 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,308 - anomalyAnalyzer - INFO - Executing data query for chart 3248 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3248
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Result for chart 3248: 🏢 New Business Registrations - District 6 - Previous: 79.0 (2025-03-31), Recent: 76.0 (2025-04-30), Delta: -3.0
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Processing chart_id 3289 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Executing data query for chart 3289 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3289
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Result for chart 3289: 🚫 Business Closures - District 6 - Previous: 36.0 (2025-03-31), Recent: 19.0 (2025-04-30), Delta: -17.0
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Processing chart_id 3322 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,309 - anomalyAnalyzer - INFO - Executing data query for chart 3322 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3322
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Result for chart 3322: 🛍️ New Retail Registrations - District 6 - Previous: 12.0 (2025-03-31), Recent: 10.0 (2025-04-30), Delta: -2.0
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Processing chart_id 4210 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Executing data query for chart 4210 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4210
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Result for chart 4210: 👮 Total Police Incidents - Previous: 1540.0 (2025-03-31), Recent: 1440.0 (2025-04-30), Delta: -100.0
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Processing chart_id 4327 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,310 - anomalyAnalyzer - INFO - Executing data query for chart 4327 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4327
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Result for chart 4327: 🏠 Property Crime Incidents - Previous: 440.0 (2025-03-31), Recent: 433.0 (2025-04-30), Delta: -7.0
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Processing chart_id 4358 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Executing data query for chart 4358 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4358
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Result for chart 4358: 💊 Drug Crime Incidents - Previous: 197.0 (2025-03-31), Recent: 183.0 (2025-04-30), Delta: -14.0
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Processing chart_id 4448 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,311 - anomalyAnalyzer - INFO - Executing data query for chart 4448 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,312 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4448
2025-05-12 14:32:27,312 - anomalyAnalyzer - INFO - Result for chart 4448: 🚒 Fire Incidents YTD - Previous: 462.0 (2025-03-31), Recent: 379.0 (2025-04-30), Delta: -83.0
2025-05-12 14:32:27,312 - anomalyAnalyzer - INFO - Processing chart_id 4493 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,312 - anomalyAnalyzer - INFO - Executing data query for chart 4493 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4493
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Result for chart 4493: 🚑 911 Response (minutes) - Danger to life - Previous: 11.476195578121924 (2025-03-31), Recent: 14.937836745756679 (2025-04-30), Delta: 3.4616411676347543
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Processing chart_id 4478 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Executing data query for chart 4478 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4478
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Result for chart 4478: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Processing chart_id 4522 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,313 - anomalyAnalyzer - INFO - Executing data query for chart 4522 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4522
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Result for chart 4522: 🚑 911 Response (minutes) - Danger to property  - Previous: 59.9508489722967 (2025-03-31), Recent: 58.494644595910415 (2025-04-30), Delta: -1.4562043763862818
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Processing chart_id 4535 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Executing data query for chart 4535 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4535
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Result for chart 4535: 🚑 911 Response (minutes) - No danger to life or property - Previous: 124.15307486631016 (2025-03-31), Recent: 115.87835186396336 (2025-04-30), Delta: -8.274723002346803
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Processing chart_id 4620 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,314 - anomalyAnalyzer - INFO - Executing data query for chart 4620 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4620
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Result for chart 4620: 🛍️ New Retail Registrations - Previous: 12.0 (2025-03-31), Recent: 10.0 (2025-04-30), Delta: -2.0
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Processing chart_id 4653 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Executing data query for chart 4653 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4653
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Result for chart 4653: 🏢 New Business Registrations - Previous: 80.0 (2025-03-31), Recent: 80.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Processing chart_id 4686 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Executing data query for chart 4686 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4686
2025-05-12 14:32:27,315 - anomalyAnalyzer - INFO - Result for chart 4686: 🚫 Business Closures - Previous: 44.0 (2025-03-31), Recent: 25.0 (2025-04-30), Delta: -19.0
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Processing chart_id 4741 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Executing data query for chart 4741 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4741
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Result for chart 4741: 🚨 Violent Crime Incidents - Previous: 183.0 (2025-03-31), Recent: 174.0 (2025-04-30), Delta: -9.0
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 6 - Delta: -119.0, Percent Change: -7.732293697205978
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 6 - Delta: -8.0, Percent Change: -4.395604395604396
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 6 - Delta: -21.0, Percent Change: -4.772727272727273
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Split results: 2 positive, 19 negative, 3 zero/null
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Top 0: 🚑 911 Response (minutes) - Danger to life - District 6 - Percent Change: 30.163664814444115%
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Top 1: 🚑 911 Response (minutes) - Danger to life - Percent Change: 30.163664814444115%
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Bottom 0: 🚫 Business Closures - District 6 - Percent Change: -47.22222222222222%
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Bottom 1: 🚫 Business Closures - Percent Change: -43.18181818181818%
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Bottom 2: 🚒 Fire Incidents YTD - District 6 - Percent Change: -20.833333333333336%
2025-05-12 14:32:27,316 - anomalyAnalyzer - INFO - Found 2 top results and 20 bottom results
2025-05-12 14:32:27,317 - monthly_report - INFO - Top changes API response status code: 200
2025-05-12 14:32:27,317 - monthly_report - INFO - Received top changes data: {"status": "success", "count": 22, "period_type": "month", "object_id": null, "district": "6", "top_results": [{"group_value": null, "recent_value": 14.937836745756679, "previous_value": 11.4761955781...
2025-05-12 14:32:27,317 - monthly_report - INFO - Top data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:32:27,317 - monthly_report - INFO - Top results count: 2
2025-05-12 14:32:27,317 - monthly_report - INFO - Sample top result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:32:27,317 - monthly_report - INFO - Sample top result item: {"group_value": null, "recent_value": 14.937836745756679, "previous_value": 11.476195578121924, "delta": 3.4616411676347543, "abs_delta": 3.4616411676347543, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3183, "object_id": "10", "object_name": "\ud83d\ude91 911 Response (minutes) - Danger to life - District 6", "group_field": null, "district": "6", "percent_change": 30.163664814444115}
2025-05-12 14:32:27,317 - monthly_report - INFO - Requesting bottom changes from: http://localhost:8000/anomaly-analyzer/api/top-metric-changes?period_type=month&limit=20&district=6&show_both=false&negative=true
2025-05-12 14:32:27,319 - anomalyAnalyzer - INFO - get_top_metric_changes called with: period_type=month, limit=20, object_id=None, district=6
2025-05-12 14:32:27,322 - anomalyAnalyzer - INFO - Chart query: 
        SELECT chart_id, object_name, group_field, object_id
        FROM time_series_metadata
        WHERE period_type = %s AND district = %s AND group_field IS NULL AND is_active = TRUE
         with params: ['month', '6']
2025-05-12 14:32:27,324 - anomalyAnalyzer - INFO - Found 24 charts with null group_field
2025-05-12 14:32:27,325 - anomalyAnalyzer - INFO - Processing chart_id 2900 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,325 - anomalyAnalyzer - INFO - Executing data query for chart 2900 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,325 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2900
2025-05-12 14:32:27,325 - anomalyAnalyzer - INFO - Result for chart 2900: 👮 Total Police Incidents - District 6 - Previous: 1539.0 (2025-03-31), Recent: 1420.0 (2025-04-30), Delta: -119.0
2025-05-12 14:32:27,325 - anomalyAnalyzer - INFO - Processing chart_id 2956 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Executing data query for chart 2956 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 2956
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Result for chart 2956: 🚨 Violent Crime Incidents - District 6 - Previous: 182.0 (2025-03-31), Recent: 174.0 (2025-04-30), Delta: -8.0
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Processing chart_id 3017 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Executing data query for chart 3017 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3017
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Result for chart 3017: 🏠 Property Crime Incidents - District 6 - Previous: 440.0 (2025-03-31), Recent: 419.0 (2025-04-30), Delta: -21.0
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Processing chart_id 3048 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,326 - anomalyAnalyzer - INFO - Executing data query for chart 3048 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3048
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Result for chart 3048: 💊 Drug Crime Incidents - District 6 - Previous: 197.0 (2025-03-31), Recent: 183.0 (2025-04-30), Delta: -14.0
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Processing chart_id 3138 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Executing data query for chart 3138 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3138
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Result for chart 3138: 🚒 Fire Incidents YTD - District 6 - Previous: 456.0 (2025-03-31), Recent: 361.0 (2025-04-30), Delta: -95.0
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Processing chart_id 3168 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,327 - anomalyAnalyzer - INFO - Executing data query for chart 3168 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3168
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Result for chart 3168: 💔 Fire Fatalities YTD - District 6 - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Processing chart_id 3183 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Executing data query for chart 3183 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3183
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Result for chart 3183: 🚑 911 Response (minutes) - Danger to life - District 6 - Previous: 11.476195578121924 (2025-03-31), Recent: 14.937836745756679 (2025-04-30), Delta: 3.4616411676347543
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Processing chart_id 3212 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,328 - anomalyAnalyzer - INFO - Executing data query for chart 3212 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3212
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Result for chart 3212: 🚑 911 Response (minutes) - Danger to property  - District 6 - Previous: 59.9508489722967 (2025-03-31), Recent: 58.494644595910415 (2025-04-30), Delta: -1.4562043763862818
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Processing chart_id 3225 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Executing data query for chart 3225 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3225
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Result for chart 3225: 🚑 911 Response (minutes) - No danger to life or property - District 6 - Previous: 124.15307486631016 (2025-03-31), Recent: 115.87835186396336 (2025-04-30), Delta: -8.274723002346803
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Processing chart_id 3248 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,329 - anomalyAnalyzer - INFO - Executing data query for chart 3248 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3248
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Result for chart 3248: 🏢 New Business Registrations - District 6 - Previous: 79.0 (2025-03-31), Recent: 76.0 (2025-04-30), Delta: -3.0
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Processing chart_id 3289 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Executing data query for chart 3289 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3289
2025-05-12 14:32:27,330 - anomalyAnalyzer - INFO - Result for chart 3289: 🚫 Business Closures - District 6 - Previous: 36.0 (2025-03-31), Recent: 19.0 (2025-04-30), Delta: -17.0
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Processing chart_id 3322 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Executing data query for chart 3322 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 3322
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Result for chart 3322: 🛍️ New Retail Registrations - District 6 - Previous: 12.0 (2025-03-31), Recent: 10.0 (2025-04-30), Delta: -2.0
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Processing chart_id 4210 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Executing data query for chart 4210 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4210
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Result for chart 4210: 👮 Total Police Incidents - Previous: 1540.0 (2025-03-31), Recent: 1440.0 (2025-04-30), Delta: -100.0
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Processing chart_id 4327 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,331 - anomalyAnalyzer - INFO - Executing data query for chart 4327 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4327
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Result for chart 4327: 🏠 Property Crime Incidents - Previous: 440.0 (2025-03-31), Recent: 433.0 (2025-04-30), Delta: -7.0
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Processing chart_id 4358 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Executing data query for chart 4358 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4358
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Result for chart 4358: 💊 Drug Crime Incidents - Previous: 197.0 (2025-03-31), Recent: 183.0 (2025-04-30), Delta: -14.0
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Processing chart_id 4448 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Executing data query for chart 4448 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4448
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Result for chart 4448: 🚒 Fire Incidents YTD - Previous: 462.0 (2025-03-31), Recent: 379.0 (2025-04-30), Delta: -83.0
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Processing chart_id 4493 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,332 - anomalyAnalyzer - INFO - Executing data query for chart 4493 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4493
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Result for chart 4493: 🚑 911 Response (minutes) - Danger to life - Previous: 11.476195578121924 (2025-03-31), Recent: 14.937836745756679 (2025-04-30), Delta: 3.4616411676347543
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Processing chart_id 4478 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Executing data query for chart 4478 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4478
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Result for chart 4478: 💔 Fire Fatalities YTD - Previous: 0.0 (2025-03-31), Recent: 0.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Processing chart_id 4522 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Executing data query for chart 4522 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4522
2025-05-12 14:32:27,333 - anomalyAnalyzer - INFO - Result for chart 4522: 🚑 911 Response (minutes) - Danger to property  - Previous: 59.9508489722967 (2025-03-31), Recent: 58.494644595910415 (2025-04-30), Delta: -1.4562043763862818
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Processing chart_id 4535 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Executing data query for chart 4535 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4535
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Result for chart 4535: 🚑 911 Response (minutes) - No danger to life or property - Previous: 124.15307486631016 (2025-03-31), Recent: 115.87835186396336 (2025-04-30), Delta: -8.274723002346803
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Processing chart_id 4620 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Executing data query for chart 4620 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4620
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Result for chart 4620: 🛍️ New Retail Registrations - Previous: 12.0 (2025-03-31), Recent: 10.0 (2025-04-30), Delta: -2.0
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Processing chart_id 4653 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Executing data query for chart 4653 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,334 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4653
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result for chart 4653: 🏢 New Business Registrations - Previous: 80.0 (2025-03-31), Recent: 80.0 (2025-04-30), Delta: 0.0
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Processing chart_id 4686 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Executing data query for chart 4686 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4686
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result for chart 4686: 🚫 Business Closures - Previous: 44.0 (2025-03-31), Recent: 25.0 (2025-04-30), Delta: -19.0
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Processing chart_id 4741 - comparing periods 2025-04-30 and 2025-03-31
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Executing data query for chart 4741 comparing 2025-04-30 to 2025-03-31
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Found 1 comparison rows for chart_id 4741
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result for chart 4741: 🚨 Violent Crime Incidents - Previous: 183.0 (2025-03-31), Recent: 174.0 (2025-04-30), Delta: -9.0
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Total valid results after filtering: 24
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Unsorted results sample:
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result 0: 👮 Total Police Incidents - District 6 - Delta: -119.0, Percent Change: -7.732293697205978
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result 1: 🚨 Violent Crime Incidents - District 6 - Delta: -8.0, Percent Change: -4.395604395604396
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Result 2: 🏠 Property Crime Incidents - District 6 - Delta: -21.0, Percent Change: -4.772727272727273
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Split results: 2 positive, 19 negative, 3 zero/null
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Top results after sorting by percent change:
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Top 0: 🚑 911 Response (minutes) - Danger to life - District 6 - Percent Change: 30.163664814444115%
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Top 1: 🚑 911 Response (minutes) - Danger to life - Percent Change: 30.163664814444115%
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Bottom results after sorting by percent change:
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Bottom 0: 🚫 Business Closures - District 6 - Percent Change: -47.22222222222222%
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Bottom 1: 🚫 Business Closures - Percent Change: -43.18181818181818%
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Bottom 2: 🚒 Fire Incidents YTD - District 6 - Percent Change: -20.833333333333336%
2025-05-12 14:32:27,335 - anomalyAnalyzer - INFO - Found 2 top results and 20 bottom results
2025-05-12 14:32:27,336 - monthly_report - INFO - Bottom changes API response status code: 200
2025-05-12 14:32:27,336 - monthly_report - INFO - Received bottom changes data: {"status": "success", "count": 22, "period_type": "month", "object_id": null, "district": "6", "top_results": [{"group_value": null, "recent_value": 14.937836745756679, "previous_value": 11.4761955781...
2025-05-12 14:32:27,336 - monthly_report - INFO - Bottom data keys: ['status', 'count', 'period_type', 'object_id', 'district', 'top_results', 'bottom_results']
2025-05-12 14:32:27,336 - monthly_report - INFO - Bottom results count: 20
2025-05-12 14:32:27,336 - monthly_report - INFO - Sample bottom result item keys: ['group_value', 'recent_value', 'previous_value', 'delta', 'abs_delta', 'recent_period', 'previous_period', 'chart_id', 'object_id', 'object_name', 'group_field', 'district', 'percent_change']
2025-05-12 14:32:27,336 - monthly_report - INFO - Sample bottom result item: {"group_value": null, "recent_value": 19.0, "previous_value": 36.0, "delta": -17.0, "abs_delta": 17.0, "recent_period": "2025-04-30", "previous_period": "2025-03-31", "chart_id": 3289, "object_id": "15", "object_name": "\ud83d\udeab Business Closures - District 6", "group_field": null, "district": "6", "percent_change": -47.22222222222222}
2025-05-12 14:32:27,336 - monthly_report - INFO - Found 2 top changes and 20 bottom changes
2025-05-12 14:32:27,336 - monthly_report - INFO - Step 2: Prioritizing deltas
2025-05-12 14:32:27,337 - monthly_report - INFO - Prioritizing deltas for discussion (max 3 items)
2025-05-12 14:32:27,339 - webChat - INFO - 
Notes loading complete:
Districts processed: 12
Total combined length: 15871 characters
First 100 characters: 
================================================================================
Citywide Metrics S

2025-05-12 14:32:27,339 - webChat - INFO - Successfully saved notes to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/notes/combined_notes.txt
2025-05-12 14:32:27,339 - monthly_report - INFO - Loaded 15871 characters of combined notes for context
2025-05-12 14:32:27,339 - monthly_report - INFO - Loading prompts from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/data/prompts.json
2025-05-12 14:32:27,339 - monthly_report - INFO - Successfully loaded prompts with keys: ['monthly_report']
2025-05-12 14:32:32,230 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:32,232 - monthly_report - INFO - Received JSON response of length: 1352
2025-05-12 14:32:32,232 - monthly_report - INFO - Parsed JSON: {"items": [{"index": 1, "metric": "\ud83d\ude91 911 Response (minutes) - Danger to life - District 6 for All", "metric_id": "10", "group": "District 6", "priority": 1, "explanation": "The 911 response...
2025-05-12 14:32:32,232 - monthly_report - INFO - Found items under key: items
2025-05-12 14:32:32,232 - monthly_report - INFO - Extracted 3 items from JSON
2025-05-12 14:32:32,233 - monthly_report - INFO -   Item 1: {"index": 1, "metric": "\ud83d\ude91 911 Response (minutes) - Danger to life - District 6 for All", ...
2025-05-12 14:32:32,233 - monthly_report - INFO -   Item 2: {"index": 4, "metric": "\ud83d\udeab Business Closures for All", "metric_id": "15", "group": "Distri...
2025-05-12 14:32:32,233 - monthly_report - INFO -   Item 3: {"index": 11, "metric": "\ud83d\udc8a Drug Crime Incidents for All", "metric_id": "4", "group": "Dis...
2025-05-12 14:32:32,233 - monthly_report - INFO - Found original data for item index 1: 🚑 911 Response (minutes) - Danger to life - District 6
2025-05-12 14:32:32,233 - monthly_report - INFO - Found original data for item index 4: 🚫 Business Closures
2025-05-12 14:32:32,233 - monthly_report - INFO - Found original data for item index 11: 💊 Drug Crime Incidents
2025-05-12 14:32:32,233 - monthly_report - INFO - Prioritized item: 🚑 911 Response (minutes) - Danger to life - District 6 - All (Priority: 1)
2025-05-12 14:32:32,233 - monthly_report - INFO -   Explanation length: 296
2025-05-12 14:32:32,233 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:32:32,233 - monthly_report - INFO - Prioritized item: 🚫 Business Closures - All (Priority: 2)
2025-05-12 14:32:32,233 - monthly_report - INFO -   Explanation length: 225
2025-05-12 14:32:32,233 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:32:32,233 - monthly_report - INFO - Prioritized item: 💊 Drug Crime Incidents - All (Priority: 3)
2025-05-12 14:32:32,233 - monthly_report - INFO -   Explanation length: 242
2025-05-12 14:32:32,233 - monthly_report - INFO -   Trend analysis: ...
2025-05-12 14:32:32,233 - monthly_report - INFO - Prioritized 3 items for the report
2025-05-12 14:32:32,233 - monthly_report - INFO - Step 2.5: Storing prioritized items
2025-05-12 14:32:32,233 - monthly_report - INFO - Storing 3 prioritized items in the database
2025-05-12 14:32:32,237 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:32:32,238 - monthly_report - INFO - Created report record with ID: 127
2025-05-12 14:32:32,238 - monthly_report - INFO - Storing item: 🚑 911 Response (minutes) - Danger to life - District 6 - Priority: 1
2025-05-12 14:32:32,238 - monthly_report - INFO -   Explanation: 'The 911 response time for danger to life in Distri...' (length: 296)
2025-05-12 14:32:32,238 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:32:32,240 - monthly_report - INFO - Stored item with ID 261, explanation length in DB: 296
2025-05-12 14:32:32,240 - monthly_report - INFO - Storing item: 🚫 Business Closures - Priority: 2
2025-05-12 14:32:32,240 - monthly_report - INFO -   Explanation: 'Business closures have decreased by 43.2% in Distr...' (length: 225)
2025-05-12 14:32:32,240 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:32:32,240 - monthly_report - INFO - Stored item with ID 262, explanation length in DB: 225
2025-05-12 14:32:32,240 - monthly_report - INFO - Storing item: 💊 Drug Crime Incidents - Priority: 3
2025-05-12 14:32:32,240 - monthly_report - INFO -   Explanation: 'Drug crime incidents have decreased by 7.1% in Dis...' (length: 242)
2025-05-12 14:32:32,240 - monthly_report - INFO -   Trend analysis: '...'
2025-05-12 14:32:32,240 - monthly_report - INFO - Stored item with ID 263, explanation length in DB: 242
2025-05-12 14:32:32,241 - monthly_report - INFO - Successfully stored 3 items in the database
2025-05-12 14:32:32,241 - monthly_report - INFO - Step 3: Generating explanations
2025-05-12 14:32:32,241 - monthly_report - INFO - Generating explanations for 3 items
2025-05-12 14:32:32,244 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:32:32,245 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:32:32,245 - monthly_report - INFO - Generating explanation for report_id=261, metric=🚑 911 Response (minutes) - Danger to life - District 6 (ID: 10), group=All
2025-05-12 14:32:32,245 - monthly_report - INFO -   Values: recent=14.937836745756679, comparison=11.476195578121924, diff=3.4616411676347543, percent_change=30.163664814444115
2025-05-12 14:32:32,245 - monthly_report - INFO -   Period: month, District: 6
2025-05-12 14:32:32,245 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚑 911 Response (minutes) - Danger to life - District 6' (ID: 10)  increased from 11.476195578121924 to 14.937836745756679 (30.16%) between March 2025 and April 2025 for ...
2025-05-12 14:32:32,246 - monthly_report - INFO - Running explainer agent for metric: 10
2025-05-12 14:32:33,234 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:33,241 - webChat - INFO - 
=== get_notes called ===
Total length: 15869 characters
Approximate tokens: 2639
First 100 chars: ================================================================================
Citywide Metrics Su
Number of lines: 291

2025-05-12 14:32:34,961 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:34,962 - webChat - INFO - 
=== query_anomalies_db called ===
Parameters:
- query_type: by_metric_id
- limit: 30
- group_filter: None
- date_start: None
- date_end: None
- only_anomalies: True
- metric_name: None
- district_filter: 6
- metric_id: 10
- period_type: month

2025-05-12 14:32:34,962 - webChat - INFO - Using database connection: localhost:5432/transparentsf (user: postgres)
2025-05-12 14:32:34,962 - webChat - INFO - Using query_type 'by_metric_id' with metric_id=10
2025-05-12 14:32:34,962 - webChat - INFO - Calling get_anomalies with query_type=by_metric_id, limit=30
2025-05-12 14:32:34,962 - webChat - INFO - Additional filters: group_filter=None, date_start=None, date_end=None, only_anomalies=True, metric_name=None, district_filter=6, metric_id=10, period_type=month
2025-05-12 14:32:34,967 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:32:34,970 - webChat - INFO - get_anomalies query completed in 0.01 seconds
2025-05-12 14:32:34,970 - webChat - INFO - get_anomalies returned 2 results
2025-05-12 14:32:34,970 - webChat - INFO - Processed 2 results in 0.00 seconds
2025-05-12 14:32:34,970 - webChat - INFO - Returning 2 results for query_type=by_metric_id
2025-05-12 14:32:34,970 - webChat - INFO - Looking for dashboard data in: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard
2025-05-12 14:32:34,970 - webChat - INFO - Fetching specific metric '10.json' for district 6 from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/10.json
2025-05-12 14:32:34,972 - webChat - INFO - Using metric_id as a number: 10
2025-05-12 14:32:34,972 - webChat - INFO - Looking for monthly analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/monthly/6/10.md
2025-05-12 14:32:34,972 - webChat - INFO - Looking for annual analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/annual/6/10.md
2025-05-12 14:32:34,972 - webChat - INFO - Found monthly analysis file (9404 chars)
2025-05-12 14:32:34,973 - webChat - INFO - Found annual analysis file (5589 chars)
2025-05-12 14:32:34,973 - webChat - INFO - Added analysis content with keys: ['monthly_analysis', 'annual_analysis']
2025-05-12 14:32:34,973 - webChat - INFO - Successfully retrieved dashboard metric data from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/10.json
2025-05-12 14:32:45,322 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:45,326 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:32:45,326 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:32:45,326 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:32:45,326 - monthly_report - INFO - Response has messages attribute with 6 messages
2025-05-12 14:32:45,326 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:32:45,326 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The significant increase in the '🚑 911 Response (minutes) - Danger to life - District 6...
2025-05-12 14:32:45,326 - monthly_report - INFO - Final explanation to be stored for 🚑 911 Response (minutes) - Danger to life - District 6 (length: 1254): EXPLANATION: The significant increase in the '🚑 911 Response (minutes) - Danger to life - District 6' metric from March 2025 to April 2025 can be primarily attributed to a dramatic rise in average res...
2025-05-12 14:32:45,327 - monthly_report - INFO - Updated explanation for report ID 261
2025-05-12 14:32:45,327 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:32:45,327 - monthly_report - INFO - Generating explanation for report_id=262, metric=🚫 Business Closures (ID: 15), group=All
2025-05-12 14:32:45,327 - monthly_report - INFO -   Values: recent=25.0, comparison=44.0, diff=-19.0, percent_change=-43.18181818181818
2025-05-12 14:32:45,327 - monthly_report - INFO -   Period: month, District: 6
2025-05-12 14:32:45,327 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '🚫 Business Closures' (ID: 15)  decreased from 44.0 to 25.0 (43.18%) between March 2025 and April 2025 for district 6.

Use the available tools to research this change an...
2025-05-12 14:32:45,327 - monthly_report - INFO - Running explainer agent for metric: 15
2025-05-12 14:32:47,206 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:47,209 - webChat - INFO - 
=== query_anomalies_db called ===
Parameters:
- query_type: by_metric_id
- limit: 30
- group_filter: None
- date_start: None
- date_end: None
- only_anomalies: True
- metric_name: None
- district_filter: 6
- metric_id: 15
- period_type: month

2025-05-12 14:32:47,209 - webChat - INFO - Using database connection: localhost:5432/transparentsf (user: postgres)
2025-05-12 14:32:47,209 - webChat - INFO - Using query_type 'by_metric_id' with metric_id=15
2025-05-12 14:32:47,209 - webChat - INFO - Calling get_anomalies with query_type=by_metric_id, limit=30
2025-05-12 14:32:47,209 - webChat - INFO - Additional filters: group_filter=None, date_start=None, date_end=None, only_anomalies=True, metric_name=None, district_filter=6, metric_id=15, period_type=month
2025-05-12 14:32:47,212 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:32:47,216 - webChat - INFO - get_anomalies query completed in 0.01 seconds
2025-05-12 14:32:47,216 - webChat - INFO - get_anomalies returned 0 results
2025-05-12 14:32:47,216 - webChat - INFO - Processed 0 results in 0.00 seconds
2025-05-12 14:32:47,216 - webChat - INFO - Returning 0 results for query_type=by_metric_id
2025-05-12 14:32:47,216 - webChat - INFO - Looking for dashboard data in: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard
2025-05-12 14:32:47,216 - webChat - INFO - Fetching specific metric '15.json' for district 6 from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/15.json
2025-05-12 14:32:47,217 - webChat - INFO - Using metric_id as a number: 15
2025-05-12 14:32:47,217 - webChat - INFO - Looking for monthly analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/monthly/6/15.md
2025-05-12 14:32:47,217 - webChat - INFO - Looking for annual analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/annual/6/15.md
2025-05-12 14:32:47,217 - webChat - INFO - Found monthly analysis file (12105 chars)
2025-05-12 14:32:47,218 - webChat - INFO - Found annual analysis file (9232 chars)
2025-05-12 14:32:47,218 - webChat - INFO - Added analysis content with keys: ['monthly_analysis', 'annual_analysis']
2025-05-12 14:32:47,218 - webChat - INFO - Successfully retrieved dashboard metric data from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/15.json
2025-05-12 14:32:54,757 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:32:54,759 - tools.data_fetcher - INFO - === Starting set_dataset ===
2025-05-12 14:32:54,759 - tools.data_fetcher - INFO - Args received: ()
2025-05-12 14:32:54,759 - tools.data_fetcher - INFO - Kwargs received: {
  "args": "{}",
  "kwargs": {
    "endpoint": "g8m3-pdis",
    "query": "SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC"
  }
}
2025-05-12 14:32:54,759 - tools.data_fetcher - INFO - Context variables keys: ['dataset', 'notes']
2025-05-12 14:32:54,759 - tools.data_fetcher - INFO - Added .json to endpoint: g8m3-pdis.json
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Final parameters - Endpoint: g8m3-pdis.json, Query: SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Starting fetch_data_from_api with query_object: {
  "endpoint": "g8m3-pdis.json",
  "query": "SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC"
}
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Processing endpoint: g8m3-pdis.json
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Initial query string: SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - After clean_query_string: SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Final cleaned query: SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Full API URL: https://data.sfgov.org/resource/g8m3-pdis.json
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Request parameters: {
  "$query": "SELECT dba_name, full_business_address, dba_end_date, naic_code_description WHERE supervisor_district = '6' AND dba_end_date BETWEEN '2025-03-01' AND '2025-04-30' AND administratively_closed is null ORDER BY dba_end_date DESC"
}
2025-05-12 14:32:54,760 - tools.data_fetcher - INFO - Request headers: {
  "Accept": "application/json"
}
2025-05-12 14:32:55,300 - tools.data_fetcher - INFO - Fetched 69 records in current batch.
2025-05-12 14:32:55,300 - tools.data_fetcher - INFO - url: https://data.sfgov.org/resource/g8m3-pdis.json
2025-05-12 14:32:55,300 - tools.data_fetcher - INFO - API result status: success
2025-05-12 14:32:55,301 - tools.data_fetcher - INFO - Dataset successfully created with shape: (69, 4)
2025-05-12 14:32:57,392 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:01,839 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:01,856 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:33:01,856 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:33:01,856 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:33:01,856 - monthly_report - INFO - Response has messages attribute with 8 messages
2025-05-12 14:33:01,856 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:33:01,856 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: In April 2025, business closures in District 6 dropped significantly from 44 to 25, ref...
2025-05-12 14:33:01,856 - monthly_report - INFO - Final explanation to be stored for 🚫 Business Closures (length: 823): EXPLANATION: In April 2025, business closures in District 6 dropped significantly from 44 to 25, reflecting a 43.18% decrease compared to March. The district saw a 71% reduction in closures compared t...
2025-05-12 14:33:01,857 - monthly_report - INFO - Updated explanation for report ID 262
2025-05-12 14:33:01,857 - monthly_report - INFO - Comparing data between March 2025 and April 2025
2025-05-12 14:33:01,857 - monthly_report - INFO - Generating explanation for report_id=263, metric=💊 Drug Crime Incidents (ID: 4), group=All
2025-05-12 14:33:01,857 - monthly_report - INFO -   Values: recent=183.0, comparison=197.0, diff=-14.0, percent_change=-7.1065989847715745
2025-05-12 14:33:01,857 - monthly_report - INFO -   Period: month, District: 6
2025-05-12 14:33:01,857 - monthly_report - INFO - Prompt for explainer agent: Please explain why the metric '💊 Drug Crime Incidents' (ID: 4)  decreased from 197.0 to 183.0 (7.11%) between March 2025 and April 2025 for district 6.

Use the available tools to research this change...
2025-05-12 14:33:01,857 - monthly_report - INFO - Running explainer agent for metric: 4
2025-05-12 14:33:02,616 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:02,618 - webChat - INFO - 
=== get_notes called ===
Total length: 15869 characters
Approximate tokens: 2639
First 100 chars: ================================================================================
Citywide Metrics Su
Number of lines: 291

2025-05-12 14:33:04,030 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:04,031 - webChat - INFO - 
=== query_anomalies_db called ===
Parameters:
- query_type: by_metric_id
- limit: 30
- group_filter: None
- date_start: None
- date_end: None
- only_anomalies: True
- metric_name: None
- district_filter: 6
- metric_id: 4
- period_type: month

2025-05-12 14:33:04,031 - webChat - INFO - Using database connection: localhost:5432/transparentsf (user: postgres)
2025-05-12 14:33:04,031 - webChat - INFO - Using query_type 'by_metric_id' with metric_id=4
2025-05-12 14:33:04,031 - webChat - INFO - Calling get_anomalies with query_type=by_metric_id, limit=30
2025-05-12 14:33:04,031 - webChat - INFO - Additional filters: group_filter=None, date_start=None, date_end=None, only_anomalies=True, metric_name=None, district_filter=6, metric_id=4, period_type=month
2025-05-12 14:33:04,036 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:33:04,041 - webChat - INFO - get_anomalies query completed in 0.01 seconds
2025-05-12 14:33:04,041 - webChat - INFO - get_anomalies returned 3 results
2025-05-12 14:33:04,042 - webChat - INFO - Processed 3 results in 0.00 seconds
2025-05-12 14:33:04,042 - webChat - INFO - Returning 3 results for query_type=by_metric_id
2025-05-12 14:33:04,042 - webChat - INFO - Looking for dashboard data in: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard
2025-05-12 14:33:04,042 - webChat - INFO - Fetching specific metric '4.json' for district 6 from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/4.json
2025-05-12 14:33:04,043 - webChat - INFO - Using metric_id as a number: 4
2025-05-12 14:33:04,043 - webChat - INFO - Looking for monthly analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/monthly/6/4.md
2025-05-12 14:33:04,043 - webChat - INFO - Looking for annual analysis at: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/annual/6/4.md
2025-05-12 14:33:04,044 - webChat - INFO - Found monthly analysis file (20001 chars)
2025-05-12 14:33:04,044 - webChat - INFO - Found annual analysis file (12898 chars)
2025-05-12 14:33:04,044 - webChat - INFO - Added analysis content with keys: ['monthly_analysis', 'annual_analysis']
2025-05-12 14:33:04,044 - webChat - INFO - Successfully retrieved dashboard metric data from /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/dashboard/6/4.json
2025-05-12 14:33:15,211 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:15,213 - monthly_report - INFO - Explainer agent response type: <class 'swarm.types.Response'>
2025-05-12 14:33:15,213 - monthly_report - INFO - Response attributes: ['messages', 'agent', 'context_variables']
2025-05-12 14:33:15,214 - monthly_report - ERROR - Error dumping response for logging: Object of type function is not JSON serializable
2025-05-12 14:33:15,214 - monthly_report - INFO - Response has messages attribute with 6 messages
2025-05-12 14:33:15,214 - monthly_report - INFO - Last message type: <class 'dict'>
2025-05-12 14:33:15,214 - monthly_report - INFO - Found explanation in last message dict content: EXPLANATION: The 7.11% decrease in drug crime incidents in District 6 from March to April 2025 is li...
2025-05-12 14:33:15,214 - monthly_report - INFO - Final explanation to be stored for 💊 Drug Crime Incidents (length: 1146): EXPLANATION: The 7.11% decrease in drug crime incidents in District 6 from March to April 2025 is linked to a mix of changes within specific drug-related offenses. While there was a broad decrease in ...
2025-05-12 14:33:15,215 - monthly_report - INFO - Updated explanation for report ID 263
2025-05-12 14:33:15,216 - monthly_report - INFO - Successfully generated explanations for 3 items
2025-05-12 14:33:15,216 - monthly_report - INFO - Step 4: Getting report items for Perplexity context enrichment
2025-05-12 14:33:15,221 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:33:15,225 - monthly_report - INFO - Step 5: Getting additional context from Perplexity API for each report item
2025-05-12 14:33:15,225 - monthly_report - INFO - Getting additional context from Perplexity API for 3 report items
2025-05-12 14:33:15,225 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚑 911 Response (minutes) - Danger to life - District 6
Group: All
Recent Value: 14.937836745756679
Previous Value: 11.476195578121924
Percent Change: +30.16%
Explanation: The 911 response time for danger to life in District 6 has increased significantly by 30.2%, which is concerning for public safety. This change is noteworthy as it deviates from the stable response times citywide and could indicate resource allocation issues or increased demand in this district.
Detailed Analysis: EXPLANATION: The significant increase in the '🚑 911 Response (minutes) - Danger to life - District 6' metric from March 2025 to April 2025 can be primarily attributed to a dramatic rise in average response times for incidents classified under the "disposition" group "SFD" (San Francisco Fire Department related calls). There was an anomaly with an increase of 985% in the mean response time for "SFD" dispositions, from an average of approximately 8.4 minutes to an extraordinary 91.4 minutes during April 2025. This anomaly heavily contributed to the overall increase in the response time metric, as it represented a large outlier when compared to historical data. Other disposition types, such as "GOA" (Gone on Arrival) experienced a decrease in response times, but the magnitude was not sufficient to offset the spike caused by "SFD" calls. The localized trend in District 6 indicates that the anomaly mainly affected areas specifically served by or requiring responses for "SFD" calls. The chart for the SFD anomaly can be viewed here: [CHART:anomaly:281619]. This understanding highlights the impact of operational or logistical challenges faced by emergency response services dealing specifically with fire-related emergencies within that period.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:33:15,225 - monthly_report - INFO - Sending request to Perplexity API for 🚑 911 Response (minutes) - Danger to life - District 6
2025-05-12 14:33:19,716 - monthly_report - INFO - Successfully received response from Perplexity API for 🚑 911 Response (minutes) - Danger to life - District 6
2025-05-12 14:33:19,716 - monthly_report - INFO - Raw Perplexity response: {"id": "bb6e8ea0-1996-45a5-b492-47b94fc44e4c", "model": "sonar", "created": 1747085599, "usage": {"prompt_tokens": 542, "completion_tokens": 173, "total_tokens": 715, "search_context_size": "low"}, "citations": ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-according-to-state-data/3834395/", "https://www.sf.gov/data--response-times-911-calls", "https://www.sfchronicle.com/bayarea/article/sf-911-response-18550441.php", "https://growsf.org/news/2025-04-08-mission-16th-police", "https://www.sf.gov/data--911-call-volume-and-response"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nRecent news highlights San Francisco's 911 response times, particularly in areas like District 6, are concerning due to significant delays. The Department of Emergency Management reported a slowdown in response times, contributing to broader delays in emergency situations, such as p...
2025-05-12 14:33:19,716 - monthly_report - INFO - Found top-level citations: ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-according-to-state-data/3834395/", "https://www.sf.gov/data--response-times-911-calls", "https://www.sfchronicle.com/bayarea/article/sf-911-response-18550441.php", "https://growsf.org/news/2025-04-08-mission-16th-police", "https://www.sf.gov/data--911-call-volume-and-response"]
2025-05-12 14:33:19,716 - monthly_report - INFO - Added Perplexity response data to 🚑 911 Response (minutes) - Danger to life - District 6: {"citations": ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-according-to-state-data/3834395/", "https://www.sf.gov/data--response-times-911-calls", "https://www.sfchronicle.com/bayarea/article/sf-911-response-18550441.php", "https://growsf.org/news/2025-04-08-mission-16th-police", "https://www.sf.gov/data--911-call-volume-and-response"]}
2025-05-12 14:33:19,716 - monthly_report - INFO - Added Perplexity context to 🚑 911 Response (minutes) - Danger to life - District 6 (length: 976)
2025-05-12 14:33:19,716 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 🚫 Business Closures
Group: All
Recent Value: 25.0
Previous Value: 44.0
Percent Change: -43.18%
Explanation: Business closures have decreased by 43.2% in District 6, which is a significant positive development. This aligns with the broader trend of reduced closures citywide, suggesting economic recovery or stabilization in the area.
Detailed Analysis: EXPLANATION: In April 2025, business closures in District 6 dropped significantly from 44 to 25, reflecting a 43.18% decrease compared to March. The district saw a 71% reduction in closures compared to the 24-month average of 87. This notable decline is attributed to a reduction in closures across various sectors. Notably, Professional, Scientific, and Technical Services saw only 5 closures, 69% below the average, while Food Services and Retail Trade each accounted for 4 closures, below their respective averages. From the data, closures included businesses like "Flower Power SF" and "New Century Gem & Lapidary" in Retail Trade, and "Cool!Naria" in Food Services. The decline in closures reflects a positive trend across key business sectors, indicating improved business sustainability in District 6 for April 2025.


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:33:19,716 - monthly_report - INFO - Sending request to Perplexity API for 🚫 Business Closures
2025-05-12 14:33:23,482 - monthly_report - INFO - Successfully received response from Perplexity API for 🚫 Business Closures
2025-05-12 14:33:23,482 - monthly_report - INFO - Raw Perplexity response: {"id": "f9262a4b-997b-4163-96e7-47237ccba082", "model": "sonar", "created": 1747085603, "usage": {"prompt_tokens": 427, "completion_tokens": 166, "total_tokens": 593, "search_context_size": "low"}, "citations": ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\n\nIn recent months, San Francisco has seen a decrease in business closures, with a notable 43.18% drop in District 6. This trend is part of a broader economic stabilization in the city. However, challenges ...
2025-05-12 14:33:23,483 - monthly_report - INFO - Found top-level citations: ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"]
2025-05-12 14:33:23,483 - monthly_report - INFO - Added Perplexity response data to 🚫 Business Closures: {"citations": ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"]}
2025-05-12 14:33:23,483 - monthly_report - INFO - Added Perplexity context to 🚫 Business Closures (length: 923)
2025-05-12 14:33:23,483 - monthly_report - INFO - Prompt for Perplexity API:
System: You are a an information retrieval expert and analyst.
User: I have a monthly newsletter about San Francisco metrics and trends. Please provide additional context, recent news and especially direct quotes from elected officials about the topics in the newsletter if any. It's a timely newsletter so disregard anything written more than 2 months ago. 

I the extract focussed on housing, then provide relevant context on how many affordable units are available, who the developers are, and any news about occupancy details or timing. 

NEWSLETTER EXTRACT:

Metric: 💊 Drug Crime Incidents
Group: All
Recent Value: 183.0
Previous Value: 197.0
Percent Change: -7.11%
Explanation: Drug crime incidents have decreased by 7.1% in District 6, which is notable given the year-to-date increase of 44.7% citywide. This counter-trend in District 6 could indicate effective local interventions or changes in enforcement strategies.
Detailed Analysis: EXPLANATION: The 7.11% decrease in drug crime incidents in District 6 from March to April 2025 is linked to a mix of changes within specific drug-related offenses. While there was a broad decrease in incidents, April still saw notable increases in several specific types of drug crime activities, but these increases were insufficient to counterbalance the overall drop. The most significant anomaly was a spike in Opiates Offense incidents, which increased by over 205% compared to the previous period, as well as a notable rise in Controlled Substance, Under the Influence of offenses by 169%. Furthermore, incidents involving Controlled Substance offenses rose by nearly 185%. These increases occurred within a broader context of overall drug crime incidents fluctuating over recent months without a consistent trend. These fluctuations highlight variance across specific drug types and offenses rather than a clear, sustained decline. Thus, while monthly totals show a decrease, the underlying dynamics of drug crime activity remain complex and vary by type of incident. [CHART:anomaly:271797], [CHART:anomaly:271798], [CHART:anomaly:271800].


Please provide your results in 2 sections: 
1. Recent news related to this topic, and especially 
2. Direct quotes from elected officials.  

Each section should be a few sentences max. Keep your answer to at most 500 tokens and provide only what people will really care about. 
2025-05-12 14:33:23,483 - monthly_report - INFO - Sending request to Perplexity API for 💊 Drug Crime Incidents
2025-05-12 14:33:27,597 - monthly_report - INFO - Successfully received response from Perplexity API for 💊 Drug Crime Incidents
2025-05-12 14:33:27,598 - monthly_report - INFO - Raw Perplexity response: {"id": "524e7b42-9fe0-4d1d-9a27-35cd15a03fb1", "model": "sonar", "created": 1747085607, "usage": {"prompt_tokens": 487, "completion_tokens": 230, "total_tokens": 717, "search_context_size": "low"}, "citations": ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"], "object": "chat.completion", "choices": [{"index": 0, "finish_reason": "stop", "message": {"role": "assistant", "content": "## Recent News\nRecent data from San Francisco shows a notable increase in arrests for drug users compared to dealers, with a focus on narcotics paraphernalia possession and loitering. In the first four months of 2025, the Mission District experience...
2025-05-12 14:33:27,598 - monthly_report - INFO - Found top-level citations: ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"]
2025-05-12 14:33:27,598 - monthly_report - INFO - Added Perplexity response data to 💊 Drug Crime Incidents: {"citations": ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"]}
2025-05-12 14:33:27,598 - monthly_report - INFO - Added Perplexity context to 💊 Drug Crime Incidents (length: 1190)
2025-05-12 14:33:27,598 - monthly_report - INFO - Successfully retrieved additional context from Perplexity API for all items
2025-05-12 14:33:27,599 - monthly_report - INFO - Step 5.5: Updating database with Perplexity context
2025-05-12 14:33:27,604 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:33:27,605 - monthly_report - INFO - Updating perplexity_context for 🚑 911 Response (minutes) - Danger to life - District 6 - All (length: 976)
2025-05-12 14:33:27,608 - monthly_report - INFO - Updated 1 records for perplexity_context (🚑 911 Response (minutes) - Danger to life - District 6 - All)
2025-05-12 14:33:27,608 - monthly_report - INFO - Updating perplexity_response for 🚑 911 Response (minutes) - Danger to life - District 6 - All: {"citations": ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-ac...
2025-05-12 14:33:27,608 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-ac...
2025-05-12 14:33:27,610 - monthly_report - INFO - Updated 1 records for perplexity_response (🚑 911 Response (minutes) - Danger to life - District 6 - All)
2025-05-12 14:33:27,611 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚑 911 Response (minutes) - Danger to life - District 6: {"citations": ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-ac...
2025-05-12 14:33:27,611 - monthly_report - INFO - Updating perplexity_context for 🚫 Business Closures - All (length: 923)
2025-05-12 14:33:27,612 - monthly_report - INFO - Updated 1 records for perplexity_context (🚫 Business Closures - All)
2025-05-12 14:33:27,612 - monthly_report - INFO - Updating perplexity_response for 🚫 Business Closures - All: {"citations": ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https...
2025-05-12 14:33:27,612 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https...
2025-05-12 14:33:27,613 - monthly_report - INFO - Updated 1 records for perplexity_response (🚫 Business Closures - All)
2025-05-12 14:33:27,613 - monthly_report - INFO - Verification successful! perplexity_response was stored for 🚫 Business Closures: {"citations": ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https...
2025-05-12 14:33:27,613 - monthly_report - INFO - Updating perplexity_context for 💊 Drug Crime Incidents - All (length: 1190)
2025-05-12 14:33:27,614 - monthly_report - INFO - Updated 1 records for perplexity_context (💊 Drug Crime Incidents - All)
2025-05-12 14:33:27,614 - monthly_report - INFO - Updating perplexity_response for 💊 Drug Crime Incidents - All: {"citations": ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-2...
2025-05-12 14:33:27,614 - monthly_report - INFO - Serialized perplexity_response JSON: {"citations": ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-2...
2025-05-12 14:33:27,614 - monthly_report - INFO - Updated 1 records for perplexity_response (💊 Drug Crime Incidents - All)
2025-05-12 14:33:27,615 - monthly_report - INFO - Verification successful! perplexity_response was stored for 💊 Drug Crime Incidents: {"citations": ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-2...
2025-05-12 14:33:27,615 - monthly_report - INFO - Verification counts: 3 records with perplexity_context, 3 with perplexity_response
2025-05-12 14:33:27,616 - monthly_report - INFO - Updated 3 items with Perplexity context
2025-05-12 14:33:27,616 - monthly_report - INFO - Step 6: Generating monthly newsletter
2025-05-12 14:33:27,616 - monthly_report - INFO - Generating monthly report for district 6
2025-05-12 14:33:27,622 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:33:27,626 - monthly_report - INFO - Found 3 report items for date 2025-05-12 and district 6
2025-05-12 14:33:27,626 - monthly_report - INFO - Raw perplexity_citations for 🚑 911 Response (minutes) - Danger to life - District 6: ["https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-according-to-state-data/3834395/", "https://www.sf.gov/data--response-times-911-calls", "https://www.sfchronicle.com/bayarea/article/sf-911-response-18550441.php", "https://growsf.org/news/2025-04-08-mission-16th-pol...
2025-05-12 14:33:27,626 - monthly_report - INFO - Formatted 5 citations for 🚑 911 Response (minutes) - Danger to life - District 6
2025-05-12 14:33:27,626 - monthly_report - INFO - Citation map: {"1": "https://www.nbcbayarea.com/investigations/oaklands-911-answer-times-are-improving-according-to-state-data/3834395/", "2": "https://www.sf.gov/data--response-times-911-calls", "3": "https://www.sfchronicle.com/bayarea/article/sf-911-response-18550441.php", "4": "https://growsf.org/news/2025-04-08-mission-16th-police", "5": "https://www.sf.gov/data--911-call-volume-and-response"}
2025-05-12 14:33:27,626 - monthly_report - INFO - Found citation references in context: ['3']
2025-05-12 14:33:27,626 - monthly_report - INFO - Raw perplexity_citations for 🚫 Business Closures: ["https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "https://downtownsf.org/post/new...
2025-05-12 14:33:27,626 - monthly_report - INFO - Formatted 5 citations for 🚫 Business Closures
2025-05-12 14:33:27,627 - monthly_report - INFO - Citation map: {"1": "https://www.cbre.com/insights/figures/san-francisco-office-snapshot-q1-2025", "2": "https://data.sfgov.org/Economy-and-Community/Registered-Businesses-sorted-by-End-Date/vupz-6rcv", "3": "https://media.api.sf.gov/documents/Status_of_the_San_Francisco_Economy_March_2025.pdf", "4": "https://downtownsf.org/post/new-business-openings-signal-downtown-sfs-momentum-in-2025", "5": "https://www.sfchronicle.com/sf/article/downtown-mall-stores-closing-20255407.php"}
2025-05-12 14:33:27,627 - monthly_report - INFO - Found citation references in context: ['4', '5']
2025-05-12 14:33:27,627 - monthly_report - INFO - Raw perplexity_citations for 💊 Drug Crime Incidents: ["https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "https://growsf.org/news/2025-04-10-crime-is-down/", "https://www.sanfranciscopolice.org/stay-safe/crime...
2025-05-12 14:33:27,627 - monthly_report - INFO - Formatted 5 citations for 💊 Drug Crime Incidents
2025-05-12 14:33:27,627 - monthly_report - INFO - Citation map: {"1": "https://www.sfchronicle.com/crime/article/sf-drug-arrest-data-dealers-users-police-20217830.php", "2": "https://sfstandard.com/2025/05/12/mission-district-crime-remains-low-public-drug-use-spikes/", "3": "https://growsf.org/news/2025-04-10-crime-is-down/", "4": "https://www.sanfranciscopolice.org/stay-safe/crime-data/crime-dashboard", "5": "https://sfstandard.com/2025/04/03/sfpd-loitering-intent-drugs-mass-arrests-no-charges/"}
2025-05-12 14:33:27,627 - monthly_report - INFO - Found citation references in context: ['1', '2', '5']
2025-05-12 14:33:27,627 - monthly_report - INFO - Making API call to generate report content
2025-05-12 14:33:36,328 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:33:36,335 - monthly_report - INFO - Received report content (length: 5018)
2025-05-12 14:33:36,336 - monthly_report - INFO - Monthly newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05.html
2025-05-12 14:33:36,336 - monthly_report - INFO - Step 7: Expanding chart references in the newsletter
2025-05-12 14:33:36,336 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05.html
2025-05-12 14:33:36,337 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05.html
2025-05-12 14:33:36,337 - monthly_report - INFO - Step 8: Proofreading and revising newsletter
2025-05-12 14:33:36,337 - monthly_report - INFO - Proofreading and revising newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05.html
2025-05-12 14:33:36,337 - monthly_report - INFO - Using AGENT_MODEL for proofreading
2025-05-12 14:34:15,425 - httpx - INFO - HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"
2025-05-12 14:34:15,428 - monthly_report - INFO - Expanding chart references in revised report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,428 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,429 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,434 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:15,442 - monthly_report - INFO - Updated report ID 127 with revised filename, proofread feedback, and headlines.
2025-05-12 14:34:15,442 - monthly_report - INFO - Revised newsletter saved to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,442 - monthly_report - INFO - Step 9: Generating email-compatible version of newsletter
2025-05-12 14:34:15,442 - monthly_report - INFO - Generating email-compatible version of report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,443 - monthly_report - INFO - Expanding chart references in report for email compatibility: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,443 - monthly_report - INFO - Expanding chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,443 - monthly_report - INFO - Expanded chart references in report: /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised.html
2025-05-12 14:34:15,444 - monthly_report - INFO - Found 5 potential iframe URLs to process.
2025-05-12 14:34:15,444 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271798#chart-section'
2025-05-12 14:34:15,444 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271798#chart-section'
2025-05-12 14:34:15,444 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271798#chart-section'
2025-05-12 14:34:15,444 - monthly_report - INFO - Requesting anomaly image for id=271798
2025-05-12 14:34:15,444 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271798'}
2025-05-12 14:34:15,470 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271798#chart-section
2025-05-12 14:34:17,728 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271798
2025-05-12 14:34:17,732 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:20,508 - monthly_report - INFO - Successfully captured chart image with distinctive frame to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271798_1747085655.png
2025-05-12 14:34:20,531 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=271798#chart-section) with image: anomaly_271798_1747085655.png (1 occurrence(s))
2025-05-12 14:34:20,531 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271800#chart-section'
2025-05-12 14:34:20,531 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271800#chart-section'
2025-05-12 14:34:20,531 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271800#chart-section'
2025-05-12 14:34:20,531 - monthly_report - INFO - Requesting anomaly image for id=271800
2025-05-12 14:34:20,531 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271800'}
2025-05-12 14:34:20,531 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271800#chart-section
2025-05-12 14:34:21,338 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271800
2025-05-12 14:34:21,341 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:24,127 - monthly_report - INFO - Successfully captured chart image with distinctive frame to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271800_1747085660.png
2025-05-12 14:34:24,149 - monthly_report - INFO - Replaced anomaly chart iframe (src: /anomaly-analyzer/anomaly-chart?id=271800#chart-section) with image: anomaly_271800_1747085660.png (1 occurrence(s))
2025-05-12 14:34:24,149 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=281619#chart-section'
2025-05-12 14:34:24,149 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=281619#chart-section'
2025-05-12 14:34:24,149 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=281619#chart-section'
2025-05-12 14:34:24,149 - monthly_report - INFO - Requesting anomaly image for id=281619
2025-05-12 14:34:24,149 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '281619'}
2025-05-12 14:34:24,149 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=281619#chart-section
2025-05-12 14:34:24,944 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 281619
2025-05-12 14:34:24,947 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:27,763 - monthly_report - INFO - Successfully captured chart image with distinctive frame to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_281619_1747085664.png
2025-05-12 14:34:27,784 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=281619#chart-section
2025-05-12 14:34:27,784 - monthly_report - INFO - Processing iframe URL (original captured): '/backend/time-series-chart?metric_id=15&district=6&period_type=month#chart-section'
2025-05-12 14:34:27,784 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/backend/time-series-chart?metric_id=15&district=6&period_type=month#chart-section'
2025-05-12 14:34:27,784 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/backend/time-series-chart?metric_id=15&district=6&period_type=month#chart-section'
2025-05-12 14:34:27,784 - monthly_report - INFO - Requesting time-series image for metric=15, district=6, period=month
2025-05-12 14:34:27,784 - monthly_report - INFO - Requesting time_series chart image with params: {'metric_id': '15', 'district': '6', 'period_type': 'month'}
2025-05-12 14:34:27,784 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/backend/time-series-chart?metric_id=15&district=6&period_type=month#chart-section
2025-05-12 14:34:28,605 - backend - INFO - Looking for chart with object_id=15, district=6, period_type=month, group_field=None, groups=None
2025-05-12 14:34:28,612 - backend - INFO - Available metrics in database: ['1', '9', '4', '8', '12', '10', '7', '17', '13', '15', '5', '14', '6', '3', '11', '2', '16']
2025-05-12 14:34:28,613 - backend - INFO - Available period types in database: ['year', 'month']
2025-05-12 14:34:28,614 - backend - INFO - Found 246 entries with object_id=15
2025-05-12 14:34:28,616 - backend - INFO - Found 25 data points for chart_id 4686
2025-05-12 14:34:28,616 - backend - INFO - Retrieved chart data for object_id: 15, district: 6, period_type: month, group_field: None
2025-05-12 14:34:31,396 - monthly_report - INFO - Successfully captured chart image with distinctive frame to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/time_series_15_6_month_1747085667.png
2025-05-12 14:34:31,418 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /backend/time-series-chart?metric_id=15&district=6&period_type=month#chart-section
2025-05-12 14:34:31,418 - monthly_report - INFO - Processing iframe URL (original captured): '/anomaly-analyzer/anomaly-chart?id=271797#chart-section'
2025-05-12 14:34:31,418 - monthly_report - INFO - Processing iframe URL (stripped for matching): '/anomaly-analyzer/anomaly-chart?id=271797#chart-section'
2025-05-12 14:34:31,418 - monthly_report - INFO - Processing iframe URL (unescaped for params): '/anomaly-analyzer/anomaly-chart?id=271797#chart-section'
2025-05-12 14:34:31,418 - monthly_report - INFO - Requesting anomaly image for id=271797
2025-05-12 14:34:31,418 - monthly_report - INFO - Requesting anomaly chart image with params: {'id': '271797'}
2025-05-12 14:34:31,418 - monthly_report - INFO - Capturing chart from URL: http://localhost:8000/anomaly-analyzer/anomaly-chart?id=271797#chart-section
2025-05-12 14:34:32,197 - anomalyAnalyzer - INFO - Fetching detailed anomaly data for ID: 271797
2025-05-12 14:34:32,201 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:35,002 - monthly_report - INFO - Successfully captured chart image with distinctive frame to /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/charts/anomaly_271797_1747085671.png
2025-05-12 14:34:35,024 - monthly_report - WARNING - Could not find exact iframe tag to replace for src: /anomaly-analyzer/anomaly-chart?id=271797#chart-section
2025-05-12 14:34:35,024 - monthly_report - INFO - Total iframe replacements made: 2
2025-05-12 14:34:35,024 - monthly_report - INFO - Generated email-compatible report at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised_email.html
2025-05-12 14:34:35,024 - monthly_report - INFO - Generated email-compatible newsletter at /Users/simongoldman/Documents/TransparentSF_from_git/transparentSF/ai/output/reports/monthly_report_6_2025_05_revised_email.html
2025-05-12 14:34:35,025 - monthly_report - INFO - Updated top_level.json for district 6 with revised report filename
2025-05-12 14:34:35,025 - monthly_report - INFO - Monthly newsletter process completed successfully
2025-05-12 14:34:35,025 - backend - INFO - Monthly report generated successfully: monthly_report_6_2025_05.html
2025-05-12 14:34:35,030 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:34:35,034 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:39,492 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:34:39,497 - root - INFO - Successfully connected to PostgreSQL database
2025-05-12 14:34:39,504 - backend - INFO - Requesting monthly report by ID: 127
2025-05-12 14:34:43,075 - backend - INFO - Newsletter published successfully. URL: https://newsletter.transparentsf.com/p/a46b4c74-8060-463a-b2dc-ae66f9a19cb7/
2025-05-12 14:34:43,082 - backend - INFO - Updated report ID 127 with published URL: https://newsletter.transparentsf.com/p/a46b4c74-8060-463a-b2dc-ae66f9a19cb7/
2025-05-12 14:34:43,112 - backend - INFO - Requesting monthly report by ID: 127
2025-05-12 14:36:40,521 - monthly_report - INFO - Getting list of monthly newsletters from database
2025-05-12 14:36:40,525 - root - INFO - Successfully connected to PostgreSQL database
